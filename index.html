<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Reverie">
<meta name="theme-color" content="#f5f6f8">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<title>Reverie</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
:root{--bg:#f5f6f8;--bg2:#fff;--bg3:#f9fafb;--bgi:#eef0f3;--ac:#7c9eb2;--acl:#e4eef3;--ach:#5d8299;--tx:#2d3436;--tx2:#8395a7;--tx3:#1a1a1a;--bd:#e2e6ea;--bd2:#d1d8de;--sh:rgba(0,0,0,.03);--msg-ai:#fff;--msg-user:#e4eef3;--navh:52px;}
body.theme-warm{--bg:#f7f5f2;--bg2:#fff;--bg3:#faf9f7;--bgi:#f0ede8;--ac:#c0705a;--acl:#f0ddd6;--ach:#a85d4a;--tx:#3d3a36;--tx2:#8a857d;--tx3:#1a1816;--bd:#e5e0da;--bd2:#d5cfc7;--msg-ai:#fff;--msg-user:#f0ddd6;}
body.theme-sage{--bg:#f2f5f3;--bg2:#fff;--bg3:#f6f9f7;--bgi:#e8ede9;--ac:#6b9080;--acl:#dce8e2;--ach:#4e7566;--tx:#2d3632;--tx2:#7d8e85;--tx3:#1a1e1b;--bd:#dae2dd;--bd2:#c8d4cc;--msg-ai:#fff;--msg-user:#dce8e2;}
body.theme-lavender{--bg:#f4f3f8;--bg2:#fff;--bg3:#f8f7fb;--bgi:#eae8f0;--ac:#8b7fb5;--acl:#e2dff0;--ach:#6e63a0;--tx:#2d2b36;--tx2:#8985a0;--tx3:#1a1820;--bd:#dedbe6;--bd2:#ccc8d8;--msg-ai:#fff;--msg-user:#e2dff0;}
body.theme-rose{--bg:#f8f4f5;--bg2:#fff;--bg3:#fbf8f9;--bgi:#f0e8ea;--ac:#b5707e;--acl:#f0dde2;--ach:#9a5565;--tx:#362d30;--tx2:#a08589;--tx3:#201a1c;--bd:#e6dbde;--bd2:#d8c8cd;--msg-ai:#fff;--msg-user:#f0dde2;}
body.theme-ocean{--bg:#f0f4f7;--bg2:#fff;--bg3:#f5f8fa;--bgi:#e2eaf0;--ac:#5088a8;--acl:#d4e4f0;--ach:#3a6d8a;--tx:#2a3238;--tx2:#7b8e9a;--tx3:#161d22;--bd:#d6e0e8;--bd2:#c0ced8;--msg-ai:#fff;--msg-user:#d4e4f0;}
body.theme-dark{--bg:#1a1a2e;--bg2:#252548;--bg3:#20203c;--bgi:#30305a;--ac:#9ab8cc;--acl:rgba(154,184,204,.18);--ach:#b0d0e4;--tx:#eceff2;--tx2:#b4bcc8;--tx3:#f8f8fa;--bd:#3c3c68;--bd2:#505080;--sh:rgba(0,0,0,.2);--msg-ai:#2c2c50;--msg-user:rgba(154,184,204,.22);}
body.theme-dark-warm{--bg:#1e1a18;--bg2:#2e2824;--bg3:#282220;--bgi:#3a322e;--ac:#d4886e;--acl:rgba(212,136,110,.18);--ach:#e8a088;--tx:#ece4dc;--tx2:#c0b4a8;--tx3:#faf4ec;--bd:#4a423c;--bd2:#5e5650;--sh:rgba(0,0,0,.2);--msg-ai:#342e2a;--msg-user:rgba(212,136,110,.22);}
body.theme-dark-green{--bg:#141c18;--bg2:#1e2c24;--bg3:#1a2620;--bgi:#2a3c32;--ac:#8cb8a4;--acl:rgba(140,184,164,.18);--ach:#a4d0b8;--tx:#eaf2ee;--tx2:#b0c4b8;--tx3:#f4faf6;--bd:#384e44;--bd2:#4a6458;--sh:rgba(0,0,0,.2);--msg-ai:#283830;--msg-user:rgba(140,184,164,.22);}
body.theme-midnight{--bg:#0e1018;--bg2:#1a1d28;--bg3:#161922;--bgi:#262a3e;--ac:#b0a4d8;--acl:rgba(176,164,216,.18);--ach:#c8bce8;--tx:#e2e0f0;--tx2:#b0aec8;--tx3:#f4f2fa;--bd:#343850;--bd2:#484c68;--sh:rgba(0,0,0,.3);--msg-ai:#222538;--msg-user:rgba(176,164,216,.22);}
body.theme-black{--bg:#000000;--bg2:#0a0a0a;--bg3:#050505;--bgi:#1a1a1a;--ac:#888888;--acl:rgba(136,136,136,.15);--ach:#aaaaaa;--tx:#e0e0e0;--tx2:#999999;--tx3:#ffffff;--bd:#222222;--bd2:#333333;--sh:rgba(0,0,0,.5);--msg-ai:#0d0d0d;--msg-user:rgba(136,136,136,.15);}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--tx);height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;font-size:15px;}
::placeholder{color:var(--tx2);opacity:1;}
::-webkit-input-placeholder{color:var(--tx2);opacity:1;}
textarea,input{-webkit-user-select:text;user-select:text;}.msg-bubble{-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;}
.nav-w{position:fixed;bottom:0;left:0;right:0;z-index:200;background:var(--bg2);border-top:1px solid var(--bd);box-shadow:0 -1px 4px var(--sh);padding-bottom:env(safe-area-inset-bottom,0);transition:transform .2s;}.nav-w.hide{transform:translateY(100%);}
.nav-i{display:flex;height:var(--navh);}
.nv{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:var(--tx2);cursor:pointer;border-top:2px solid transparent;user-select:none;gap:2px;}.nv.a{color:var(--ac);border-top-color:var(--ac);font-weight:500;}
.nv svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.main{flex:1;min-height:0;overflow:hidden;padding-bottom:calc(var(--navh) + env(safe-area-inset-bottom,0));}.main.np{padding-bottom:0;}
.scr{flex:1;min-height:0;overflow-y:auto;padding:0 16px 80px;scrollbar-width:none;-ms-overflow-style:none;}.scr::-webkit-scrollbar{display:none;}
*{scrollbar-width:none;-ms-overflow-style:none;}*::-webkit-scrollbar{display:none;}
.pnl{display:none;height:100%;min-height:0;}.pnl.a{display:flex;flex-direction:column;}
.card{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:10px;box-shadow:0 1px 2px var(--sh);}
.ct{font-size:15px;font-weight:500;color:var(--tx3);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
textarea,input[type="text"],input[type="number"],input[type="password"],select{width:100%;background:var(--bg3);border:1px solid var(--bd);border-radius:8px;color:var(--tx);font-family:inherit;font-size:15px;padding:10px 12px;resize:vertical;}
textarea:focus,input:focus,select:focus{outline:none;border-color:var(--ac);background:var(--bg2);}
label{display:block;font-size:13px;color:var(--tx2);margin-bottom:4px;font-weight:400;}
.f{margin-bottom:12px;}.fr{display:flex;gap:10px;}.fr .f{flex:1;}
.ctr{text-align:right;font-size:12px;color:var(--tx2);margin-top:3px;}
.btn{padding:10px 18px;border-radius:10px;border:none;background:var(--bg3);color:var(--tx);font-size:14px;cursor:pointer;font-family:inherit;font-weight:500;transition:all .15s;}.btn:hover{opacity:.85;}.btn:active{transform:scale(.97);}
.bp{background:var(--ac);color:#fff;}.bp:hover{background:var(--ach);}
.bdel{background:none;color:#c0705a;border:1px solid rgba(192,112,90,.3);}.bdel:hover{background:rgba(192,112,90,.08);}
.bs2{font-size:13px;padding:7px 14px;}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding:16px 0 10px;position:sticky;top:0;z-index:10;background:var(--bg);}
.sht{font-size:24px;font-weight:700;color:var(--tx3);}
.bk{font-size:15px;color:var(--tx2);cursor:pointer;display:inline-flex;align-items:center;gap:4px;padding:6px 0;}.bk:hover{color:var(--ac);}
.li{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg2);border:1px solid var(--bd);border-radius:12px;cursor:pointer;margin-bottom:10px;box-shadow:0 1px 2px var(--sh);position:relative;flex-wrap:wrap;}
.li-chat{background:var(--bg);border:none;border-radius:0;margin-bottom:0;box-shadow:none;padding:12px 16px;margin-left:-16px;margin-right:-16px;}
.av{width:40px;height:40px;border-radius:50%;background:var(--bgi);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;color:var(--ac);font-weight:500;overflow:hidden;border:1px solid var(--bd);cursor:pointer;}.av img{width:100%;height:100%;object-fit:cover;}
.av-list{width:72px;height:72px;font-size:24px;}
.lb{flex:1;min-width:0;}.lt{font-size:16px;font-weight:500;color:var(--tx3);}.ls{font-size:14px;color:var(--tx2);margin-top:3px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.li-actions{display:flex;gap:8px;width:100%;margin-top:8px;}
.li-act{flex:1;padding:10px 0;border-radius:8px;border:1px solid var(--bd);background:var(--bg2);font-size:14px;color:var(--tx2);cursor:pointer;font-family:inherit;text-align:center;display:flex;align-items:center;justify-content:center;gap:5px;}.li-act:hover{border-color:var(--ac);color:var(--ac);}
.li-act svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
.sr{display:flex;align-items:center;gap:10px;}.sr input[type="range"]{flex:1;accent-color:var(--ac);}.svl{width:40px;text-align:right;font-size:15px;color:var(--ac);font-weight:500;}
.stt{font-size:16px;font-weight:600;color:var(--tx3);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--bd);}
.pl{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.pi{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--bg2);border:1px solid var(--bd);border-radius:8px;cursor:pointer;box-shadow:0 1px 2px var(--sh);}.pi:hover{border-color:var(--ac);}.pi.sel{border-color:var(--ac);background:var(--acl);}
.pn2{font-size:14px;color:var(--tx3);flex:1;}.ptk{font-size:12px;color:var(--tx2);}
.snv{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.sbb{padding:8px 16px;border-radius:20px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx2);font-size:14px;cursor:pointer;font-family:inherit;}.sbb:hover{border-color:var(--ac);color:var(--ac);}.sbb.a{background:var(--ac);border-color:var(--ac);color:#fff;}
.sp{display:none;}.sp.a{display:block;}
.cw{display:none;flex-direction:column;height:100%;}.cw.a{display:flex;}
.ch{padding:10px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:8px;background:var(--bg2);flex-shrink:0;}.chn{font-size:16px;font-weight:500;color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw;}
.cm{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:28px;background:var(--bg);}
.msg-row{display:flex;gap:12px;max-width:96%;align-items:flex-start;margin-left:4px;}.msg-row.ai{align-self:flex-start;}.msg-row.user{align-self:flex-end;flex-direction:row-reverse;margin-left:0;margin-right:4px;}
.msg-av{width:38px;height:38px;border-radius:50%;background:var(--bgi);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;color:var(--ac);font-weight:500;overflow:hidden;border:1px solid var(--bd);margin-top:-10px;}
.msg-body{flex:1;min-width:0;}.msg-name{font-size:13px;font-weight:500;color:var(--ac);margin-bottom:2px;}
.msg-content-row{display:flex;align-items:flex-end;gap:6px;}
.msg-row.user .msg-content-row{flex-direction:row-reverse;}
.msg-bubble{padding:10px 14px;border-radius:18px;font-size:15px;line-height:1.85;color:var(--tx);}
.msg-row.ai .msg-bubble{background:var(--msg-ai);border:1px solid var(--bd);box-shadow:0 1px 2px var(--sh);}
.msg-row.user .msg-bubble{background:var(--msg-user);border:1px solid rgba(0,0,0,.04);}
.msg-row.user .msg-body{padding-top:0;}
.mm{font-size:10px;color:var(--tx2);flex-shrink:0;white-space:nowrap;line-height:1;padding-bottom:2px;}
.msg-bubble p{margin:0 0 .6em;}.msg-bubble p:last-child{margin:0;}.msg-bubble em{font-style:italic;color:var(--tx2);}.msg-bubble strong{font-weight:600;}.msg-bubble blockquote{border-left:3px solid var(--ac);padding-left:10px;margin:.5em 0;color:var(--tx2);}
.msg-bubble ol,.msg-bubble ul{margin:0 0 .6em;padding-left:1.6em;}.msg-bubble li{margin-bottom:.3em;}
.ci{padding:10px 16px;display:flex;gap:10px;flex-shrink:0;background:var(--bg);align-items:flex-end;}
.ci-box{flex:1;display:flex;align-items:flex-end;background:var(--bg3);border:1px solid var(--bd);border-radius:22px;overflow:hidden;min-height:44px;}
.ci-box textarea{flex:1;max-height:200px;min-height:44px;overflow-y:auto;resize:none;padding:10px 6px 10px 16px;line-height:1.5;border:none;background:transparent;font-family:inherit;font-size:15px;color:var(--tx);}
.ci-box textarea:focus{outline:none;}
.ci-send{width:38px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;opacity:.5;transition:opacity .15s;}.ci-send:hover{opacity:1;}

.ham{width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--tx2);flex-shrink:0;border-radius:6px;}.ham:hover{color:var(--ac);background:var(--bgi);}
.ham svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.rp-sel{padding:8px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--bg2);font-size:14px;color:var(--tx);cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;white-space:nowrap;}.rp-sel:hover{border-color:var(--ac);color:var(--ac);}.rp-sel::after{content:'▾';font-size:10px;color:var(--tx2);}
.rp-sel-sm{padding:5px 10px;border-radius:6px;font-size:13px;}
.popup-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:400;align-items:center;justify-content:center;}.popup-ov.show{display:flex;}
.popup{background:var(--bg2);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:min(320px,90vw);max-height:70vh;overflow-y:auto;padding:20px;}
.popup-title{font-size:16px;font-weight:600;color:var(--tx3);margin-bottom:12px;}
.popup-item{padding:12px 14px;border:1px solid var(--bd);border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:space-between;gap:8px;}.popup-item:hover{border-color:var(--ac);}.popup-item.active{border-color:var(--ac);background:var(--acl);}
.popup-item .check{color:var(--ac);font-weight:600;display:none;}.popup-item.active .check{display:inline;}
.confirm-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:500;align-items:center;justify-content:center;}.confirm-ov.show{display:flex;}
.confirm-box{background:var(--bg2);border-radius:14px;width:min(320px,88vw);padding:22px;box-shadow:0 8px 24px rgba(0,0,0,.15);text-align:center;}
.confirm-msg{font-size:15px;color:var(--tx);margin-bottom:18px;line-height:1.6;}
.confirm-actions{display:flex;gap:8px;justify-content:center;}
.side-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:300;}.side-overlay.show{display:block;}
.sidebar{position:fixed;top:0;right:-300px;width:300px;height:100%;z-index:301;background:var(--bg2);box-shadow:-4px 0 12px rgba(0,0,0,.08);transition:right .25s ease;overflow-y:auto;padding:20px 16px;}.sidebar.show{right:0;}
.side-title{font-size:17px;font-weight:600;color:var(--tx3);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--bd);}
.side-item{padding:11px 12px;border:1px solid var(--bd);border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:15px;color:var(--tx);display:flex;align-items:center;gap:8px;}.side-item:hover{border-color:var(--ac);color:var(--ac);}.side-item.danger{color:#c0705a;}
.side-item svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.side-section{font-size:13px;color:var(--tx2);margin:14px 0 6px;text-transform:uppercase;letter-spacing:.5px;}
.side-profile-active{padding:11px 12px;border:1px solid var(--ac);border-radius:8px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;background:var(--acl);color:var(--tx3);}.side-profile-active:hover{opacity:.85;}.side-profile-active .switch-hint{font-size:12px;color:var(--ac);margin-left:auto;}
.fp{display:none;position:fixed;inset:0;z-index:260;background:var(--bg);flex-direction:column;}.fp.show{display:flex;}
.fp-head{padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px;background:var(--bg2);flex-shrink:0;}.fp-title{font-size:16px;font-weight:600;color:var(--tx3);flex:1;}
.fp-body{flex:1;overflow-y:auto;padding:16px;}.fp-body.full{padding:16px 0;display:flex;flex-direction:column;}.fp-body.full .f{padding:0 16px;}.fp-body.full .f:last-of-type{flex:1;display:flex;flex-direction:column;}.fp-body.full .f:last-of-type textarea{flex:1;min-height:120px;}
.drag-h{cursor:grab;color:var(--bd2);font-size:16px;padding:0 4px;user-select:none;touch-action:none;}.drag-h:active{cursor:grabbing;color:var(--ac);}
.dragging{opacity:.3;}.drag-ghost{border-radius:12px;background:var(--bg2);border:2px solid var(--ac);box-shadow:0 8px 24px rgba(0,0,0,.18);opacity:.92;pointer-events:none;z-index:9999;}
.theme-row{display:flex;gap:14px;margin-top:6px;flex-wrap:wrap;}.theme-dot{width:32px;height:32px;border-radius:50%;cursor:pointer;border:2px solid var(--bd);transition:all .15s;}.theme-dot:hover{transform:scale(1.1);}.theme-dot.active{border-color:var(--tx3);box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--tx3);}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--tx3);color:var(--bg);padding:10px 20px;border-radius:8px;font-size:14px;z-index:600;opacity:0;transition:opacity .3s;pointer-events:none;}.toast.show{opacity:1;}
.empty{text-align:center;padding:40px 20px;color:var(--tx2);font-size:15px;}
.hidden{display:none;}
.av-editor{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px;position:relative;width:180px;margin-left:auto;margin-right:auto;margin-top:8px;}
.av-ed-wrap{position:relative;width:144px;height:180px;border-radius:12px;overflow:hidden;border:2px solid var(--bd);background:var(--bgi);flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:56px;color:var(--ac);font-weight:500;}
#pf-av-wrap{width:160px;height:160px;border-radius:50%;}
.av-ed-wrap img{width:100%;height:100%;object-fit:cover;pointer-events:none;}
.crop-ov{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;}
.crop-ov.show{display:flex;}
.crop-area{position:relative;touch-action:none;overflow:hidden;background:#000;}
.crop-area img{position:absolute;user-select:none;-webkit-user-drag:none;}
.crop-frame{position:absolute;border:2px solid #fff;box-shadow:0 0 0 9999px rgba(0,0,0,.55);pointer-events:none;border-radius:4px;}
.crop-circle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:2px dashed rgba(255,255,255,.7);border-radius:50%;pointer-events:none;}
.crop-btns{display:flex;gap:12px;}
.crop-btns button{padding:10px 28px;border:none;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer;font-family:inherit;}
.crop-ok{background:var(--ac);color:#fff;}.crop-cancel{background:rgba(255,255,255,.15);color:#fff;}
.av-ed-badge{position:absolute;bottom:8px;right:8px;width:36px;height:36px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;border:2px solid var(--bg2);cursor:pointer;z-index:99;box-shadow:0 2px 6px rgba(0,0,0,.15);}.av-ed-badge svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
.pin-icon{width:22px;height:22px;color:var(--bd2);flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;}.pin-icon:hover{color:var(--ac);}
.pin-icon.pinned{color:var(--ac);}
.pin-icon svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.pin-icon.pinned svg{fill:var(--ac);}
.ctx-menu{position:fixed;z-index:500;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.12);padding:6px 0;min-width:150px;}
.ctx-item{padding:11px 16px;font-size:15px;cursor:pointer;color:var(--tx);display:flex;align-items:center;gap:8px;}.ctx-item:hover{background:var(--bgi);}.ctx-item.danger{color:#c0705a;}
.bs-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;align-items:center;justify-content:center;}.bs-overlay.show{display:flex;}
.bs-popup{background:var(--bg2);border-radius:16px;width:min(260px,80vw);padding:8px 0;box-shadow:0 8px 30px rgba(0,0,0,.18);}
.bs-item{padding:14px 24px;font-size:15px;cursor:pointer;color:var(--tx);display:flex;align-items:center;gap:12px;border-top:1px solid var(--bd);}.bs-item:first-of-type{border-top:none;}.bs-item:hover{background:var(--bgi);}.bs-item.danger{color:#c0705a;}
.bs-item svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.typing-indicator{display:flex;gap:4px;padding:10px 14px;align-items:center;}.typing-dot{width:6px;height:6px;background:var(--tx2);border-radius:50%;animation:typeBounce 1.4s ease-in-out infinite;}.typing-dot:nth-child(2){animation-delay:.25s;}.typing-dot:nth-child(3){animation-delay:.5s;}
.stop-btn{width:28px;height:28px;border-radius:50%;border:1.5px solid var(--bd2);background:var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--tx2);flex-shrink:0;transition:all .15s;}.stop-btn:hover{border-color:#c0705a;color:#c0705a;background:rgba(192,112,90,.08);}.stop-btn svg{width:14px;height:14px;stroke:currentColor;fill:currentColor;}
@keyframes typeBounce{0%,80%,100%{opacity:.25;transform:translateY(0);}35%{opacity:.9;transform:translateY(-3px);}}
/* Edit message modal - near full screen */
.edit-modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;align-items:center;justify-content:center;padding:16px;}.edit-modal-ov.show{display:flex;}
.edit-modal{background:var(--bg2);border-radius:16px;width:100%;max-width:500px;height:calc(66dvh);max-height:520px;padding:22px;box-shadow:0 8px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;}
.edit-modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-shrink:0;}.edit-modal-title{font-size:16px;font-weight:600;color:var(--tx3);}
.edit-modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bgi);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--tx2);}.edit-modal-close:hover{background:var(--bd);}
.edit-modal textarea{flex:1;min-height:0;resize:none;}
.edit-modal .ctr{margin-bottom:12px;}
.edit-modal-btn{width:100%;padding:12px;border-radius:10px;border:none;background:var(--bgi);color:var(--tx3);font-size:15px;font-weight:500;cursor:pointer;font-family:inherit;}.edit-modal-btn:hover{background:var(--bd);}
/* Drag handle for events */
.ev-drag{display:none;}
.ev-toggle-item{display:flex;align-items:center;gap:10px;padding:16px 14px;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;margin-bottom:8px;}
.ev-toggle-item .lb{flex:1;min-width:0;cursor:pointer;}.ev-toggle-item .lt{font-size:16px;}.ev-toggle-item .ls{font-size:13px;color:var(--tx2);margin-top:6px;}
.tog{position:relative;width:34px;height:18px;background:var(--bd);border-radius:9px;cursor:pointer;flex-shrink:0;transition:background .2s;}.tog.on{background:var(--ac);}.tog::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 2px rgba(0,0,0,.08);}.tog.on::after{transform:translateX(16px);}
.pcmd-panel{display:none;position:fixed;bottom:0;left:0;right:0;z-index:251;background:var(--bg2);border-top:1px solid var(--bd);box-shadow:0 -4px 16px rgba(0,0,0,.08);border-radius:16px 16px 0 0;max-height:80vh;min-height:50vh;overflow-y:auto;padding:20px 16px;transition:transform .25s ease;}.pcmd-panel.show{display:block;}
.pcmd-panel-handle{width:36px;height:4px;background:var(--bd2);border-radius:2px;margin:0 auto 14px;}
.pcmd-overlay{display:none;position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.25);}.pcmd-overlay.show{display:block;}
.pcmd-card{padding:14px;border:1px solid var(--bd);border-radius:10px;margin-bottom:8px;background:var(--bg3);}.pcmd-card .lt{font-size:16px;font-weight:500;margin-bottom:4px;}.pcmd-card .ls{font-size:16px;color:var(--tx2);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.batch-del-bar{display:none;padding:10px 16px;background:var(--bg2);border-bottom:1px solid var(--bd);gap:10px;align-items:center;justify-content:space-between;}.batch-del-bar.show{display:flex;}
.batch-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--bd2);background:transparent;flex-shrink:0;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;}.batch-dot.sel{border-color:var(--ac);background:var(--ac);}
.batch-dot.sel::after{content:'✓';color:#fff;font-size:12px;font-weight:700;}
.msg-del-mode .cm{position:relative;}
.msg-del-mode .msg-row{cursor:pointer;transition:all .15s;-webkit-user-select:none;user-select:none;}.msg-del-mode .msg-row.msg-del-sel .msg-bubble{outline:2px solid #c0705a;outline-offset:2px;}.msg-del-mode .msg-bubble{-webkit-user-select:none;user-select:none;pointer-events:none;}
.msg-del-banner{display:none;padding:8px 16px;background:#c0705a;color:#fff;font-size:14px;text-align:center;flex-shrink:0;}.msg-del-banner.show{display:block;}
.msg-ss-banner{display:none;padding:8px 16px;background:var(--ac);color:#fff;font-size:14px;text-align:center;flex-shrink:0;}.msg-ss-banner.show{display:block;}
.msg-ss-bar{display:none;padding:12px 16px;flex-shrink:0;z-index:12;flex-direction:column;gap:8px;background:var(--bg2);border-top:1px solid var(--bd);}.msg-ss-bar.show{display:flex;}
.msg-ss-bar .mss-main{width:100%;padding:14px;border-radius:12px;border:none;background:var(--ac);color:#fff;font-size:16px;font-weight:500;cursor:pointer;font-family:inherit;}
.msg-ss-bar .mss-cancel{width:100%;padding:10px;border-radius:10px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx2);font-size:14px;cursor:pointer;font-family:inherit;}
.msg-ss-mode .msg-row{cursor:pointer;transition:all .15s;}.msg-ss-mode .msg-row.msg-ss-sel{outline:2px solid var(--ac);outline-offset:2px;border-radius:12px;}
.msg-del-bar{display:none;padding:12px 16px;flex-shrink:0;z-index:12;flex-direction:column;gap:8px;background:var(--bg2);border-top:1px solid var(--bd);}.msg-del-bar.show{display:flex;}
.msg-del-bar .mdel-main{width:100%;padding:14px;border-radius:12px;border:none;background:#c0705a;color:#fff;font-size:16px;font-weight:500;cursor:pointer;font-family:inherit;}.msg-del-bar .mdel-main:hover{background:#a85d4a;}
.msg-del-bar .mdel-cancel{width:100%;padding:10px;border-radius:10px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx2);font-size:14px;cursor:pointer;font-family:inherit;}
.pcmd-plus{width:44px;height:44px;border-radius:50%;border:1px solid var(--bd);background:var(--bg2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;color:var(--tx2);flex-shrink:0;}.pcmd-plus:hover{border-color:var(--ac);color:var(--ac);}.pcmd-plus.active{background:var(--ac);border-color:var(--ac);color:#fff;}
.emb-progress{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:14px 20px;box-shadow:0 4px 16px rgba(0,0,0,.1);z-index:600;min-width:260px;display:none;text-align:center;}.emb-progress.show{display:block;}
.emb-progress .prog-bar{width:100%;height:6px;background:var(--bgi);border-radius:3px;margin-top:8px;overflow:hidden;}.emb-progress .prog-fill{height:100%;background:var(--ac);border-radius:3px;transition:width .3s;}
.splash{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .4s ease;}.splash.hide{opacity:0;pointer-events:none;}
.splash-cloud{position:relative;width:220px;height:200px;display:flex;align-items:center;justify-content:center;}
.splash-cloud .splash-title{position:absolute;z-index:3;top:50px;left:50%;transform:translateX(-50%);font-size:26px;font-weight:700;color:var(--tx3);letter-spacing:1px;white-space:nowrap;}
.splash-cloud svg.cloud-bg{position:absolute;z-index:2;top:0;left:50%;transform:translateX(-50%);opacity:0;animation:sCloudIn 2.4s ease infinite;}
.splash-dot{position:absolute;border-radius:50%;border:1.5px solid var(--bd);background:var(--bg2);z-index:1;opacity:0;}
.splash-dot.d1{width:10px;height:10px;bottom:32px;left:38%;animation:sDotPop 2.4s ease infinite;}
.splash-dot.d2{width:18px;height:18px;bottom:48px;left:18%;animation:sDotPop 2.4s ease .4s infinite;}
@keyframes sDotPop{0%{opacity:0;}10%{opacity:1;}40%{opacity:1;}55%{opacity:0;}100%{opacity:0;}}
@keyframes sCloudIn{0%{opacity:0;transform:translateX(-50%);}35%{opacity:0;transform:translateX(-50%);}45%{opacity:1;transform:translateX(-50%);}80%{opacity:1;transform:translateX(-50%);}92%{opacity:0;transform:translateX(-50%);}100%{opacity:0;transform:translateX(-50%);}}
.splash-sub{font-size:14px;color:var(--tx2);margin-top:8px;}
.splash-dots{display:flex;gap:6px;margin-top:24px;}.splash-dots span{width:6px;height:6px;background:var(--ac);border-radius:50%;animation:sDot 1.2s infinite;opacity:.3;}.splash-dots span:nth-child(2){animation-delay:.2s;}.splash-dots span:nth-child(3){animation-delay:.4s;}
@keyframes sDot{0%,100%{opacity:.3;transform:scale(1);}50%{opacity:1;transform:scale(1.3);}}
</style>
</head>
<body>
<div class="splash" id="splash"><div class="splash-cloud">
<div class="splash-title">Reverie</div>
<svg class="cloud-bg" width="210" height="130" viewBox="0 0 210 130" fill="none">
<path d="M35,108 C12,108 2,92 5,76 C8,62 20,52 34,50 C32,36 40,22 56,18 C70,14 85,20 92,32 C98,16 116,6 136,10 C156,14 170,30 168,50 C182,48 198,60 196,78 C194,96 178,108 162,108 Z" fill="var(--bg2)" stroke="var(--bd)" stroke-width="1.5"/>
</svg>
<div class="splash-dot d1"></div>
<div class="splash-dot d2"></div>
<div id="splash-status" style="position:absolute;bottom:-28px;width:100%;text-align:center;font-size:12px;color:var(--tx2);"></div>
</div></div>
<div class="toast" id="toast"></div>
<input type="file" accept="image/*" class="hidden" id="av-input" onchange="onAvUpload(this)">
<div class="emb-progress" id="emb-prog"><div style="font-size:14px;color:var(--tx);" id="emb-prog-text">載入 Embedding 模型中...</div><div class="prog-bar"><div class="prog-fill" id="emb-prog-fill" style="width:0%"></div></div></div>
<div class="crop-ov" id="crop-ov">
<div class="crop-area" id="crop-area"><img id="crop-img"><div class="crop-frame" id="crop-frame"><div class="crop-circle" id="crop-circle"></div></div></div>
<div class="crop-btns"><button class="crop-cancel" onclick="closeCrop()">取消</button><button class="crop-ok" onclick="confirmCrop()">裁切</button></div>
</div>
<div class="confirm-ov" id="cfm-ov"><div class="confirm-box"><div class="confirm-msg" id="cfm-msg"></div><div class="confirm-actions"><button class="btn bs2" onclick="cfmR(false)">取消</button><button class="btn bdel bs2" onclick="cfmR(true)">確定</button></div></div></div>
<div class="confirm-ov" id="inp-ov"><div class="confirm-box"><div class="confirm-msg" id="inp-msg" style="font-size:16px;"></div><input type="text" id="inp-val" onkeydown="if(event.key==='Enter')inpR(this.value)" style="width:100%;margin:8px 0 12px;padding:10px 12px;border:1px solid var(--bd);border-radius:8px;background:var(--bg);color:var(--tx);font-size:16px;"><div class="confirm-actions"><button class="btn bs2" onclick="inpR(null)">取消</button><button class="btn bp bs2" onclick="inpR($('inp-val').value)">確定</button></div></div></div>
<div class="ctx-menu hidden" id="ctx-menu"></div>
<div class="bs-overlay" id="bs-ov" onclick="closeBs()"><div class="bs-popup" id="bs-body" onclick="event.stopPropagation()"></div></div>
<div class="edit-modal-ov" id="em-ov"><div class="edit-modal"><div class="edit-modal-head"><div class="edit-modal-title">更正訊息</div><button class="edit-modal-close" onclick="closeEditModal()">✕</button></div><textarea id="em-ta" oninput="$('em-ctr').textContent='('+this.value.length+'/'+(_emMax||9999)+')'"></textarea><div class="ctr" id="em-ctr"></div><button class="edit-modal-btn" onclick="confirmEditMsg()">完成</button></div></div>
<div class="main" id="main">
<!-- 聊天 -->
<div class="pnl a" id="p-chat">
  <div class="scr" id="cl"><div class="sh"><div class="sht">聊天</div><div class="ham" onclick="openChatListMenu()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></div></div><div class="batch-del-bar" id="batch-del-bar"><span style="font-size:14px;color:var(--tx2);" id="batch-del-count">已選 0 個</span><div style="display:flex;gap:6px;"><button class="btn bs2" onclick="toggleBatchDel()">取消</button><button class="btn bdel bs2" onclick="execBatchDel()">刪除選取</button></div></div><div id="chat-list"><div class="empty">點擊「+ 新對話」開始</div></div></div>
  <div class="cw" id="cv">
    <div class="ch"><span class="bk" onclick="closeChat()" style="margin:0;font-size:16px;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="chn" id="c-name" style="display:none;">對話</div><div style="flex:1;"></div><div class="rp-sel rp-sel-sm" id="rp-btn" onclick="openPopup('rp-popup')">標準 RP</div><div class="ham" onclick="openSide()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></div></div>
    <div class="msg-del-banner" id="msg-del-banner">請選擇要刪除的訊息。</div>
    <div class="msg-ss-banner" id="msg-ss-banner">請選擇要截圖的訊息。</div>
    <div class="cm" id="c-msgs"></div>
    <div class="msg-del-bar" id="msg-del-bar"><button class="mdel-main" id="msg-del-exec" onclick="execMsgDel()">刪除 (0)</button><button class="mdel-cancel" onclick="cancelMsgDel()">取消選擇</button></div>
    <div class="msg-ss-bar" id="msg-ss-bar"><button class="mss-main" id="msg-ss-exec" onclick="execScreenshot()">截圖 (0)</button><button class="mss-cancel" onclick="cancelScreenshot()">取消</button></div>
    <div class="pcmd-overlay" id="pcmd-overlay" onclick="closePcmdPanel()"></div>
    <div class="pcmd-panel" id="pcmd-panel"><div class="pcmd-panel-handle" id="pcmd-handle"></div><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;"><div style="font-size:18px;font-weight:600;color:var(--tx3);">常駐指令</div><div class="ham" onclick="newPcmd()" style="width:32px;height:32px;"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div></div><div id="pcmd-list"></div></div>
    <div class="ci" id="ci"><div class="pcmd-plus" id="pcmd-plus-btn" onclick="togglePcmdPanel()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div><div class="ci-box"><textarea rows="1" placeholder="輸入..." id="c-inp" onkeydown="handleCInpKey(event)" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,200)+'px';"></textarea><div class="ci-send" onclick="sendMsg()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div></div></div>
  </div>
</div>
<!-- 角色 -->
<div class="pnl" id="p-chars"><div class="scr">
  <div id="vl"><div class="sh"><div class="sht">角色</div><button class="btn bp bs2" onclick="createChar()">+ 新增</button></div><div id="char-list"></div></div>
  <div id="vd" style="display:none;">
    <div class="sh" style="position:sticky;top:-16px;z-index:10;background:var(--bg);padding:16px 0 10px;border-bottom:1px solid var(--bd);margin-bottom:12px;"><span class="bk" onclick="closeCharEdit()" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div style="flex:1;"></div><button class="btn bdel bs2" onclick="delChar()">刪除</button><button class="btn bp bs2" onclick="saveChar()">儲存</button></div>
    <div class="av-editor"><div class="av-ed-wrap" id="ce-av-wrap">?</div><span class="av-ed-badge" onclick="event.stopPropagation();startAvUp('char')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span></div>
    <input type="hidden" id="ce-id">
    <div class="card"><div class="ct">角色卡主體</div>
      <div class="f"><label>姓名</label><input type="text" id="ce-name"></div>
      <div class="f"><label>年齡</label><input type="number" id="ce-age"></div><div class="f"><label>性別</label><div class="rp-sel" id="ce-gen" onclick="openPopup('gen-pop')" style="height:44px;display:flex;align-items:center;">未設置</div></div><div class="f"><label>職業</label><input type="text" id="ce-job" placeholder="例：劍士、醫師..."></div>
      <div class="f"><label>角色設定</label><textarea rows="14" id="ce-set" oninput="cntF(this)"></textarea><div class="ctr">0 字 · ≈ 0 tokens</div></div>
    </div>
    <div class="card"><div class="ct">附加資訊</div><div id="ce-ex"></div><button class="btn bs2" onclick="addExUI()" style="margin-top:8px;">+ 新增</button></div>
    <div class="card"><div class="ct">第一次聊天場景</div><div class="f"><label>情境腳本</label><textarea rows="8" id="ce-scn" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div><div class="f"><label>角色開場白</label><textarea rows="6" id="ce-grt" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div></div>
  </div>
</div></div>
<!-- 檔案 -->
<div class="pnl" id="p-prof"><div class="scr">
  <div id="pf-vl"><div class="sh"><div class="sht">檔案</div><button class="btn bp bs2" onclick="createPf()">+ 新增</button></div><div id="pf-list"></div></div>
  <div id="pf-vd" style="display:none;">
    <div class="sh" style="position:sticky;top:-16px;z-index:10;background:var(--bg);padding:16px 0 10px;border-bottom:1px solid var(--bd);margin-bottom:12px;"><span class="bk" onclick="closePfEdit()" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div style="flex:1;"></div><button class="btn bdel bs2" onclick="delPfDetail()">刪除</button><button class="btn bp bs2" onclick="savePfDetail()">儲存</button></div>
    <div class="av-editor"><div class="av-ed-wrap" id="pf-av-wrap" style="width:160px;height:160px;border-radius:50%;">?</div><span class="av-ed-badge" onclick="event.stopPropagation();startAvUp('profile',_pfEditId)"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span></div>
    <input type="hidden" id="pf-edit-id">
    <div class="card"><div class="ct">基本資料</div><div class="f"><label>名稱</label><input type="text" id="pf-edit-name"></div><div class="f"><label>年齡</label><input type="number" id="pf-edit-age"></div><div class="f"><label>性別</label><div class="rp-sel" id="pf-gen" onclick="openPopup('pf-gen-pop')" style="height:44px;display:flex;align-items:center;">未設置</div></div><div class="f"><label>職業</label><input type="text" id="pf-edit-job" placeholder="例：冒險者..."></div><div class="f"><label>設定</label><textarea rows="10" id="pf-edit-setting" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div></div>
  </div>
</div></div>
<!-- 系統 -->
<div class="pnl" id="p-sys"><div class="scr">
  <div class="sh"><div class="sht">系統</div></div>
  <div class="snv"><div class="sbb a" onclick="ss(this,0)">設定</div><div class="sbb" onclick="ss(this,1)">提示詞</div><div class="sbb" onclick="ss(this,2)">記憶管理</div></div>
  <div class="sp a" id="s0">
    <div class="card"><div class="stt">API 設定</div><div id="api-cfg-list"></div><button class="btn bs2" onclick="addApiCfg()" style="margin-top:8px;">+ 新增</button></div>
    <div class="card"><div class="stt">生成參數</div><div class="f"><label>Temperature</label><div class="sr"><input type="range" id="set-temp" min="0" max="100" value="80" oninput="this.nextElementSibling.textContent=(this.value/100).toFixed(2)"><span class="svl">0.80</span></div></div><div class="fr"><div class="f"><label>Max Input</label><input type="number" id="set-maxin" value="20000"></div><div class="f"><label>Max Output</label><input type="number" id="set-maxout" value="1200"></div></div></div>
    <div class="card"><div class="stt">本地向量 Embedding</div><div style="font-size:13px;color:var(--tx2);line-height:1.6;margin-bottom:12px;">使用 transformers.js 在瀏覽器本地運行（約 23MB）。首次需下載模型，之後快取。</div><div class="f" style="display:flex;align-items:center;gap:10px;"><label style="flex:1;">啟用本地向量搜尋</label><div class="tog" id="set-emb-local" onclick="this.classList.toggle('on')"></div></div><div class="stt" style="margin-top:10px;">搜尋參數</div><div class="f"><label>相似度門檻（越低撈越多）</label><div class="sr"><input type="range" id="set-vec-threshold" min="0" max="90" value="30" oninput="this.nextElementSibling.textContent=(this.value/100).toFixed(2)"><span class="svl">0.30</span></div></div><div class="fr"><div class="f"><label>附加資訊筆數</label><input type="number" id="set-vec-extras" value="3" min="1" max="20"></div><div class="f"><label>事件筆數</label><input type="number" id="set-vec-events" value="3" min="1" max="20"></div><div class="f"><label>記憶筆數</label><input type="number" id="set-vec-memories" value="5" min="1" max="30"></div></div><button class="btn bs2" onclick="rebuildAllEmb()" style="width:100%;margin-top:8px;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>重新生成所有向量</button></div>
    <div class="card"><div class="stt">主題顏色</div><div class="theme-row"><div class="theme-dot" data-theme="" style="background:linear-gradient(135deg,#7c9eb2,#e4eef3);" onclick="setTh('',this)"></div><div class="theme-dot" data-theme="theme-warm" style="background:linear-gradient(135deg,#c0705a,#f0ddd6);" onclick="setTh('theme-warm',this)"></div><div class="theme-dot" data-theme="theme-sage" style="background:linear-gradient(135deg,#6b9080,#dce8e2);" onclick="setTh('theme-sage',this)"></div><div class="theme-dot" data-theme="theme-lavender" style="background:linear-gradient(135deg,#8b7fb5,#e2dff0);" onclick="setTh('theme-lavender',this)"></div><div class="theme-dot" data-theme="theme-rose" style="background:linear-gradient(135deg,#b5707e,#f0dde2);" onclick="setTh('theme-rose',this)"></div><div class="theme-dot" data-theme="theme-ocean" style="background:linear-gradient(135deg,#5088a8,#d4e4f0);" onclick="setTh('theme-ocean',this)"></div></div><div class="theme-row" style="margin-top:8px;"><div class="theme-dot" data-theme="theme-dark" style="background:linear-gradient(135deg,#1a1a2e,#7c9eb2);" onclick="setTh('theme-dark',this)"></div><div class="theme-dot" data-theme="theme-dark-warm" style="background:linear-gradient(135deg,#1e1a18,#c0705a);" onclick="setTh('theme-dark-warm',this)"></div><div class="theme-dot" data-theme="theme-dark-green" style="background:linear-gradient(135deg,#161e1a,#6b9080);" onclick="setTh('theme-dark-green',this)"></div><div class="theme-dot" data-theme="theme-midnight" style="background:linear-gradient(135deg,#0f1118,#8b7fb5);" onclick="setTh('theme-midnight',this)"></div><div class="theme-dot" data-theme="theme-black" style="background:linear-gradient(135deg,#000000,#333333);" onclick="setTh('theme-black',this)"></div></div></div>
    <div style="margin-top:12px;"><button class="btn bp" onclick="saveSettings()">儲存</button></div>
  </div>
  <div class="sp" id="s1"><div class="pl" id="pl"></div><button class="btn bs2" onclick="createPr()" style="margin-bottom:12px;">+ 新增</button><div class="card" id="pr-edit" style="display:none;"><input type="hidden" id="pe-id"><div class="f"><label>名稱</label><input type="text" id="pn"></div><div class="f"><label>使用 API</label><div class="rp-sel" id="pr-api-btn" onclick="openPopup('pr-api-pop')">未選擇</div><input type="hidden" id="pr-api-id" value=""></div><div class="f"><label>選擇模型</label><div class="rp-sel" id="pr-model-btn" onclick="openPopup('pr-model-pop')">未選擇</div><input type="hidden" id="pr-model-id" value=""></div><div class="f"><label>內容</label><textarea rows="10" id="tp2" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="savePr()">儲存</button><button class="btn bdel bs2" onclick="delPr()">刪除</button></div></div></div>
  <div class="sp" id="s2">
  <div class="card"><div class="stt">自動摘要</div><div class="f" style="display:flex;align-items:center;gap:10px;"><label style="flex:1;">啟用自動摘要</label><div class="tog" id="set-sum-auto" onclick="this.classList.toggle('on')"></div></div><div class="f"><label>每幾次 AI 回覆自動摘要</label><input type="number" id="set-sum-interval" value="10" min="3" placeholder="10"></div><div class="f"><label>使用 API</label><div class="rp-sel" id="sum-api-btn" onclick="openPopup('sum-api-pop')">未選擇</div><input type="hidden" id="sum-api-id" value=""></div><div class="f"><label>選擇模型</label><div class="rp-sel" id="sum-model-btn" onclick="openPopup('sum-model-pop')">未選擇</div><input type="hidden" id="sum-model-id" value=""></div><div class="f"><label>摘要提示詞</label><textarea rows="4" id="sum-prompt" placeholder="你是一個對話摘要助手。請將以下角色扮演對話濃縮成一份簡潔的摘要，保留重要的劇情發展、角色關係變化和關鍵事件。摘要必須控制在 500 tokens 以內。使用繁體中文。" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div></div>
  <div class="card"><div class="stt">記憶生成</div><div class="f"><label>使用 API</label><div class="rp-sel" id="mem-api-btn" onclick="openPopup('mem-api-pop')">未選擇</div><input type="hidden" id="mem-api-id" value=""></div><div class="f"><label>選擇模型</label><div class="rp-sel" id="mem-model-btn" onclick="openPopup('mem-model-pop')">未選擇</div><input type="hidden" id="mem-model-id" value=""></div><div class="f"><label>生成指令</label><textarea rows="10" id="mem-prompt" placeholder="從以下對話中提取重要記憶，包含：角色間的關係變化、重要承諾或約定、角色透露的個人資訊、情感轉折點、關鍵劇情事件。每條記憶用一行表示，保持簡潔。使用繁體中文。" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div><div class="f"><label>觸發規則（每 N 則對話生成一次）</label><input type="number" id="mem-rule" value="10" min="1" placeholder="例：10"></div></div>
  <div style="margin-top:12px;"><button class="btn bp" onclick="saveMemSettings()">儲存</button></div>
  </div>
</div></div>
</div>
<!-- 儲存管理 -->
<div class="pnl" id="p-conn"><div class="scr">
  <div class="sh"><div class="sht">儲存管理</div></div>
  <div class="card"><div class="stt">本地儲存狀態</div>
  <div style="font-size:14px;color:var(--tx);line-height:1.8;" id="storage-info">計算中...</div>
  <button class="btn bs2" onclick="calcStorageInfo()" style="margin-top:8px;">重新計算</button>
  <button class="btn bs2" onclick="debugDump()" style="margin-top:4px;">除錯：傾印資料庫</button>
  </div>
  <div class="card" style="background:transparent;border:none;box-shadow:none;padding:0;"><div style="font-size:13px;color:var(--tx2);line-height:1.6;">所有資料儲存在瀏覽器 IndexedDB 中，無需網路連線。<br>清除瀏覽器資料會清除所有 RP 資料，請定期匯出備份。</div></div>
  <div class="card"><div class="stt">匯出 / 匯入</div>
  <div style="display:flex;flex-direction:column;gap:8px;">
  <button class="btn bs2" onclick="exportAll()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>匯出全部資料</button>
  <button class="btn bs2" onclick="exportChars()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>匯出所有角色</button>
  <button class="btn bs2" onclick="exportCardV2()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/><path d="M12 11v4M10 13h4" stroke-width="1.5"/></svg>匯出角色 (Card V2)</button>
  <button class="btn bs2" onclick="exportChats()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>匯出所有對話</button>
  <div style="border-top:1px solid var(--bd);margin:4px 0;"></div>
  <button class="btn bs2" onclick="$('import-file').click()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>匯入 JSON</button>
  <input type="file" id="import-file" accept=".json,.png" style="display:none;" onchange="importFile(this)">
  <div style="font-size:12px;color:var(--tx2);line-height:1.5;">支援格式：Reverie 備份 JSON（雲端版/本地版通用）、Character Card V2 JSON/PNG。</div>
  </div></div>
  <div class="card"><div class="stt" style="color:#c0705a;">危險區域</div>
  <button class="btn bdel bs2" onclick="clearAllData()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>清除所有資料</button>
  <div style="font-size:12px;color:var(--tx2);margin-top:8px;">此操作不可復原，請先匯出備份。</div>
  </div>
</div></div>
<!-- Sidebar -->
<div class="side-overlay" id="sov" onclick="closeSide()"></div>
<div class="sidebar" id="sbar"><div class="side-title">對話設定</div><div class="side-section">玩家檔案</div><div class="side-profile-active" id="side-player" onclick="openPopup('pp-pop')"><div class="av" style="width:28px;height:28px;font-size:12px;">?</div><span>未選擇</span><span class="switch-hint">切換 ▸</span></div><div class="side-section">管理</div><div class="side-item" onclick="renameChatInline();closeSide();"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>重新命名</div><div class="side-item" onclick="openChatEvents();closeSide();"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>事件</div><div class="side-item" onclick="openChatMemory();closeSide();"><svg viewBox="0 0 24 24"><path d="M12 2a5 5 0 00-4.8 3.6A4 4 0 004 9.5a4 4 0 00.7 5.1A5 5 0 007 20h1v-8"/><path d="M12 2a5 5 0 014.8 3.6A4 4 0 0120 9.5a4 4 0 01-.7 5.1A5 5 0 0117 20h-1v-8"/><path d="M8 14c2-1 4-1 4-1s2 0 4 1"/></svg>記憶體</div><div class="side-item" onclick="openSummary();closeSide();"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>歷史摘要</div><div class="side-item danger" onclick="delCurrentChat();"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>刪除</div></div>
<!-- Popups -->
<div class="popup-ov" id="gen-pop" onclick="if(event.target===this)closePopup('gen-pop')"><div class="popup"><div class="popup-title">選擇性別</div><div class="popup-item" onclick="pickGen(this,'男性')"><span>男性</span><span class="check">✓</span></div><div class="popup-item" onclick="pickGen(this,'女性')"><span>女性</span><span class="check">✓</span></div><div class="popup-item active" onclick="pickGen(this,'未設置')"><span>未設置</span><span class="check">✓</span></div></div></div>
<div class="popup-ov" id="pf-gen-pop" onclick="if(event.target===this)closePopup('pf-gen-pop')"><div class="popup"><div class="popup-title">選擇性別</div><div class="popup-item" onclick="pickPfGen(this,'男性')"><span>男性</span><span class="check">✓</span></div><div class="popup-item" onclick="pickPfGen(this,'女性')"><span>女性</span><span class="check">✓</span></div><div class="popup-item active" onclick="pickPfGen(this,'未設置')"><span>未設置</span><span class="check">✓</span></div></div></div>
<div class="popup-ov" id="rp-popup" onclick="if(event.target===this)closePopup('rp-popup')"><div class="popup"><div class="popup-title">聊天模式</div><div id="rp-list"></div></div></div>
<div class="popup-ov" id="pp-pop" onclick="if(event.target===this)closePopup('pp-pop')"><div class="popup"><div class="popup-title">切換玩家檔案</div><div id="pp-list"></div></div></div>
<div class="popup-ov" id="newchat-pop" onclick="if(event.target===this)closePopup('newchat-pop')"><div class="popup"><div class="popup-title">選擇角色開始對話</div><div id="newchat-list"></div></div></div>
<div class="popup-ov" id="chat-setup-pop" onclick="if(event.target===this)closePopup('chat-setup-pop')"><div class="popup" style="min-width:280px;"><div class="popup-title">對話設定</div><div style="padding:4px 0 8px;"><div style="font-size:13px;color:var(--tx2);margin-bottom:6px;">玩家檔案</div><div id="setup-pf-list"></div><div style="font-size:13px;color:var(--tx2);margin:12px 0 6px;">聊天模式</div><div id="setup-rp-list"></div></div><div style="padding:8px 0 4px;"><button class="btn bp" style="width:100%;" onclick="confirmChatSetup()">開始對話</button></div></div></div>
<div class="popup-ov" id="pr-api-pop" onclick="if(event.target===this)closePopup('pr-api-pop')"><div class="popup"><div class="popup-title">選擇 API</div><div id="pr-api-list"></div></div></div>
<div class="popup-ov" id="pr-model-pop" onclick="if(event.target===this)closePopup('pr-model-pop')"><div class="popup"><div class="popup-title">選擇模型</div><div id="pr-model-list"></div></div></div>
<div class="popup-ov" id="sum-api-pop" onclick="if(event.target===this)closePopup('sum-api-pop')"><div class="popup"><div class="popup-title">摘要 API</div><div id="sum-api-list"></div></div></div>
<div class="popup-ov" id="sum-model-pop" onclick="if(event.target===this)closePopup('sum-model-pop')"><div class="popup"><div class="popup-title">摘要模型</div><div id="sum-model-list"></div></div></div>
<div class="popup-ov" id="mem-api-pop" onclick="if(event.target===this)closePopup('mem-api-pop')"><div class="popup"><div class="popup-title">記憶 API</div><div id="mem-api-list"></div></div></div>
<div class="popup-ov" id="mem-model-pop" onclick="if(event.target===this)closePopup('mem-model-pop')"><div class="popup"><div class="popup-title">記憶模型</div><div id="mem-model-list"></div></div></div>
<div class="popup-ov" id="emb-api-pop" onclick="if(event.target===this)closePopup('emb-api-pop')"><div class="popup"><div class="popup-title">Embedding API</div><div id="emb-api-list"></div></div></div>
<div class="popup-ov" id="emb-model-pop" onclick="if(event.target===this)closePopup('emb-model-pop')"><div class="popup"><div class="popup-title">Embedding 模型</div><div id="emb-model-list"></div></div></div>
<div class="popup-ov" id="provider-pop" onclick="if(event.target===this)closePopup('provider-pop')"><div class="popup"><div class="popup-title">選擇供應商</div><div class="popup-item active" onclick="pickSel('acfg-provider','anthropic','Anthropic',this,'provider-pop')"><span>Anthropic</span><span class="check">✓</span></div><div class="popup-item" onclick="pickSel('acfg-provider','openai','OpenAI',this,'provider-pop')"><span>OpenAI</span><span class="check">✓</span></div><div class="popup-item" onclick="pickSel('acfg-provider','google','Google',this,'provider-pop')"><span>Google</span><span class="check">✓</span></div><div class="popup-item" onclick="pickSel('acfg-provider','openrouter','OpenRouter',this,'provider-pop')"><span>OpenRouter</span><span class="check">✓</span></div></div></div>


<!-- Full Pages -->
<div class="fp" id="fp-sum"><div class="fp-head"><span class="bk" onclick="closeFP('fp-sum')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">歷史摘要</div><button class="btn bp bs2" onclick="genSummary()">生成</button></div><div class="fp-body full"><div class="f"><label>摘要內容</label><textarea rows="30" id="sum-ta" oninput="cntF(this)" style="min-height:50vh;" placeholder="點擊「生成摘要」或手動編輯..."></textarea><div class="ctr">0 字</div></div><div style="padding:0 16px;"><button class="btn bp bs2" onclick="saveSummary()">儲存</button></div></div></div>
<div class="fp" id="fp-chat-ev"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-ev')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">事件管理</div></div><div class="fp-body" id="chat-ev-body"></div></div>
<div class="fp" id="fp-chat-ev-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-ev-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">編輯事件</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveChatEv()">儲存</button><button class="btn bdel bs2" onclick="delChatEv()">刪除</button></div></div><div class="fp-body full"><input type="hidden" id="cev2-id"><div class="f"><label>標題</label><input type="text" id="cev2-n"></div><div class="f"><label>觸發關鍵字 / 時間</label><input type="text" id="cev2-t"></div><div class="f"><label>內容</label><textarea rows="8" id="cev2-c" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div></div></div>
<div class="fp" id="fp-chat-mem"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-mem')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">記憶體</div><button class="btn bp bs2" onclick="newChatMem()">+ 新增</button></div><div class="fp-body" id="chat-mem-body"></div></div>
<div class="fp" id="fp-chat-mem-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-mem-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">編輯記憶</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveChatMem()">儲存</button><button class="btn bdel bs2" onclick="delChatMem()">刪除</button></div></div><div class="fp-body full"><input type="hidden" id="cmem-id"><input type="hidden" id="cmem-src" value="local"><div class="f"><label>內容</label><textarea rows="30" id="cmem-c" oninput="cntF(this)" style="min-height:220px;"></textarea><div class="ctr">0 字</div></div></div></div>
<div class="fp" id="fp-cev"><div class="fp-head"><span class="bk" onclick="closeFP('fp-cev')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title" id="cev-t">預設事件</div><button class="btn bp bs2" onclick="newCEv()">+ 新增</button></div><div class="fp-body" id="cev-body"></div></div>
<div class="fp" id="fp-cev-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-cev-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">編輯事件</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveCEv()">儲存</button><button class="btn bdel bs2" onclick="delCEv()">刪除</button></div></div><div class="fp-body full"><input type="hidden" id="ev-id"><div class="f"><label>標題</label><input type="text" id="ev-n"></div><div class="f"><label>時間 / 關鍵字</label><input type="text" id="ev-t"></div><div class="f"><label>內容</label><textarea rows="8" id="ev-c" oninput="cntF(this)"></textarea><div class="ctr">0 字</div></div></div></div>
<div class="fp" id="fp-pcmd-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-pcmd-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">編輯常駐指令</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="savePcmd()">儲存</button><button class="btn bdel bs2" onclick="delPcmd()">刪除</button></div></div><div class="fp-body full"><input type="hidden" id="pcmd-id"><div class="f"><label>名稱</label><input type="text" id="pcmd-name" placeholder="例：加強情緒描寫"></div><div class="f"><label>指令內容</label><textarea rows="10" id="pcmd-content" oninput="cntF(this)" placeholder="這段文字會隨每次訊息一起傳給 AI..."></textarea><div class="ctr">0 字</div></div></div></div>
<div class="fp" id="fp-api-cfg"><div class="fp-head"><span class="bk" onclick="closeFP('fp-api-cfg')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">編輯 API</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveApiCfg()">儲存</button><button class="btn bdel bs2" onclick="delApiCfg()">刪除</button></div></div><div class="fp-body full"><input type="hidden" id="acfg-id"><div class="f"><label>名稱</label><input type="text" id="acfg-name" placeholder="例：Anthropic 主力"></div><div class="f"><label>供應商</label><div class="rp-sel" id="acfg-provider-btn" onclick="openPopup('provider-pop')">Anthropic</div><input type="hidden" id="acfg-provider" value="anthropic"></div><div class="f"><label>API Key</label><input type="password" id="acfg-key" placeholder="sk-..." style="font-family:monospace;"></div><div style="padding-top:8px;"><button class="btn bs2" onclick="testApiConn()" id="acfg-test-btn" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx2);">🔌 測試連線</button><div id="acfg-test-result" style="margin-top:8px;font-size:13px;display:none;"></div></div></div></div>
<!-- Nav -->
<div class="nav-w" id="navw"><div class="nav-i">
  <div class="nv a" data-p="chat" onclick="nav(this)"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>聊天</div>
  <div class="nv" data-p="chars" onclick="nav(this)"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>角色</div>
  <div class="nv" data-p="prof" onclick="nav(this)"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>檔案</div>
  <div class="nv" data-p="sys" onclick="nav(this)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>系統</div>
  <div class="nv" data-p="conn" onclick="nav(this)"><svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>資料庫</div>
</div></div>
<script>
// === IndexedDB Data Layer ===
const DB_NAME='reverie_local',DB_VER=2;let _db=null;
function openDB(){return new Promise((res,rej)=>{if(_db){res(_db);return;}const req=indexedDB.open(DB_NAME,DB_VER);req.onupgradeneeded=e=>{const db=e.target.result;
const stores={characters:{},character_extras:{indexes:{character_id:'character_id'}},character_events:{indexes:{character_id:'character_id'}},profiles:{},prompts:{},chats:{},messages:{indexes:{chat_id:'chat_id'}},chat_events:{indexes:{chat_id:'chat_id'}},chat_creator_event_toggles:{indexes:{chat_id:'chat_id'}},memories:{indexes:{chat_id:'chat_id'}},settings:{},api_configs:{},persistent_commands:{},avatars:{}};
for(const[s,cfg] of Object.entries(stores)){let st;if(!db.objectStoreNames.contains(s)){st=db.createObjectStore(s,{keyPath:'id'});}else{st=e.target.transaction.objectStore(s);}
if(cfg.indexes){for(const[iName,iKey] of Object.entries(cfg.indexes)){if(!st.indexNames.contains(iName))st.createIndex(iName,iKey);}}}
};req.onsuccess=e=>{_db=e.target.result;res(_db);};req.onerror=e=>rej(e.target.error);});}
async function dbPut(s,o){const db=await openDB();return new Promise((r,j)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).put(o);tx.oncomplete=()=>r(o);tx.onerror=e=>j(e.target.error);});}
async function dbGet(s,id){const db=await openDB();return new Promise((r,j)=>{const rq=db.transaction(s,'readonly').objectStore(s).get(id);rq.onsuccess=()=>r(rq.result||null);rq.onerror=e=>j(e.target.error);});}
async function dbDel(s,id){const db=await openDB();return new Promise((r,j)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).delete(id);tx.oncomplete=()=>r();tx.onerror=e=>j(e.target.error);});}
async function dbAll(s){const db=await openDB();return new Promise((r,j)=>{const rq=db.transaction(s,'readonly').objectStore(s).getAll();rq.onsuccess=()=>r(rq.result||[]);rq.onerror=e=>j(e.target.error);});}
async function dbByIndex(s,idx,val){const db=await openDB();return new Promise((r,j)=>{try{const st=db.transaction(s,'readonly').objectStore(s);if(!st.indexNames.contains(idx)){console.warn('Index',idx,'missing on',s,', falling back to scan');const rq=st.getAll();rq.onsuccess=()=>r((rq.result||[]).filter(x=>x[idx]===val));rq.onerror=e=>j(e.target.error);return;}const rq=st.index(idx).getAll(val);rq.onsuccess=()=>r(rq.result||[]);rq.onerror=e=>j(e.target.error);}catch(e){console.warn('dbByIndex error, falling back:',e);const rq=db.transaction(s,'readonly').objectStore(s).getAll();rq.onsuccess=()=>r((rq.result||[]).filter(x=>x[idx]===val));rq.onerror=e2=>j(e2.target.error);}});}
async function dbClear(s){const db=await openDB();return new Promise((r,j)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).clear();tx.oncomplete=()=>r();tx.onerror=e=>j(e.target.error);});}
function sortBy(a,f,d='asc'){return[...a].sort((x,y)=>{const va=x[f]??0,vb=y[f]??0;return d==='asc'?(va>vb?1:va<vb?-1:0):(va<vb?1:va>vb?-1:0);});}
function uid(){return crypto.randomUUID?crypto.randomUUID():('id_'+Date.now()+'_'+Math.random().toString(36).slice(2,8));}
async function saveAvatar(key,file){return new Promise((r,j)=>{const rd=new FileReader();rd.onload=async()=>{await dbPut('avatars',{id:key,blob:rd.result,type:file.type,ts:Date.now()});r(rd.result);};rd.onerror=j;rd.readAsDataURL(file);});}

// === Local Embedding ===
let _embPipeline=null,_embLoading=false;
async function loadEmbeddingModel(){if(_embPipeline)return _embPipeline;if(_embLoading)return new Promise(r=>{const iv=setInterval(()=>{if(_embPipeline){clearInterval(iv);r(_embPipeline);}},200);});_embLoading=true;const prog=$('emb-prog'),fill=$('emb-prog-fill'),txt=$('emb-prog-text');prog.classList.add('show');txt.textContent='載入 Embedding 模型中...';fill.style.width='5%';try{const{pipeline}=await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');txt.textContent='下載模型權重...';fill.style.width='20%';_embPipeline=await pipeline('feature-extraction','Xenova/all-MiniLM-L6-v2',{progress_callback:p=>{if(p.status==='progress'&&p.progress)fill.style.width=Math.round(20+p.progress*0.75)+'%';}});fill.style.width='100%';txt.textContent='✅ 就緒';setTimeout(()=>prog.classList.remove('show'),1500);}catch(e){console.error(e);txt.textContent='❌ 失敗';setTimeout(()=>prog.classList.remove('show'),3000);_embLoading=false;return null;}_embLoading=false;return _embPipeline;}
async function getEmbedding(text){if(!getSettings().emb_local)return null;const pipe=await loadEmbeddingModel();if(!pipe)return null;try{const out=await pipe(text.substring(0,512),{pooling:'mean',normalize:true});return Array.from(out.data);}catch(e){return null;}}
function cosineSim(a,b){if(!a||!b||a.length!==b.length)return 0;let d=0,na=0,nb=0;for(let i=0;i<a.length;i++){d+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i];}return d/(Math.sqrt(na)*Math.sqrt(nb)+1e-8);}
async function embedAndPatch(store,id,text){const emb=await getEmbedding(text);if(!emb)return;const obj=await dbGet(store,id);if(!obj)return;obj.embedding=emb;await dbPut(store,obj);}
async function vectorSearch(store,indexField,indexVal,queryEmb,count,threshold){if(!queryEmb)return[];threshold=threshold||0.3;count=count||5;let items=indexField&&indexVal?await dbByIndex(store,indexField,indexVal):await dbAll(store);return items.filter(x=>x.embedding).map(x=>({...x,similarity:cosineSim(queryEmb,x.embedding)})).filter(x=>x.similarity>=threshold).sort((a,b)=>b.similarity-a.similarity).slice(0,count);}
async function rebuildAllEmb(){if(!getSettings().emb_local){toast('請先啟用');return;}if(!await cfm('重新生成所有向量？'))return;const pipe=await loadEmbeddingModel();if(!pipe)return;let c=0;toast('處理中...');for(const x of await dbAll('character_extras')){await embedAndPatch('character_extras',x.id,(x.title||'')+' '+(x.content||''));c++;}for(const x of await dbAll('character_events')){await embedAndPatch('character_events',x.id,(x.name||'')+' '+(x.time_or_keyword||'')+' '+(x.content||''));c++;}for(const x of await dbAll('memories')){await embedAndPatch('memories',x.id,x.content||'');c++;}toast('✅ '+c+' 筆');}

// === Storage Info ===
async function calcStorageInfo(){const el=$('storage-info');el.textContent='計算中...';try{const stores=['characters','character_extras','character_events','profiles','prompts','chats','messages','chat_events','memories','api_configs','persistent_commands','avatars'];let lines=[],total=0;for(const s of stores){const n=(await dbAll(s)).length;total+=n;lines.push(s+': '+n+' 筆');}if(navigator.storage&&navigator.storage.estimate){const est=await navigator.storage.estimate();lines.unshift('空間: '+((est.usage||0)/1048576).toFixed(1)+' / '+((est.quota||0)/1048576).toFixed(0)+' MB');}lines.push('總計: '+total+' 筆');el.innerHTML=lines.join('<br>');}catch(e){el.textContent='失敗';}}
async function debugDump(){const c=await dbAll('characters'),ex=await dbAll('character_extras'),ev=await dbAll('character_events');let r='角色: '+c.length+' 筆\n';c.forEach(x=>r+=' · '+x.name+' ('+x.id.substring(0,8)+'…)\n');r+='\n附加資訊: '+ex.length+' 筆\n';ex.forEach(x=>r+=' · ['+x.character_id?.substring(0,8)+'…] '+x.title+'\n');r+='\n事件: '+ev.length+' 筆\n';ev.forEach(x=>r+=' · ['+x.character_id?.substring(0,8)+'…] '+x.name+'\n');if(c.length&&(ex.length||ev.length)){const cid=c[0].id;const mEx=ex.filter(x=>x.character_id===cid).length;const mEv=ev.filter(x=>x.character_id===cid).length;r+='\n第一個角色 '+c[0].name+' ('+cid.substring(0,8)+'…):\n  匹配附加: '+mEx+' / '+ex.length+'\n  匹配事件: '+mEv+' / '+ev.length;if(!mEx&&ex.length)r+='\n⚠️ character_id 不匹配！';if(!mEv&&ev.length)r+='\n⚠️ event character_id 不匹配！';}alert(r);}
async function clearAllData(){if(!await cfm('⚠️ 清除所有資料？'))return;if(!await cfm('再次確認？'))return;for(const s of['characters','character_extras','character_events','profiles','prompts','chats','messages','chat_events','chat_creator_event_toggles','memories','settings','api_configs','persistent_commands','avatars'])try{await dbClear(s);}catch(e){}localStorage.removeItem('rp_av_off');toast('已清除');location.reload();}
// === Core UI ===
const $=id=>document.getElementById(id);marked.setOptions({breaks:true,gfm:true});const _renderer=new marked.Renderer();_renderer.heading=function(tok){return '<p>'+(typeof tok==='string'?tok:(tok.text||''))+'</p>\n';};marked.use({renderer:_renderer});
function tok(s){if(!s)return 0;let t=0;for(let i=0;i<s.length;i++){const c=s.charCodeAt(i);if(c>0x2E7F)t+=1.5;else if(c===32||c===10)t+=0;else t+=0.35;}return Math.ceil(t);}
function cntF(ta){const l=ta.value.length,t=tok(ta.value);const c=ta.parentElement.querySelector('.ctr');if(c)c.textContent=l+' 字 · ≈ '+t+' tokens';}
function toast(m){const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function avH(url,name,sz,ox,oy){sz=sz||40;ox=ox||0;oy=oy||0;const st='width:'+sz+'px;height:'+sz+'px;font-size:'+Math.round(sz*.38)+'px;';if(url){const p=ox||oy?'object-position:'+(50+ox)+'% '+(50+oy)+'%':'';return '<div class="av" style="'+st+'"><img src="'+url+'" style="'+p+'"></div>';}return '<div class="av" style="'+st+'">'+esc((name||'?')[0])+'</div>';}
let _cfm=null;function cfm(msg){return new Promise(r=>{_cfm=r;$('cfm-msg').textContent=msg;$('cfm-ov').classList.add('show');});}function cfmR(v){$('cfm-ov').classList.remove('show');if(_cfm)_cfm(v);_cfm=null;}
let _inp=null;function inp(msg,def){return new Promise(r=>{_inp=r;$('inp-msg').textContent=msg;$('inp-val').value=def||'';$('inp-ov').classList.add('show');setTimeout(()=>$('inp-val').focus(),100);});}function inpR(v){$('inp-ov').classList.remove('show');if(_inp)_inp(v);_inp=null;}

// === Nav ===
const navEl=$('navw'),mainEl=$('main');function showNav(){navEl.classList.remove('hide');mainEl.classList.remove('np');}function hideNav(){navEl.classList.add('hide');mainEl.classList.add('np');}
let hs=['main'];function pushH(id){hs.push(id);history.pushState({p:id},'');}
window.addEventListener('popstate',()=>{hs.pop();const p=hs[hs.length-1]||'main';const fps=document.querySelectorAll('.fp.show');if(fps.length>0){fps[fps.length-1].classList.remove('show');return;}document.querySelectorAll('.popup-ov.show').forEach(x=>x.classList.remove('show'));$('cfm-ov').classList.remove('show');$('inp-ov').classList.remove('show');closeSideQ();hideCtx();closeBs();$('em-ov').classList.remove('show');if(p==='main'){saveChatStore();closeChat(1);closeCharEdit(1);closePfEdit();showNav();}else if(p==='chat')hideNav();});
function nav(el){document.querySelectorAll('.nv').forEach(n=>n.classList.remove('a'));el.classList.add('a');document.querySelectorAll('.pnl').forEach(x=>x.classList.remove('a'));$('p-'+el.dataset.p).classList.add('a');showNav();hs=['main'];history.replaceState({p:'main'},'');if($('cl'))$('cl').style.display='block';if($('cv'))$('cv').classList.remove('a');if($('vl')){$('vl').style.display='block';$('vd').style.display='none';}if(el.dataset.p==='chars')loadChars();if(el.dataset.p==='prof'){loadPf();closePfEdit();}if(el.dataset.p==='sys'){loadPr();syncThemeDots();}if(el.dataset.p==='chat')renderChatList();if(el.dataset.p==='conn')calcStorageInfo();}
function openChat(n){$('cl').style.display='none';$('cv').classList.add('a');$('c-name').textContent=n;hideNav();pushH('chat');closePcmdPanel();}
function closeChat(q){if(_curChat)_curChat.draft=$('c-inp').value||'';$('cl').style.display='block';$('cv').classList.remove('a');saveChatStore();if(!q){showNav();renderChatList();}}
function openSide(){$('sov').classList.add('show');$('sbar').classList.add('show');}function closeSide(){$('sov').classList.remove('show');$('sbar').classList.remove('show');}function closeSideQ(){closeSide();}
function openFP(id){$(id).classList.add('show');pushH('fp');}function closeFP(id){$(id).classList.remove('show');}
function openPopup(id){$(id).classList.add('show');}function closePopup(id){$(id).classList.remove('show');}
function ss(el,i){document.querySelectorAll('.snv .sbb').forEach(b=>b.classList.remove('a'));el.classList.add('a');document.querySelectorAll('#p-sys .sp').forEach((p,j)=>p.classList.toggle('a',j===i));_sysTab=i;}let _sysTab=0;
function setTh(c){document.body.className=c;syncThemeDots();_settings.theme=c||'default';saveSettingsObj(_settings);}
function syncThemeDots(){document.querySelectorAll('.theme-dot').forEach(d=>d.classList.toggle('active',(d.dataset.theme||'')===document.body.className));}
function showCtx(x,y,items){const m=$('ctx-menu');m.innerHTML=items.map(i=>'<div class="ctx-item" onclick="'+i.action+'">'+i.label+'</div>').join('');m.style.left=Math.min(x,innerWidth-160)+'px';m.style.top=Math.min(y,innerHeight-200)+'px';m.classList.remove('hidden');}
function hideCtx(){$('ctx-menu').classList.add('hidden');}
function bindLongPress(el,fn){let t=null,mv=false;el.addEventListener('touchstart',e=>{mv=false;t=setTimeout(()=>{if(!mv){e.preventDefault();fn(e.touches[0].clientX,e.touches[0].clientY);}},500);},{passive:false});el.addEventListener('touchmove',()=>{mv=true;clearTimeout(t);});el.addEventListener('touchend',()=>clearTimeout(t));el.addEventListener('contextmenu',e=>{e.preventDefault();fn(e.clientX,e.clientY);});}

// === Avatar Upload ===
let _avTarget=null,_avUrl=null,_charAvOx=0,_charAvOy=0,_pfAvUrl=null,_pfAvOx=0,_pfAvOy=0;
function startAvUp(type,id){_avTarget={type,id:id||null};$('av-input').click();}
let _cropFile=null,_cropScale=1,_cropX=0,_cropY=0,_cropDragging=false,_cropStartX=0,_cropStartY=0,_cropOrigX=0,_cropOrigY=0;
function onAvUpload(inp){if(!inp.files[0]||!_avTarget)return;_cropFile=inp.files[0];inp.value='';openCrop();}
function openCrop(){const ov=$('crop-ov'),area=$('crop-area'),img=$('crop-img'),frame=$('crop-frame');
const url=URL.createObjectURL(_cropFile);img.onload=()=>{
const maxW=Math.min(innerWidth-32,400),maxH=Math.min(innerHeight-120,400);
const iw=img.naturalWidth,ih=img.naturalHeight;const scale=Math.min(maxW/iw,maxH/ih,1);
const dw=Math.round(iw*scale),dh=Math.round(ih*scale);
area.style.width=dw+'px';area.style.height=dh+'px';
img.style.width=dw+'px';img.style.height=dh+'px';img.style.left='0px';img.style.top='0px';
const fw=Math.min(dw,dh)*0.7;const fh=Math.round(fw*1.25);frame.style.width=fw+'px';frame.style.height=fh+'px';frame.style.left=Math.round((dw-fw)/2)+'px';frame.style.top=Math.round((dh-fh)/2)+'px';
const circle=$('crop-circle');circle.style.width=fw+'px';circle.style.height=fw+'px';
_cropScale=scale;_cropX=0;_cropY=0;
area.onmousedown=area.ontouchstart=e=>{e.preventDefault();const t=e.touches?e.touches[0]:e;_cropDragging=true;_cropStartX=t.clientX;_cropStartY=t.clientY;_cropOrigX=parseInt(img.style.left);_cropOrigY=parseInt(img.style.top);};
document.onmousemove=document.ontouchmove=e=>{if(!_cropDragging)return;const t=e.touches?e.touches[0]:e;img.style.left=(_cropOrigX+(t.clientX-_cropStartX))+'px';img.style.top=(_cropOrigY+(t.clientY-_cropStartY))+'px';};
document.onmouseup=document.ontouchend=()=>{_cropDragging=false;};
ov.classList.add('show');};img.src=url;}
function closeCrop(){$('crop-ov').classList.remove('show');_cropFile=null;document.onmousemove=document.ontouchmove=document.onmouseup=document.ontouchend=null;}
async function confirmCrop(){const img=$('crop-img'),frame=$('crop-frame'),area=$('crop-area');
const fx=parseInt(frame.style.left),fy=parseInt(frame.style.top),fw=parseInt(frame.style.width),fh=parseInt(frame.style.height);
const ix=parseInt(img.style.left),iy=parseInt(img.style.top);
const sx=(fx-ix)/_cropScale,sy=(fy-iy)/_cropScale,sw=fw/_cropScale,sh=fh/_cropScale;
const canvas=document.createElement('canvas');canvas.width=360;canvas.height=Math.round(360*(fh/fw));
const ctx=canvas.getContext('2d');const srcImg=new Image();srcImg.onload=async()=>{ctx.drawImage(srcImg,sx,sy,sw,sh,0,0,canvas.width,canvas.height);
const dataUrl=canvas.toDataURL('image/webp',0.85);
const id=_avTarget.id||$('ce-id').value,key=_avTarget.type+'_'+id;
await dbPut('avatars',{id:key,blob:dataUrl,type:'image/webp',ts:Date.now()});
if(_avTarget.type==='char'){const c=await dbGet('characters',id);if(c){c.avatar_url=dataUrl;await dbPut('characters',c);}_avUrl=dataUrl;renderAvEd('char',dataUrl,0,0);}
else{const p=await dbGet('profiles',id);if(p){p.avatar_url=dataUrl;await dbPut('profiles',p);}_pfAvUrl=dataUrl;renderAvEd('pf',dataUrl,0,0);}
toast('已儲存');closeCrop();loadChars();};srcImg.src=URL.createObjectURL(_cropFile);}
function renderAvEd(type,url,ox,oy){const wrap=$(type==='char'?'ce-av-wrap':'pf-av-wrap');if(url)wrap.innerHTML='<img src="'+url+'" style="object-position:'+(50+(ox||0))+'% '+(50+(oy||0))+'%">';else wrap.innerHTML=esc('?');}
let _avOffCache={};function loadAvOff(){_avOffCache=JSON.parse(localStorage.getItem('rp_av_off')||'{}');}function saveAvOff(key,ox,oy){_avOffCache[key]={ox,oy};localStorage.setItem('rp_av_off',JSON.stringify(_avOffCache));}function getAvOff(key){return _avOffCache[key]||{ox:0,oy:0};}
function pickGen(el,v){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$('ce-gen').childNodes[0].textContent=v;closePopup('gen-pop');}
function pickSel(hid,val,label,el,popId){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$(hid).value=val;const btn=$(hid+'-btn');if(btn)btn.childNodes[0].textContent=label;closePopup(popId);}
// ═══ Universal Long-Press Drag System ═══
let _dragState=null;
function initLPDrag(container,selector,onSave){
  let timer=null,dragging=false,dragEl=null,ghost=null,oy=0,startY=0,scrollParent=null;
  function getScrollParent(el){let p=el.parentElement;while(p){if(p.scrollHeight>p.clientHeight&&getComputedStyle(p).overflowY!=='visible')return p;p=p.parentElement;}return null;}
  function startDrag(el,y){
    dragging=true;dragEl=el;startY=y;
    const r=el.getBoundingClientRect();oy=y-r.top;
    scrollParent=getScrollParent(container);
    ghost=el.cloneNode(true);ghost.style.cssText='position:fixed;top:'+r.top+'px;left:'+r.left+'px;width:'+r.width+'px;z-index:9999;pointer-events:none;opacity:.85;transform:scale(1.03);box-shadow:0 8px 28px rgba(0,0,0,.2);border-radius:12px;background:var(--bg2);border:2px solid var(--ac);transition:none;';
    document.body.appendChild(ghost);
    el.style.cssText='opacity:.2;transition:none;';
    if(navigator.vibrate)navigator.vibrate(30);
  }
  function doMove(y){
    if(!dragEl||!ghost)return;
    ghost.style.top=(y-oy)+'px';
    // Auto scroll
    if(scrollParent){const sr=scrollParent.getBoundingClientRect();if(y<sr.top+40)scrollParent.scrollTop-=6;else if(y>sr.bottom-40)scrollParent.scrollTop+=6;}
    const items=[...container.querySelectorAll(selector)];
    for(const it of items){if(it===dragEl)continue;const r=it.getBoundingClientRect();
      if(y>r.top&&y<r.bottom){if(y<r.top+r.height/2)container.insertBefore(dragEl,it);else container.insertBefore(dragEl,it.nextSibling);break;}}
  }
  function endDrag(){
    if(ghost){ghost.remove();ghost=null;}
    if(dragEl)dragEl.style.cssText='';
    dragging=false;dragEl=null;timer=null;scrollParent=null;
    if(onSave)onSave(container);
  }
  container.addEventListener('touchstart',e=>{
    const el=e.target.closest(selector);if(!el||e.target.closest('.tog,.btn'))return;
    startY=e.touches[0].clientY;
    timer=setTimeout(()=>{startDrag(el,e.touches[0].clientY);},350);
  },{passive:true});
  container.addEventListener('touchmove',e=>{
    const y=e.touches[0].clientY;
    if(!dragging){if(Math.abs(y-startY)>8){clearTimeout(timer);timer=null;}return;}
    e.preventDefault();doMove(y);
  },{passive:false});
  container.addEventListener('touchend',()=>{if(timer){clearTimeout(timer);timer=null;}if(dragging)endDrag();});
  container.addEventListener('touchcancel',()=>{if(timer){clearTimeout(timer);timer=null;}if(dragging)endDrag();});
}
// Drag-save helpers (IndexedDB)
async function saveCharOrder(c){const items=c.querySelectorAll('.li[data-charid]');const nc=[];for(let i=0;i<items.length;i++){const id=items[i].dataset.charid,ch=chars.find(x=>x.id===id);if(ch){nc.push(ch);ch.sort_order=i;const o=await dbGet('characters',id);if(o){o.sort_order=i;await dbPut('characters',o);}}}chars=nc;}
async function savePfOrder(c){const items=c.querySelectorAll('.li[data-pfid]');const np=[];for(let i=0;i<items.length;i++){const id=items[i].dataset.pfid,p=profiles.find(x=>x.id===id);if(p){np.push(p);const o=await dbGet('profiles',id);if(o){o.sort_order=i;await dbPut('profiles',o);}}}profiles=np;}
async function savePromptOrder(c){const items=c.querySelectorAll('.pi[data-prid]');const np=[];for(let i=0;i<items.length;i++){const id=items[i].getAttribute('data-prid'),p=prompts.find(x=>x.id===id);if(p){np.push(p);const o=await dbGet('prompts',id);if(o){o.sort_order=i;await dbPut('prompts',o);}}}prompts=np;}
async function saveEvOrder(c,store,attr){const items=c.querySelectorAll('.ev-toggle-item['+attr+']');for(let i=0;i<items.length;i++){const id=items[i].getAttribute(attr);const o=await dbGet(store,id);if(o){o.sort_order=i;await dbPut(store,o);}}}
async function savePcmdOrder(c){const items=c.querySelectorAll('.ev-toggle-item[data-pcid]');const np=[];for(let i=0;i<items.length;i++){const id=items[i].getAttribute('data-pcid'),p=_pcmds.find(x=>x.id===id);if(p){np.push(p);const o=await dbGet('persistent_commands',id);if(o){o.sort_order=i;await dbPut('persistent_commands',o);}}}_pcmds=np;}
// Convenience wrappers
function initDrag(container){initLPDrag(container,'.card',null);}
function initEvDrag(container,store,attr){initLPDrag(container,'.ev-toggle-item',c=>saveEvOrder(c,store,attr||'data-evid'));}
function initCharDrag(container){initLPDrag(container,'.li[data-charid]',saveCharOrder);}
function initPfDrag(container){initLPDrag(container,'.li[data-pfid]',savePfOrder);}
function initPromptDrag(container){initLPDrag(container,'.pi[data-prid]',savePromptOrder);}
function initPcmdDrag(container){initLPDrag(container,'.ev-toggle-item[data-pcid]',savePcmdOrder);}
// === CHARACTERS ===
let chars=[],_charDataCache=null;
async function getCharData(cid){if(_charDataCache&&_charDataCache.charId===cid)return _charDataCache;const[c,extras,cEvs]=await Promise.all([dbGet('characters',cid),dbByIndex('character_extras','character_id',cid),dbByIndex('character_events','character_id',cid)]);_charDataCache={charId:cid,char:c,extras:sortBy(extras,'sort_order'),events:sortBy(cEvs,'sort_order')};return _charDataCache;}
async function loadChars(){chars=sortBy(await dbAll('characters'),'sort_order');renderCL();}
function renderCL(){const el=$('char-list');if(!chars.length){el.innerHTML='<div class="empty">尚未建立角色</div>';return;}el.innerHTML=chars.map(c=>{const ao=getAvOff('char_'+c.id);return '<div class="li" data-charid="'+c.id+'">'+avH(c.avatar_url,c.name,72,ao.ox,ao.oy).replace('class="av"','class="av av-list"')+'<div class="lb"><div class="lt">'+esc(c.name)+'</div></div><div class="li-actions"><div class="li-act" onclick="event.stopPropagation();editChar(\''+c.id+'\')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>編輯</div><div class="li-act" onclick="event.stopPropagation();openCEvs(\''+c.id+'\',\''+esc(c.name)+'\')"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>事件</div></div></div>';}).join('');initCharDrag(el);}
async function createChar(){const c={id:uid(),name:'新角色',sort_order:chars.length,created_at:new Date().toISOString()};await dbPut('characters',c);toast('已新增');await loadChars();openCEditUI(c,[]);}
async function editChar(id){const c=await dbGet('characters',id);let extras=[];try{extras=await dbByIndex('character_extras','character_id',id);console.log('editChar extras for',id,':',extras.length,'items',extras);}catch(e){console.error('dbByIndex extras failed, falling back to scan:',e);const all=await dbAll('character_extras');extras=all.filter(x=>x.character_id===id);console.log('Fallback found:',extras.length);}openCEditUI(c,sortBy(extras,'sort_order'));}
function openCEditUI(c,extras){_avUrl=c.avatar_url||null;const ao=getAvOff('char_'+c.id);_charAvOx=ao.ox;_charAvOy=ao.oy;$('vl').style.display='none';$('vd').style.display='block';hideNav();pushH('charDetail');$('ce-id').value=c.id;$('ce-name').value=c.name||'';$('ce-age').value=c.age||'';$('ce-job').value=c.job||'';$('ce-gen').childNodes[0].textContent=c.gender||'未設置';$('ce-set').value=c.setting||'';$('ce-scn').value=c.greeting_scenario||'';$('ce-grt').value=c.greeting_message||'';renderAvEd('char',_avUrl,_charAvOx,_charAvOy);$('ce-av-wrap').onclick=()=>startAvUp('char',c.id);cntF($('ce-set'));cntF($('ce-scn'));cntF($('ce-grt'));const el=$('ce-ex');el.innerHTML='';extras.forEach(ex=>addExUI(ex));initDrag(el);}
function addExUI(ex){ex=ex||{};const el=$('ce-ex'),n=el.children.length+1,d=document.createElement('div');d.className='card';d.style.marginBottom='8px';d.dataset.exId=ex.id||'';d.innerHTML='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><span class="drag-h">⠿</span><div class="f" style="margin:0;flex:1;"><label>#'+n+'</label><input type="text" value="'+esc(ex.title||'')+'" placeholder="標題"></div><button class="btn bs2" style="color:#c0705a;border:0;" onclick="rmEx(this)">✕</button></div><div class="f" style="margin:0;"><textarea rows="10" oninput="cntF(this)" placeholder="內容">'+esc(ex.content||'')+'</textarea><div class="ctr">0 字 · ≈ 0 tokens</div></div>';el.appendChild(d);const ta=d.querySelector('textarea');if(ta&&ta.value)cntF(ta);}
async function rmEx(btn){const c=btn.closest('.card'),eid=c.dataset.exId;if(!await cfm('確定刪除？'))return;if(eid)await dbDel('character_extras',eid);c.remove();}
async function saveChar(){const id=$('ce-id').value;const c=await dbGet('characters',id)||{id};Object.assign(c,{name:$('ce-name').value.trim()||'未命名',age:parseInt($('ce-age').value)||null,gender:$('ce-gen').textContent.trim(),job:$('ce-job').value.trim()||null,setting:$('ce-set').value,greeting_scenario:$('ce-scn').value,greeting_message:$('ce-grt').value});await dbPut('characters',c);saveAvOff('char_'+id,_charAvOx,_charAvOy);
const cards=$('ce-ex').querySelectorAll('.card');
for(let i=0;i<cards.length;i++){const cd=cards[i],eid=cd.dataset.exId,ti=cd.querySelector('input[type="text"]').value,co=cd.querySelector('textarea').value;if(eid){const ex=await dbGet('character_extras',eid)||{id:eid};Object.assign(ex,{character_id:id,title:ti,content:co,sort_order:i});await dbPut('character_extras',ex);embedAndPatch('character_extras',eid,ti+' '+co);}else{const nid=uid();cd.dataset.exId=nid;await dbPut('character_extras',{id:nid,character_id:id,title:ti,content:co,sort_order:i});embedAndPatch('character_extras',nid,ti+' '+co);}}
toast('已儲存');loadChars();_charDataCache=null;}
async function delChar(){if(!await cfm('確定刪除？'))return;const id=$('ce-id').value;await dbDel('characters',id);for(const x of await dbByIndex('character_extras','character_id',id))await dbDel('character_extras',x.id);for(const x of await dbByIndex('character_events','character_id',id))await dbDel('character_events',x.id);toast('已刪除');closeCharEdit();await loadChars();_charDataCache=null;}
function closeCharEdit(q){$('vl').style.display='block';$('vd').style.display='none';_avUrl=null;if(!q)showNav();}

// === Character Events ===
let _cevCid=null;
async function openCEvs(cid,name){_cevCid=cid;$('cev-t').textContent=(name||'')+' 預設事件';let evs=[];try{evs=sortBy(await dbByIndex('character_events','character_id',cid),'sort_order');}catch(e){console.error('openCEvs index fail, fallback:',e);evs=sortBy((await dbAll('character_events')).filter(x=>x.character_id===cid),'sort_order');}const b=$('cev-body');b.innerHTML='';if(!evs.length){b.innerHTML='<div class="empty">尚未建立</div>';openFP('fp-cev');return;}evs.forEach(ev=>{b.innerHTML+='<div class="ev-toggle-item" data-evid="'+ev.id+'"><div class="lb" onclick="openCEvD(\''+ev.id+'\')"><div class="lt">'+esc(ev.name)+'</div><div class="ls">'+esc(ev.time_or_keyword||'')+' · '+(ev.content||'').length+' 字</div></div></div>';});initEvDrag(b,'character_events','data-evid');openFP('fp-cev');}
function newCEv(){$('ev-id').value='';$('ev-n').value='';$('ev-t').value='';$('ev-c').value='';openFP('fp-cev-d');}
async function openCEvD(id){const ev=await dbGet('character_events',id);$('ev-id').value=ev.id;$('ev-n').value=ev.name;$('ev-t').value=ev.time_or_keyword||'';$('ev-c').value=ev.content||'';cntF($('ev-c'));openFP('fp-cev-d');}
async function saveCEv(){const eid=$('ev-id').value,data={character_id:_cevCid,name:$('ev-n').value.trim()||'未命名',time_or_keyword:$('ev-t').value,content:$('ev-c').value};if(eid){const ev=await dbGet('character_events',eid)||{id:eid};Object.assign(ev,data);await dbPut('character_events',ev);embedAndPatch('character_events',eid,data.name+' '+data.time_or_keyword+' '+data.content);}else{data.id=uid();const existing=await dbByIndex('character_events','character_id',_cevCid);data.sort_order=existing.length;await dbPut('character_events',data);embedAndPatch('character_events',data.id,data.name+' '+data.time_or_keyword+' '+data.content);}toast('已儲存');closeFP('fp-cev-d');closeFP('fp-cev');openCEvs(_cevCid);_charDataCache=null;}
async function delCEv(){const eid=$('ev-id').value;if(!eid){closeFP('fp-cev-d');return;}if(!await cfm('確定刪除？'))return;await dbDel('character_events',eid);toast('已刪除');closeFP('fp-cev-d');closeFP('fp-cev');openCEvs(_cevCid);_charDataCache=null;}
// === SETTINGS & API CONFIGS ===
let _settings={};let _apiCfgs=[];const SETTINGS_ID='_singleton';
async function saveSettingsObj(obj){obj.id=SETTINGS_ID;_settings=obj;await dbPut('settings',obj);}
async function loadSettings(){const s=await dbGet('settings',SETTINGS_ID);if(s){_settings=s;if(s.temperature!=null){$('set-temp').value=Math.round(s.temperature*100);$('set-temp').nextElementSibling.textContent=s.temperature.toFixed(2);}if(s.max_input_tokens)$('set-maxin').value=s.max_input_tokens;if(s.max_output_tokens)$('set-maxout').value=s.max_output_tokens;if(s.theme&&s.theme!=='default')document.body.className=s.theme;syncThemeDots();}}
function getSettings(){return _settings;}
async function saveSettings(){await saveSettingsObj({...(_settings||{}),id:SETTINGS_ID,temperature:parseFloat((parseInt($('set-temp').value)/100).toFixed(2)),max_input_tokens:parseInt($('set-maxin').value)||128000,max_output_tokens:parseInt($('set-maxout').value)||4096,theme:document.body.className||'default'});toast('已儲存');}
async function saveMemSettings(){await saveSettingsObj({...(_settings||{}),id:SETTINGS_ID,
mem_prompt:$('mem-prompt').value,mem_rule:parseInt($('mem-rule').value)||10,
auto_summary:$('set-sum-auto').classList.contains('on'),summary_interval:parseInt($('set-sum-interval').value)||10,summary_prompt:$('sum-prompt').value,
sum_api_id:$('sum-api-id').value||null,sum_model:$('sum-model-id').value||null,
mem_api_id:$('mem-api-id').value||null,mem_model:$('mem-model-id').value||null,
emb_local:$('set-emb-local').classList.contains('on'),
vec_threshold:parseFloat((parseInt($('set-vec-threshold').value)/100).toFixed(2)),
vec_extras_count:parseInt($('set-vec-extras').value)||3,vec_events_count:parseInt($('set-vec-events').value)||3,vec_memories_count:parseInt($('set-vec-memories').value)||5});toast('已儲存');}
async function loadMemRules(){const s=_settings;if(!s)return;
if(s.mem_prompt)$('mem-prompt').value=s.mem_prompt;if(s.mem_rule)$('mem-rule').value=s.mem_rule;
if(s.summary_prompt)$('sum-prompt').value=s.summary_prompt;if(s.auto_summary)$('set-sum-auto').classList.add('on');if(s.summary_interval)$('set-sum-interval').value=s.summary_interval;
if(s.emb_local)$('set-emb-local').classList.add('on');
if(s.sum_api_id){$('sum-api-id').value=s.sum_api_id;const a=_apiCfgs.find(x=>x.id===s.sum_api_id);$('sum-api-btn').childNodes[0].textContent=a?a.name:'未選擇';}
if(s.sum_model){$('sum-model-id').value=s.sum_model;$('sum-model-btn').childNodes[0].textContent=s.sum_model;}
if(s.mem_api_id){$('mem-api-id').value=s.mem_api_id;const a=_apiCfgs.find(x=>x.id===s.mem_api_id);$('mem-api-btn').childNodes[0].textContent=a?a.name:'未選擇';}
if(s.mem_model){$('mem-model-id').value=s.mem_model;$('mem-model-btn').childNodes[0].textContent=s.mem_model;}
if(s.vec_threshold!=null){$('set-vec-threshold').value=Math.round(s.vec_threshold*100);$('set-vec-threshold').nextElementSibling.textContent=s.vec_threshold.toFixed(2);}
if(s.vec_extras_count)$('set-vec-extras').value=s.vec_extras_count;if(s.vec_events_count)$('set-vec-events').value=s.vec_events_count;if(s.vec_memories_count)$('set-vec-memories').value=s.vec_memories_count;
['sum','mem'].forEach(p=>{syncFeatureApiPop(p);syncFeatureModelPop(p);});cntF($('sum-prompt'));cntF($('mem-prompt'));}

// API Configs
async function loadApiCfgs(){_apiCfgs=sortBy(await dbAll('api_configs'),'sort_order');renderApiCfgList();syncPrApiPop();['sum','mem'].forEach(p=>{syncFeatureApiPop(p);syncFeatureModelPop(p);});}
function renderApiCfgList(){const el=$('api-cfg-list');if(!_apiCfgs.length){el.innerHTML='<div class="empty" style="font-size:13px;">尚未設定 API</div>';return;}el.innerHTML=_apiCfgs.map(a=>'<div class="ev-toggle-item" onclick="openApiCfgEdit(\''+a.id+'\')"><div class="lb"><div class="lt">'+esc(a.name||'未命名')+'</div><div class="ls">'+esc((a.provider||'').charAt(0).toUpperCase()+(a.provider||'').slice(1))+'</div></div><svg style="width:16px;height:16px;color:var(--tx2);stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>').join('');}
async function addApiCfg(){const r={id:uid(),name:'新 API',provider:'anthropic',api_key:'',sort_order:_apiCfgs.length};await dbPut('api_configs',r);toast('已新增');await loadApiCfgs();openApiCfgEdit(r.id);}
function openApiCfgEdit(id){const a=_apiCfgs.find(x=>x.id===id);if(!a)return;$('acfg-id').value=a.id;$('acfg-name').value=a.name||'';$('acfg-provider').value=a.provider||'anthropic';$('acfg-provider-btn').childNodes[0].textContent=(a.provider||'anthropic').charAt(0).toUpperCase()+(a.provider||'anthropic').slice(1);$('acfg-key').value=a.api_key||'';$('acfg-test-result').style.display='none';openFP('fp-api-cfg');}
async function saveApiCfg(){const id=$('acfg-id').value;const a=await dbGet('api_configs',id)||{id};Object.assign(a,{name:$('acfg-name').value.trim()||'未命名',provider:$('acfg-provider').value,api_key:$('acfg-key').value});await dbPut('api_configs',a);toast('已儲存');await loadApiCfgs();closeFP('fp-api-cfg');}
async function delApiCfg(){if(!await cfm('確定刪除？'))return;await dbDel('api_configs',$('acfg-id').value);toast('已刪除');await loadApiCfgs();closeFP('fp-api-cfg');}
const _models={anthropic:['claude-opus-4-6','claude-opus-4-5-20251101','claude-sonnet-4-6','claude-sonnet-4-5-20250929','claude-sonnet-4-20250514','claude-haiku-4-5-20251001'],openai:['gpt-5','gpt-5-mini','gpt-4.1','gpt-4.1-mini','gpt-4o','gpt-4o-mini','o3','o3-mini','o4-mini'],google:['gemini-3.0-pro','gemini-3.0-flash','gemini-2.5-pro','gemini-2.5-flash','gemini-2.5-flash-lite','gemini-2.0-flash'],openrouter:['anthropic/claude-opus-4-6','anthropic/claude-sonnet-4-6','anthropic/claude-haiku-4-5','openai/gpt-5','openai/gpt-4.1','google/gemini-3.0-pro','google/gemini-2.5-pro','deepseek/deepseek-chat-v3-0324','meta-llama/llama-4-maverick']};
const _providerLabels={anthropic:'Anthropic',openai:'OpenAI',google:'Google',openrouter:'OpenRouter'};
async function testApiConn(){const pv=$('acfg-provider').value,key=$('acfg-key').value,el=$('acfg-test-result');if(!key){el.style.display='block';el.innerHTML='<span style="color:#c0705a;">❌ 請先輸入 API Key</span>';return;}el.style.display='block';el.innerHTML='⏳ 測試中...';try{let resp;if(pv==='anthropic')resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:1,messages:[{role:'user',content:'hi'}]})});else if(pv==='google')resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:'hi'}]}],generationConfig:{maxOutputTokens:1}})});else if(pv==='openrouter')resp=await fetch('https://openrouter.ai/api/v1/models',{headers:{'Authorization':'Bearer '+key}});else resp=await fetch('https://api.openai.com/v1/models',{headers:{'Authorization':'Bearer '+key}});el.innerHTML=resp.ok?'<span style="color:#5a9e6f;">✅ 連線成功</span>':'<span style="color:#c0705a;">❌ 失敗 ('+resp.status+')</span>';}catch(e){el.innerHTML='<span style="color:#c0705a;">❌ '+e.message.substring(0,50)+'</span>';}}

function syncPrApiPop(){const el=$('pr-api-list'),cur=$('pr-api-id').value;el.innerHTML=_apiCfgs.map(a=>'<div class="popup-item'+(cur===a.id?' active':'')+'" onclick="pickPrApi(\''+a.id+'\',\''+esc(a.name)+'\',this)"><span>'+esc(a.name)+' ('+(_providerLabels[a.provider]||a.provider)+')</span><span class="check">✓</span></div>').join('');}
function pickPrApi(id,label,el){$('pr-api-id').value=id;$('pr-api-btn').childNodes[0].textContent=label;el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');closePopup('pr-api-pop');$('pr-model-id').value='';$('pr-model-btn').childNodes[0].textContent='未選擇';syncPrModelPop();}
function syncPrModelPop(){const el=$('pr-model-list'),cur=$('pr-model-id').value,apiId=$('pr-api-id').value,acfg=apiId?_apiCfgs.find(a=>a.id===apiId):_apiCfgs[0],pv=acfg?acfg.provider:'anthropic',ms=_models[pv]||[];el.innerHTML=ms.map(m=>'<div class="popup-item'+(cur===m?' active':'')+'" onclick="pickPrModel(\''+m+'\',this)"><span>'+esc(m)+'</span><span class="check">✓</span></div>').join('')+'<div style="padding:8px 12px;border-top:1px solid var(--bd);"><input type="text" id="pr-model-custom" placeholder="自訂模型..." style="width:100%;padding:6px;border:1px solid var(--bd);border-radius:6px;font-size:13px;font-family:monospace;background:var(--bg);color:var(--tx);" onkeydown="if(event.key===\'Enter\'){pickPrModel(this.value.trim(),null);this.value=\'\';}"></div>';}
function pickPrModel(m,el){if(!m)return;$('pr-model-id').value=m;$('pr-model-btn').childNodes[0].textContent=m;if(el){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}closePopup('pr-model-pop');}
function syncFeatureApiPop(pfx){const el=$(pfx+'-api-list');if(!el)return;const cEl=$(pfx+'-api-id');const cur=cEl?cEl.value:'';el.innerHTML=_apiCfgs.map(a=>'<div class="popup-item'+(cur===a.id?' active':'')+'" onclick="pickFeatureApi(\''+pfx+'\',\''+a.id+'\',\''+esc(a.name)+'\',this)"><span>'+esc(a.name)+' ('+(_providerLabels[a.provider]||a.provider)+')</span><span class="check">✓</span></div>').join('');}
function pickFeatureApi(pfx,id,label,el){const idEl=$(pfx+'-api-id');if(idEl)idEl.value=id;const btn=$(pfx+'-api-btn');if(btn)btn.childNodes[0].textContent=label;el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');closePopup(pfx+'-api-pop');const mEl=$(pfx+'-model-id');if(mEl)mEl.value='';const mBtn=$(pfx+'-model-btn');if(mBtn)mBtn.childNodes[0].textContent='未選擇';syncFeatureModelPop(pfx);}
function syncFeatureModelPop(pfx){const el=$(pfx+'-model-list');if(!el)return;const cEl=$(pfx+'-model-id');const cur=cEl?cEl.value:'';const aEl=$(pfx+'-api-id');const apiId=aEl?aEl.value:'';const acfg=apiId?_apiCfgs.find(a=>a.id===apiId):_apiCfgs[0],pv=acfg?acfg.provider:'anthropic',ms=_models[pv]||[];el.innerHTML=ms.map(m=>'<div class="popup-item'+(cur===m?' active':'')+'" onclick="pickFeatureModel(\''+pfx+'\',\''+m+'\',this)"><span>'+esc(m)+'</span><span class="check">✓</span></div>').join('')+'<div style="padding:8px 12px;border-top:1px solid var(--bd);"><input type="text" placeholder="自訂模型..." style="width:100%;padding:6px;border:1px solid var(--bd);border-radius:6px;font-size:13px;font-family:monospace;background:var(--bg);color:var(--tx);" onkeydown="if(event.key===\'Enter\'){pickFeatureModel(\''+pfx+'\',this.value.trim(),null);this.value=\'\';}"></div>';}
function pickFeatureModel(pfx,m,el){if(!m)return;$(pfx+'-model-id').value=m;$(pfx+'-model-btn').childNodes[0].textContent=m;if(el){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}closePopup(pfx+'-model-pop');}
function getFeatureApiCfg(pfx){const s=getSettings(),apiId=s[pfx+'_api_id']||'',model=s[pfx+'_model']||'',acfg=apiId?_apiCfgs.find(a=>a.id===apiId):_apiCfgs[0];if(!acfg)return null;return{...acfg,model:model||null};}
function getApiCfgForPrompt(rpId){let cfgId=null,model=null;if(rpId){const p=prompts.find(x=>x.id===rpId);if(p){cfgId=p.api_config_id||null;model=p.model||null;}}const acfg=cfgId?_apiCfgs.find(x=>x.id===cfgId):_apiCfgs[0];if(!acfg)return null;return{...acfg,model:model||acfg.model||null};}
// === PROMPTS ===
let prompts=[];
async function loadPr(){prompts=sortBy(await dbAll('prompts'),'sort_order');if(!prompts.length){const p={id:uid(),name:'標準 RP',content:'你是一位專業的角色扮演敘事者。請根據角色設定與場景，以豐富的文學筆觸推進劇情。\n\n## 回覆規則\n- 以第三人稱描寫角色的動作、表情、心理活動\n- 對話使用「」包裹，內心獨白使用（）包裹\n- 每次回覆控制在 200～400 字之間\n- 不要替玩家角色做出決定或說話\n- 適當描寫環境氛圍與感官細節\n- 根據角色的性格與好感度調整互動方式\n\n## 敘事風格\n保持沉浸感，避免跳出角色。如果玩家的行為超出場景邏輯，角色應以符合設定的方式自然回應。',sort_order:0};await dbPut('prompts',p);prompts=[p];}renderPr();syncRpPopup();}
function renderPr(){const pl=$('pl'),curId=$('pe-id').value;pl.innerHTML=prompts.map((p,i)=>'<div class="pi'+(p.id===curId?' sel':(!curId&&i===0?' sel':''))+'" data-prid="'+p.id+'" data-pridx="'+i+'"><div class="pn2" onclick="selPr(this.parentElement,'+i+')">'+esc(p.name)+'</div><div class="ptk">≈ '+tok(p.content)+'</div></div>').join('');const si=curId?prompts.findIndex(p=>p.id===curId):-1;if(si>=0)selPr(pl.children[si],si);else if(prompts.length)selPr(pl.children[0],0);else $('pr-edit').style.display='none';initPromptDrag(pl);}
function selPr(el,i){document.querySelectorAll('.pi').forEach(p=>p.classList.remove('sel'));el.classList.add('sel');$('pe-id').value=prompts[i].id;$('pn').value=prompts[i].name;$('tp2').value=prompts[i].content;$('pr-api-id').value=prompts[i].api_config_id||'';$('pr-model-id').value=prompts[i].model||'';const acfg=prompts[i].api_config_id?_apiCfgs.find(a=>a.id===prompts[i].api_config_id):null;$('pr-api-btn').childNodes[0].textContent=acfg?acfg.name:'未選擇';$('pr-model-btn').childNodes[0].textContent=prompts[i].model||'未選擇';syncPrApiPop();syncPrModelPop();cntF($('tp2'));$('pr-edit').style.display='block';}
async function createPr(){const p={id:uid(),name:'新模式',content:'',sort_order:prompts.length};await dbPut('prompts',p);toast('已新增');await loadPr();selPr($('pl').lastElementChild,prompts.length-1);}
async function savePr(){const id=$('pe-id').value,p=await dbGet('prompts',id)||{id};Object.assign(p,{name:$('pn').value.trim()||'未命名',content:$('tp2').value,api_config_id:$('pr-api-id').value||null,model:$('pr-model-id').value||null});await dbPut('prompts',p);toast('已儲存');await loadPr();}
async function delPr(){if(!await cfm('確定刪除？'))return;await dbDel('prompts',$('pe-id').value);toast('已刪除');$('pr-edit').style.display='none';await loadPr();}
let _chatRpId=null;
function syncRpPopup(){const el=$('rp-list');if(!prompts.length){el.innerHTML='<div style="padding:8px;color:var(--tx2);">請先建立提示詞</div>';return;}el.innerHTML=prompts.map(p=>'<div class="popup-item'+(_chatRpId===p.id?' active':'')+'" onclick="pickRp(\''+p.id+'\',this)"><span>'+esc(p.name)+'</span><span class="check">✓</span></div>').join('');}
function pickRp(id,el){_chatRpId=id;if(_curChat)_curChat.rpId=id;const p=prompts.find(x=>x.id===id);el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$('rp-btn').childNodes[0].textContent=p?p.name:'RP';closePopup('rp-popup');if(_curChatId)saveChatStore();}

// === PROFILES ===
let profiles=[],_pfEditId=null;
async function loadPf(){profiles=sortBy(await dbAll('profiles'),'sort_order');renderPf();}
function renderPf(){const el=$('pf-list');if(!profiles.length){el.innerHTML='<div class="empty">尚未建立</div>';return;}el.innerHTML=profiles.map(p=>'<div class="li" data-pfid="'+p.id+'" onclick="openPfEdit(\''+p.id+'\')">'+avH(p.avatar_url,p.name,72,getAvOff('pf_'+p.id).ox,getAvOff('pf_'+p.id).oy).replace('class="av"','class="av av-list"')+'<div class="lb"><div class="lt">'+esc(p.name)+'</div></div></div>').join('');initPfDrag(el);renderPpPop();}
async function createPf(){const p={id:uid(),name:'新檔案',sort_order:profiles.length};await dbPut('profiles',p);toast('已新增');await loadPf();openPfEdit(p.id);}
function openPfEdit(id){_pfEditId=id;const p=profiles.find(x=>x.id===id);if(!p)return;_pfAvUrl=p.avatar_url||null;const ao=getAvOff('pf_'+id);_pfAvOx=ao.ox;_pfAvOy=ao.oy;$('pf-vl').style.display='none';$('pf-vd').style.display='block';$('pf-edit-id').value=id;$('pf-edit-name').value=p.name||'';$('pf-edit-age').value=p.age||'';$('pf-edit-job').value=p.job||'';$('pf-gen').childNodes[0].textContent=p.gender||'未設置';$('pf-edit-setting').value=p.setting||'';renderAvEd('pf',_pfAvUrl,_pfAvOx,_pfAvOy);$('pf-av-wrap').onclick=()=>startAvUp('profile',id);cntF($('pf-edit-setting'));}
function closePfEdit(){if($('pf-vl'))$('pf-vl').style.display='block';if($('pf-vd'))$('pf-vd').style.display='none';_pfEditId=null;}
async function savePfDetail(){const id=$('pf-edit-id').value,p=await dbGet('profiles',id)||{id};Object.assign(p,{name:$('pf-edit-name').value.trim()||'未命名',age:parseInt($('pf-edit-age').value)||null,gender:$('pf-gen').textContent.trim()||null,job:$('pf-edit-job').value.trim()||null,setting:$('pf-edit-setting').value});await dbPut('profiles',p);saveAvOff('pf_'+id,_pfAvOx,_pfAvOy);toast('已儲存');await loadPf();}
async function delPfDetail(){if(!await cfm('確定刪除？'))return;await dbDel('profiles',_pfEditId);toast('已刪除');closePfEdit();await loadPf();}
let _chatPlayerId=null;
function renderPpPop(){const el=$('pp-list');if(!profiles.length){el.innerHTML='<div style="padding:8px;color:var(--tx2);">尚未建立</div>';return;}el.innerHTML=profiles.map(p=>'<div class="popup-item'+(_chatPlayerId===p.id?' active':'')+'" onclick="pickPlayer(\''+p.id+'\',this)"><div class="av" style="width:28px;height:28px;font-size:12px;">'+(p.avatar_url?'<img src="'+p.avatar_url+'">':esc((p.name||'?')[0]))+'</div><span style="flex:1">'+esc(p.name)+'</span><span class="check">✓</span></div>').join('');}
function pickPlayer(id,el){_chatPlayerId=id;if(_curChat)_curChat.playerId=id;const p=profiles.find(x=>x.id===id);el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');renderSidePlayer();closePopup('pp-pop');if(_curChatId)saveChatStore();}
function renderSidePlayer(){const p=_chatPlayerId?profiles.find(x=>x.id===_chatPlayerId):null;if(p)$('side-player').innerHTML='<div class="av" style="width:28px;height:28px;font-size:12px;">'+(p.avatar_url?'<img src="'+p.avatar_url+'">':esc(p.name[0]))+'</div><span>'+esc(p.name)+'</span><span class="switch-hint">切換 ▸</span>';else $('side-player').innerHTML='<div class="av" style="width:28px;height:28px;font-size:12px;">?</div><span>未選擇</span><span class="switch-hint">切換 ▸</span>';}
function pickPfGen(el,v){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$('pf-gen').childNodes[0].textContent=v;closePopup('pf-gen-pop');}

// === IMPORT / EXPORT ===
function dlJson(data,fn){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));a.download=fn;a.click();URL.revokeObjectURL(a.href);}
async function exportAll(){toast('匯出中...');try{const strip=arr=>(arr||[]).map(x=>{const c={...x};delete c.embedding;return c;});const data={_type:'rp_studio_backup',_version:2,_storage:'local',_date:new Date().toISOString(),characters:strip(await dbAll('characters')),character_extras:strip(await dbAll('character_extras')),character_events:strip(await dbAll('character_events')),profiles:await dbAll('profiles'),prompts:await dbAll('prompts'),api_configs:await dbAll('api_configs'),settings:[_settings],persistent_commands:await dbAll('persistent_commands'),chats:await dbAll('chats'),messages:await dbAll('messages'),chat_events:await dbAll('chat_events'),memories:strip(await dbAll('memories'))};dlJson(data,'rp-backup-'+new Date().toISOString().slice(0,10)+'.json');toast('✅ 已匯出');}catch(e){toast('失敗: '+e.message.substring(0,50));}}
async function exportChars(){toast('匯出中...');try{dlJson({_type:'rp_studio_characters',_version:2,_date:new Date().toISOString(),characters:await dbAll('characters'),character_extras:await dbAll('character_extras'),character_events:await dbAll('character_events')},'rp-chars-'+new Date().toISOString().slice(0,10)+'.json');toast('✅ 已匯出');}catch(e){toast('失敗');}}
// exportCardV2 defined above with import functions
async function exportChats(){toast('下一段交付');}
async function importFile(inp){if(!inp.files[0])return;try{const file=inp.files[0],name=file.name.toLowerCase();
// Handle PNG with embedded card data
if(name.endsWith('.png')){await importCardPng(file);inp.value='';return;}
const text=await file.text();const data=JSON.parse(text);inp.value='';
// Detect format
if(data._type){if(!await cfm('確定匯入 Reverie 備份？相同 ID 會被覆蓋。'))return;toast('匯入中...');await importReverie(data);}
else if(data.spec==='chara_card_v2'||data.spec==='chara_card_v3'){if(!await cfm('匯入 Character Card V2？'))return;toast('匯入中...');await importSTCard(data.data||data);}
else if(data.name&&(data.description||data.first_mes||data.personality)){if(!await cfm('匯入 Character Card V1？'))return;toast('匯入中...');await importSTCard(data);}
else{toast('無法辨識格式');return;}
await initApp();}catch(e){toast('失敗: '+e.message.substring(0,60));}}

async function importReverie(data){let total=0;const up=async(s,rows)=>{if(!rows||!rows.length)return 0;for(const r of rows){const c={...r};delete c.embedding;await dbPut(s,c);}return rows.length;};
if(data.characters)total+=await up('characters',data.characters);if(data.character_extras)total+=await up('character_extras',data.character_extras);if(data.character_events)total+=await up('character_events',data.character_events);if(data.profiles)total+=await up('profiles',data.profiles);if(data.prompts)total+=await up('prompts',data.prompts);if(data.api_configs)total+=await up('api_configs',data.api_configs);if(data.settings&&data.settings[0]){data.settings[0].id=SETTINGS_ID;await dbPut('settings',data.settings[0]);total++;}if(data.persistent_commands)total+=await up('persistent_commands',data.persistent_commands);if(data.chats)total+=await up('chats',data.chats);if(data.messages)total+=await up('messages',data.messages);if(data.chat_events)total+=await up('chat_events',data.chat_events);if(data.memories)total+=await up('memories',data.memories);
toast('✅ '+total+' 筆');}

async function importSTCard(d){const cid=uid();const c={id:cid,name:d.name||'未命名',sort_order:chars.length,created_at:new Date().toISOString()};
let setting='';if(d.description)setting+=d.description+'\n';if(d.personality)setting+='\n個性: '+d.personality+'\n';
c.setting=setting.trim();c.greeting_scenario=d.scenario||'';c.greeting_message=d.first_mes||'';
await dbPut('characters',c);let exCount=0;
// mes_example → extras
if(d.mes_example&&d.mes_example.trim()){await dbPut('character_extras',{id:uid(),character_id:cid,title:'對話範例',content:d.mes_example.trim(),sort_order:exCount++});}
// creator_notes → extras
if(d.creator_notes&&d.creator_notes.trim()){await dbPut('character_extras',{id:uid(),character_id:cid,title:'創作者筆記',content:d.creator_notes.trim(),sort_order:exCount++});}
// system_prompt → extras
if(d.system_prompt&&d.system_prompt.trim()){await dbPut('character_extras',{id:uid(),character_id:cid,title:'系統提示詞',content:d.system_prompt.trim(),sort_order:exCount++});}
// post_history_instructions → extras
if(d.post_history_instructions&&d.post_history_instructions.trim()){await dbPut('character_extras',{id:uid(),character_id:cid,title:'歷史後指令',content:d.post_history_instructions.trim(),sort_order:exCount++});}
// character_book entries → events
if(d.character_book&&d.character_book.entries){const entries=d.character_book.entries;for(let i=0;i<entries.length;i++){const e=entries[i];await dbPut('character_events',{id:uid(),character_id:cid,name:e.comment||e.name||('世界書 #'+(i+1)),time_or_keyword:(e.keys||[]).join(', '),content:e.content||'',sort_order:i});}}
// extensions.depth_prompt → extras
if(d.extensions){if(d.extensions.depth_prompt&&d.extensions.depth_prompt.prompt){await dbPut('character_extras',{id:uid(),character_id:cid,title:'深度提示詞',content:d.extensions.depth_prompt.prompt,sort_order:exCount++});}}
toast('✅ 已匯入「'+c.name+'」');}

async function importCardPng(file){try{const buf=await file.arrayBuffer();const bytes=new Uint8Array(buf);
// Read PNG chunks to find tEXt with 'chara'
let pos=8;while(pos<bytes.length){const len=(bytes[pos]<<24|bytes[pos+1]<<16|bytes[pos+2]<<8|bytes[pos+3])>>>0;const type=String.fromCharCode(bytes[pos+4],bytes[pos+5],bytes[pos+6],bytes[pos+7]);
if(type==='tEXt'||type==='iTXt'){const chunk=bytes.slice(pos+8,pos+8+len);const sep=chunk.indexOf(0);const key=new TextDecoder().decode(chunk.slice(0,sep));
if(key==='chara'){let val;if(type==='iTXt'){let o=sep+1;o+=1;o=chunk.indexOf(0,o)+1;o=chunk.indexOf(0,o)+1;val=new TextDecoder().decode(chunk.slice(o));}else{val=new TextDecoder().decode(chunk.slice(sep+1));}
const json=JSON.parse(atob(val));if(!await cfm('匯入「'+(json.data?.name||json.name||'角色')+'」？'))return;toast('匯入中...');await importSTCard(json.data||json);await initApp();return;}}
pos+=12+len;}toast('PNG 中未找到角色資料');}catch(e){toast('PNG 解析失敗');}}

async function exportCardV2(){if(!chars.length){toast('沒有角色');return;}
const c=chars[0];const id=c.id;const extras=await dbByIndex('character_extras','character_id',id);const events=await dbByIndex('character_events','character_id',id);
const card={spec:'chara_card_v2',spec_version:'2.0',data:{name:c.name||'',description:c.setting||'',personality:'',scenario:c.greeting_scenario||'',first_mes:c.greeting_message||'',mes_example:extras.find(e=>e.title==='對話範例')?.content||'',creator_notes:extras.find(e=>e.title==='創作者筆記')?.content||'',system_prompt:extras.find(e=>e.title==='系統提示詞')?.content||'',post_history_instructions:extras.find(e=>e.title==='歷史後指令')?.content||'',tags:[],creator:'Reverie RP Studio',character_version:'1.0',extensions:{},character_book:{entries:events.map((ev,i)=>({keys:(ev.time_or_keyword||'').split(',').map(k=>k.trim()).filter(k=>k),content:ev.content||'',comment:ev.name||'',enabled:true,insertion_order:i,position:'after_char'}))}}};
if(chars.length>1){const sel=await inp('輸入角色名稱匯出',c.name);if(sel===null)return;const tc=chars.find(x=>x.name===sel);if(tc&&tc.id!==id){const tex=await dbByIndex('character_extras','character_id',tc.id);const tev=await dbByIndex('character_events','character_id',tc.id);card.data.name=tc.name;card.data.description=tc.setting||'';card.data.scenario=tc.greeting_scenario||'';card.data.first_mes=tc.greeting_message||'';card.data.mes_example=tex.find(e=>e.title==='對話範例')?.content||'';card.data.character_book.entries=tev.map((ev,i)=>({keys:(ev.time_or_keyword||'').split(',').map(k=>k.trim()).filter(k=>k),content:ev.content||'',comment:ev.name||'',enabled:true,insertion_order:i,position:'after_char'}));}}
dlJson(card,(card.data.name||'character')+'-card-v2.json');toast('✅ 已匯出');}

// === STUBS (Chat system — next delivery) ===

// === INIT ===
(async()=>{
  history.replaceState({p:'main'},'');
  try{await openDB();await initApp();}catch(e){console.error('Init:',e);}
  const sp=$('splash');if(sp){sp.classList.add('hide');setTimeout(()=>sp.remove(),400);}
  document.addEventListener('click',hideCtx);
})();
async function initApp(){
  await loadApiCfgs().catch(e=>console.warn('loadApiCfgs',e));
  await Promise.all([
    loadSettings().catch(e=>console.warn('loadSettings',e)),
    loadChars().catch(e=>console.warn('loadChars',e)),
    loadPr().catch(e=>console.warn('loadPr',e)),
    loadPf().catch(e=>console.warn('loadPf',e)),
    loadPcmds().catch(e=>console.warn('loadPcmds',e))
  ]);
  await loadChatIndex().catch(e=>console.warn('loadChatIndex',e));
  try{loadAvOff();}catch(e){}
  try{loadMemRules();}catch(e){}
  try{renderChatList();}catch(e){console.warn('renderChatList',e);}
}
// ═══ CHAT SYSTEM (IndexedDB) ═══
let _chatStore={},_curChatId=null,_curChat=null;
async function loadChatIndex(){const rows=sortBy(await dbAll('chats'),'updated_at','desc');_chatStore={};rows.forEach(r=>{_chatStore[r.id]={charId:r.char_id,charName:r.char_name||'',windowName:r.window_name||'',avatarUrl:r.avatar_url||'',rpId:r.rp_id,playerId:r.player_id,pinned:r.pinned||false,draft:r.draft||'',summary:r.summary||'',pcmdToggles:r.pcmd_toggles||{},updated:r.updated_at||0,msgs:null};});}
async function loadChatMsgs(chatId){const rows=sortBy(await dbByIndex('messages','chat_id',chatId),'sort_order');return rows.map(r=>({role:r.role,name:r.name||'',content:r.content||'',time:r.time||'',avUrl:r.av_url||''}));}
async function saveChatMeta(){if(!_curChatId||!_curChat)return;_chatStore[_curChatId]=_curChat;await dbPut('chats',{id:_curChatId,char_id:_curChat.charId,char_name:_curChat.charName,window_name:_curChat.windowName||'',avatar_url:_curChat.avatarUrl||'',rp_id:_curChat.rpId||null,player_id:_curChat.playerId||null,pinned:_curChat.pinned||false,draft:_curChat.draft||'',summary:_curChat.summary||'',pcmd_toggles:_curChat.pcmdToggles||{},updated_at:new Date(_curChat.updated||Date.now()).toISOString()});}
async function saveMsg(chatId,msg,idx){await dbPut('messages',{id:uid(),chat_id:chatId,role:msg.role,name:msg.name||'',content:msg.content||'',time:msg.time||'',av_url:msg.avUrl||'',sort_order:idx});}
function saveChatStore(){saveChatMeta().catch(e=>console.error(e));}
function touchChatTime(){if(_curChat)_curChat.updated=Date.now();}
function openNewChatPicker(){if(!chars||!chars.length){toast('請先建立角色');return;}$('newchat-list').innerHTML=chars.map(c=>{const ao=getAvOff('char_'+c.id);return '<div class="popup-item" onclick="startNewChat(\''+c.id+'\')" style="gap:10px;">'+avH(c.avatar_url,c.name,36,ao.ox,ao.oy)+'<span style="flex:1">'+esc(c.name)+'</span></div>';}).join('');openPopup('newchat-pop');}
let _pendingChatCharId=null;
async function startNewChat(cid){closePopup('newchat-pop');_pendingChatCharId=cid;
const pfEl=$('setup-pf-list');
if(!profiles.length)pfEl.innerHTML='<div style="padding:6px;color:var(--tx2);font-size:13px;">尚未建立檔案</div>';
else pfEl.innerHTML=profiles.map(p=>'<div class="popup-item" onclick="pickSetupPf(\''+p.id+'\',this)"><div class="av" style="width:28px;height:28px;font-size:12px;">'+(p.avatar_url?'<img src="'+p.avatar_url+'">':esc((p.name||'?')[0]))+'</div><span style="flex:1">'+esc(p.name)+'</span><span class="check">✓</span></div>').join('');
const rpEl=$('setup-rp-list');
if(!prompts.length)rpEl.innerHTML='<div style="padding:6px;color:var(--tx2);font-size:13px;">尚未建立模式</div>';
else rpEl.innerHTML=prompts.map((p,i)=>'<div class="popup-item'+(i===0?' active':'')+'" onclick="pickSetupRp(\''+p.id+'\',this)"><span>'+esc(p.name)+'</span><span class="check">✓</span></div>').join('');
_chatPlayerId=null;_chatRpId=prompts.length?prompts[0].id:null;openPopup('chat-setup-pop');}
function pickSetupPf(id,el){_chatPlayerId=id;el.closest('#setup-pf-list').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}
function pickSetupRp(id,el){_chatRpId=id;el.closest('#setup-rp-list').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}
async function confirmChatSetup(){closePopup('chat-setup-pop');const cid=_pendingChatCharId;if(!cid)return;const c=chars.find(x=>x.id===cid);if(!c){toast('角色不存在');return;}
const id='chat_'+Date.now();_curChatId=id;_curChat={charId:cid,charName:c.name,windowName:c.name,avatarUrl:c.avatar_url||'',msgs:[],memories:[],rpId:_chatRpId,playerId:_chatPlayerId,pinned:false,updated:Date.now()};
if(_chatRpId){const p=prompts.find(x=>x.id===_chatRpId);if(p)$('rp-btn').childNodes[0].textContent=p.name;syncRpPopup();}
_chatStore[id]=_curChat;await saveChatMeta();$('c-name').textContent=c.name;$('c-msgs').innerHTML='';renderSidePlayer();openChat(c.name);
if(c.greeting_scenario)await appendMsgAwait('system','場景',c.greeting_scenario);
if(c.greeting_message)await appendMsgAwait('ai',c.name,c.greeting_message,c.avatar_url);
if(!c.greeting_scenario&&!c.greeting_message)await appendMsgAwait('system','系統','對話已開始');
renderChatList();_pendingChatCharId=null;}
function tplReplace(text){if(!text||!_curChat)return text||'';let s=text;const cn=_curChat.charName||'';let un='';if(_curChat.playerId){const pf=profiles.find(x=>x.id===_curChat.playerId);if(pf)un=pf.name||'';}return s.replace(/\{\{user\}\}/gi,un||'玩家').replace(/\{\{char\}\}/gi,cn);}
function fmt24(t){if(!t)return '';const m=t.match(/^(上午|下午)\s*(\d{1,2}):(\d{2})$/);if(!m)return t;let h=parseInt(m[2]);if(m[1]==='下午'&&h<12)h+=12;if(m[1]==='上午'&&h===12)h=0;return String(h).padStart(2,'0')+':'+m[3];}
function renderMsgRow(m,idx){const row=document.createElement('div'),t=fmt24(m.time||''),mc=tplReplace(m.content||''),parsed=marked.parse(mc);row.dataset.msgIdx=idx;
if(m.role==='system'){row.className='msg-row ai';row.style.maxWidth='100%';row.innerHTML='<div class="msg-body"><div class="msg-content-row"><div class="msg-bubble" style="background:var(--bg3);border:1px solid var(--bd);color:var(--tx2);font-size:13px;font-style:italic;">'+parsed+'</div></div></div>';}
else if(m.role==='ai'){row.className='msg-row ai';const liveAv=_curChat?_curChat.avatarUrl:m.avUrl;const ah=liveAv?'<div class="msg-av"><img src="'+liveAv+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>':'<div class="msg-av">'+esc((m.name||'?')[0])+'</div>';row.innerHTML=ah+'<div class="msg-body"><div class="msg-content-row"><div class="msg-bubble">'+parsed+'</div>'+(t?'<div class="mm">'+t+'</div>':'')+'</div></div>';}
else{row.className='msg-row user';let uav='';if(_curChat&&_curChat.playerId){const pf=profiles.find(x=>x.id===_curChat.playerId);if(pf){const av=pf.avatar_url;uav=av?'<div class="msg-av"><img src="'+av+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>':'<div class="msg-av">'+esc((pf.name||'?')[0])+'</div>';}}row.innerHTML=uav+'<div class="msg-body"><div class="msg-content-row"><div class="msg-bubble">'+parsed+'</div>'+(t?'<div class="mm">'+t+'</div>':'')+'</div></div>';}
bindLongPress(row,()=>{if(!_msgDelMode&&!_ssMode)openMsgBs(idx);});row.addEventListener('click',()=>{if(_msgDelMode)toggleMsgDelSel(idx);else if(_ssMode)toggleSS(idx);});return row;}
function openMsgBs(idx){$('bs-body').innerHTML='<div class="bs-item" onclick="editMsg('+idx+')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>編輯</div><div class="bs-item" onclick="copyMsg('+idx+')"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>複製</div><div class="bs-item" onclick="closeBs();startScreenshot('+idx+')"><svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>截圖</div><div class="bs-item danger" onclick="closeBs();startMsgDel('+idx+')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>刪除</div>';$('bs-ov').classList.add('show');}
function copyMsg(idx){closeBs();if(!_curChat||!_curChat.msgs[idx])return;navigator.clipboard.writeText(_curChat.msgs[idx].content).then(()=>toast('已複製')).catch(()=>toast('複製失敗'));}
function closeBs(){$('bs-ov').classList.remove('show');}
let _emIdx=null,_emMax=9999;
function editMsg(idx){closeBs();if(!_curChat||!_curChat.msgs[idx])return;_emIdx=idx;$('em-ta').value=_curChat.msgs[idx].content;$('em-ctr').textContent='('+_curChat.msgs[idx].content.length+')';$('em-ov').classList.add('show');}
function closeEditModal(){$('em-ov').classList.remove('show');_emIdx=null;}
async function confirmEditMsg(){if(_emIdx===null||!_curChat)return;_curChat.msgs[_emIdx].content=$('em-ta').value;
if(_curChatId){const rows=sortBy(await dbByIndex('messages','chat_id',_curChatId),'sort_order');if(rows[_emIdx])await dbPut('messages',{...rows[_emIdx],content:$('em-ta').value});}
refreshMsgs();closeEditModal();}
let _msgDelMode=false,_msgDelSel=new Set();
function startMsgDel(initIdx){_msgDelMode=true;_msgDelSel.clear();_msgDelSel.add(initIdx);$('cv').classList.add('msg-del-mode');$('msg-del-bar').classList.add('show');$('msg-del-banner').classList.add('show');$('ci').style.display='none';updateMsgDelUI();}
function cancelMsgDel(){_msgDelMode=false;_msgDelSel.clear();$('cv').classList.remove('msg-del-mode');$('msg-del-bar').classList.remove('show');$('msg-del-banner').classList.remove('show');$('ci').style.display='flex';document.querySelectorAll('.msg-row.msg-del-sel').forEach(r=>r.classList.remove('msg-del-sel'));}
function toggleMsgDelSel(idx){if(_msgDelSel.has(idx))_msgDelSel.delete(idx);else _msgDelSel.add(idx);updateMsgDelUI();}
function updateMsgDelUI(){const n=_msgDelSel.size;$('msg-del-exec').textContent='刪除'+(n?' ('+n+')':'');document.querySelectorAll('.msg-row[data-msg-idx]').forEach(r=>{r.classList.toggle('msg-del-sel',_msgDelSel.has(parseInt(r.dataset.msgIdx)));});}
async function execMsgDel(){if(!_msgDelSel.size||!_curChat)return;if(!await cfm('確定刪除 '+_msgDelSel.size+' 則訊息？'))return;
const sorted=[..._msgDelSel].sort((a,b)=>b-a);for(const idx of sorted)_curChat.msgs.splice(idx,1);
if(_curChatId){const dbRows=sortBy(await dbByIndex('messages','chat_id',_curChatId),'sort_order');for(const idx of sorted){if(dbRows[idx])await dbDel('messages',dbRows[idx].id);}
const remaining=sortBy(await dbByIndex('messages','chat_id',_curChatId),'sort_order');for(let i=0;i<remaining.length;i++){if(remaining[i].sort_order!==i){remaining[i].sort_order=i;await dbPut('messages',remaining[i]);}}}
cancelMsgDel();refreshMsgs();toast('已刪除');}
function refreshMsgs(){const cm=$('c-msgs');cm.innerHTML='';(_curChat.msgs||[]).forEach((m,i)=>{try{cm.appendChild(renderMsgRow(m,i));}catch(e){}});cm.scrollTop=cm.scrollHeight;}
function appendMsg(role,name,content,avUrl){const t=new Date().toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});const msg={role,name,content,time:t,avUrl:avUrl||''};if(_curChat){_curChat.msgs.push(msg);saveMsg(_curChatId,msg,_curChat.msgs.length-1).catch(()=>{});}const cm=$('c-msgs'),idx=_curChat?_curChat.msgs.length-1:0;cm.appendChild(renderMsgRow(msg,idx));cm.scrollTop=cm.scrollHeight;}
async function appendMsgAwait(role,name,content,avUrl){const t=new Date().toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});const msg={role,name,content,time:t,avUrl:avUrl||''};if(_curChat){_curChat.msgs.push(msg);await saveMsg(_curChatId,msg,_curChat.msgs.length-1);}const cm=$('c-msgs'),idx=_curChat?_curChat.msgs.length-1:0;cm.appendChild(renderMsgRow(msg,idx));cm.scrollTop=cm.scrollHeight;}
const _isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
function handleCInpKey(e){if(e.key==='Enter'&&!e.shiftKey&&!_isMobile){e.preventDefault();sendMsg();}}
function sendMsg(){const inp=$('c-inp'),txt=inp.value.trim();if(!txt)return;appendMsg('user','你',txt);inp.value='';inp.style.height='auto';inp.style.height='44px';touchChatTime();saveChatStore();callAI(txt);}
function showTyping(){const cm=$('c-msgs'),row=document.createElement('div');row.className='msg-row ai';row.id='typing-row';const name=_curChat?_curChat.charName:'?';const avUrl=_curChat?_curChat.avatarUrl:'';const ah=avUrl?'<div class="msg-av"><img src="'+avUrl+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>':'<div class="msg-av">'+esc(name[0])+'</div>';row.innerHTML=ah+'<div class="msg-body"><div class="msg-name">'+esc(name)+'</div><div style="display:flex;align-items:center;gap:6px;"><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div><div class="stop-btn" onclick="abortAI()"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></div></div></div>';cm.appendChild(row);cm.scrollTop=cm.scrollHeight;}
function hideTyping(){const r=$('typing-row');if(r)r.remove();}
let _aiAbort=null;
function abortAI(){if(_aiAbort){_aiAbort.abort();_aiAbort=null;hideTyping();toast('已停止');}}
async function callAI(userText){if(!_curChat)return;const s=getSettings();const apiCfg=getApiCfgForPrompt(_curChat.rpId);if(!apiCfg||!apiCfg.api_key){toast('請先設定 API');return;}if(!apiCfg.model){toast('請選擇模型');return;}
_aiAbort=new AbortController();showTyping();
try{
let vecExtras=[],vecEvents=[],vecMemories=[];
if(userText&&s.emb_local){const emb=await getEmbedding(userText);if(emb){const cid=_curChat.charId,chatId=_curChatId,vt=s.vec_threshold||0.3;
[vecExtras,vecEvents,vecMemories]=await Promise.all([vectorSearch('character_extras','character_id',cid,emb,s.vec_extras_count||3,vt),vectorSearch('character_events','character_id',cid,emb,s.vec_events_count||3,vt),vectorSearch('memories','chat_id',chatId,emb,s.vec_memories_count||5,vt)]);}}
const sysContent=await buildSysPrompt(vecExtras,vecEvents,vecMemories);const msgs=buildApiMsgs();
const provider=apiCfg.provider||'anthropic',model=apiCfg.model,maxOut=parseInt(s.max_output_tokens)||4096,temp=s.temperature!=null?s.temperature:0.8;
let resp;
if(provider==='anthropic')resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiCfg.api_key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model,max_tokens:maxOut,temperature:temp,system:sysContent,messages:msgs}),signal:_aiAbort.signal});
else if(provider==='openai')resp=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiCfg.api_key},body:JSON.stringify({model,max_tokens:maxOut,temperature:temp,messages:[{role:'system',content:sysContent},...msgs]}),signal:_aiAbort.signal});
else if(provider==='google')resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiCfg.api_key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system_instruction:{parts:[{text:sysContent}]},contents:msgs.map(m=>({role:m.role==='assistant'?'model':'user',parts:[{text:m.content}]})),generationConfig:{temperature:temp,maxOutputTokens:maxOut}}),signal:_aiAbort.signal});
else resp=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiCfg.api_key},body:JSON.stringify({model,max_tokens:maxOut,temperature:temp,messages:[{role:'system',content:sysContent},...msgs]}),signal:_aiAbort.signal});
hideTyping();_aiAbort=null;
if(!resp.ok){toast('API 錯誤: '+resp.status);console.error(await resp.text());return;}
const data=await resp.json();let aiText='';
if(provider==='anthropic')aiText=data.content.map(b=>b.text||'').join('');
else if(provider==='google')aiText=(data.candidates&&data.candidates[0]&&data.candidates[0].content)?data.candidates[0].content.parts.map(p=>p.text||'').join(''):''
else aiText=data.choices&&data.choices[0]?data.choices[0].message.content:'';
appendMsg('ai',_curChat.charName,aiText,_curChat.avatarUrl);touchChatTime();saveChatStore();
try{if(s.auto_summary){const iv=parseInt(s.summary_interval)||10;const ac=(_curChat.msgs||[]).filter(m=>m.role==='ai').length;if(ac>0&&ac%iv===0&&_curChat.msgs.length>10){toast('自動生成摘要…');await autoGenSummary();}}}catch(e){}
try{await autoGenMemory(_curChat,_curChatId);}catch(e){}
}catch(e){hideTyping();_aiAbort=null;if(e.name==='AbortError')return;toast('請求失敗');console.error(e);}}
async function buildSysPrompt(vecExtras,vecEvents,vecMemories){let sys='';vecExtras=vecExtras||[];vecEvents=vecEvents||[];vecMemories=vecMemories||[];
const rpId=_curChat.rpId;if(rpId){const p=prompts.find(x=>x.id===rpId);if(p)sys+=p.content+'\n\n';}
const cd=await getCharData(_curChat.charId);const c=cd.char;
if(c){sys+='[角色卡]\n姓名: '+c.name+'\n';if(c.age)sys+='年齡: '+c.age+'\n';if(c.gender&&c.gender!=='未設置')sys+='性別: '+c.gender+'\n';if(c.job)sys+='職業: '+c.job+'\n';if(c.setting)sys+='設定:\n'+c.setting+'\n';}
if(_curChat.playerId){const pf=profiles.find(x=>x.id===_curChat.playerId);if(pf){sys+='\n[玩家角色]\n姓名: '+pf.name+'\n';if(pf.age)sys+='年齡: '+pf.age+'\n';if(pf.gender&&pf.gender!=='未設置')sys+='性別: '+pf.gender+'\n';if(pf.job)sys+='職業: '+pf.job+'\n';if(pf.setting)sys+='設定:\n'+pf.setting+'\n';}}
if(_curChat.summary&&_curChat.summary.trim())sys+='\n[歷史摘要]\n'+_curChat.summary+'\n';
const allExtras=cd.extras;
if(allExtras&&allExtras.length){const hasAnyEmb=allExtras.some(e=>e.embedding);
if(vecExtras.length){sys+='\n[附加設定]\n';vecExtras.forEach(v=>{const ex=allExtras.find(e=>e.id===v.id);if(ex){if(ex.title)sys+='## '+ex.title+'\n';if(ex.content)sys+=ex.content+'\n\n';}});const vecIds=new Set(vecExtras.map(v=>v.id));allExtras.filter(e=>!e.embedding&&!vecIds.has(e.id)).forEach(ex=>{if(ex.title)sys+='## '+ex.title+'\n';if(ex.content)sys+=ex.content+'\n\n';});}
else if(!hasAnyEmb){sys+='\n[附加設定]\n';allExtras.forEach(ex=>{if(ex.title)sys+='## '+ex.title+'\n';if(ex.content)sys+=ex.content+'\n\n';});}}
if(vecMemories.length){sys+='\n[相關記憶]\n';vecMemories.forEach(m=>{sys+='- '+m.content+'\n';});}
if(_curChat.memories&&_curChat.memories.length){sys+='\n[記憶體]\n';_curChat.memories.forEach(m=>{sys+='- '+(typeof m==='string'?m:(m.content||''))+'\n';});}
const cEvs=cd.events;let creatorToggles={},playerEvs=[];
try{const toggleRows=await dbByIndex('chat_creator_event_toggles','chat_id',_curChatId);toggleRows.forEach(r=>{creatorToggles[r.event_id]=r.enabled;});const plEvRows=(await dbByIndex('chat_events','chat_id',_curChatId)).filter(e=>e.enabled!==false);playerEvs=sortBy(plEvRows,'sort_order');}catch(e){}
const vecEvIds=new Set(vecEvents.map(v=>v.id));
const hasAnyEvEmb=cEvs.some(e=>e.embedding);
const activeCreator=cEvs.filter(ev=>{if(creatorToggles[ev.id]===false)return false;if(vecEvIds.has(ev.id))return true;if(!ev.embedding)return true;if(!hasAnyEvEmb)return creatorToggles[ev.id]!==false;return false;});
if(activeCreator.length){sys+='\n[創作者事件]\n';activeCreator.forEach(ev=>{sys+='- '+ev.name;if(ev.time_or_keyword)sys+=' ('+ev.time_or_keyword+')';sys+=':\n'+ev.content+'\n\n';});}
if(playerEvs.length){sys+='\n[玩家事件]\n';playerEvs.forEach(ev=>{sys+='- '+ev.name;if(ev.keyword)sys+=' ('+ev.keyword+')';sys+=':\n'+ev.content+'\n\n';});}
return tplReplace(sys.trim());}
function buildApiMsgs(){const allMsgs=_curChat.msgs||[];const total=allMsgs.length;const recentStart=Math.max(0,total-10);const msgs=[];
for(let i=recentStart;i<total;i++){const m=allMsgs[i];if(m.role==='system')msgs.push({role:'user',content:'[場景] '+m.content});else if(m.role==='ai')msgs.push({role:'assistant',content:m.content});else msgs.push({role:'user',content:m.content});}
if(msgs.length&&msgs[msgs.length-1].role==='assistant')msgs.push({role:'user',content:'[繼續]'});
if(msgs.length&&msgs[0].role==='assistant')msgs.unshift({role:'user',content:'[對話開始]'});
const pcmdTxt=getActivePcmds();if(pcmdTxt&&msgs.length){for(let i=msgs.length-1;i>=0;i--){if(msgs[i].role==='user'){msgs[i].content+='\n\n[常駐指令]\n'+pcmdTxt;break;}}}
return msgs;}

// ═══ Screenshot ═══
let _ssMode=false,_ssSel=new Set();
function startScreenshot(initIdx){_ssMode=true;_ssSel.clear();_ssSel.add(initIdx);$('cv').classList.add('msg-ss-mode');$('msg-ss-bar').classList.add('show');$('msg-ss-banner').classList.add('show');$('ci').style.display='none';updateSSUI();}
function cancelScreenshot(){_ssMode=false;_ssSel.clear();$('cv').classList.remove('msg-ss-mode');$('msg-ss-bar').classList.remove('show');$('msg-ss-banner').classList.remove('show');$('ci').style.display='flex';document.querySelectorAll('.msg-row.msg-ss-sel').forEach(r=>r.classList.remove('msg-ss-sel'));}
function updateSSUI(){document.querySelectorAll('.msg-row').forEach(r=>{const i=parseInt(r.dataset.msgIdx);r.classList.toggle('msg-ss-sel',_ssSel.has(i));});$('msg-ss-exec').textContent='截圖 ('+_ssSel.size+')';}
function toggleSS(idx){if(_ssSel.has(idx))_ssSel.delete(idx);else _ssSel.add(idx);updateSSUI();}

async function execScreenshot(){if(!_ssSel.size)return;toast('生成中...');
const msgs=_curChat.msgs||[];const sorted=[..._ssSel].sort((a,b)=>a-b);
const cs=getComputedStyle(document.documentElement);
const bg=cs.getPropertyValue('--bg').trim()||'#fff';
const bgAi=cs.getPropertyValue('--msg-ai').trim()||'#f0f0f0';
const bgUser=cs.getPropertyValue('--msg-user').trim()||'#e8f5e9';
const txColor=cs.getPropertyValue('--tx').trim()||'#333';
const txSub=cs.getPropertyValue('--tx2').trim()||'#888';
const acColor=cs.getPropertyValue('--ac').trim()||'#666';
const bdColor=cs.getPropertyValue('--bd').trim()||'#ddd';
const W=720,PAD=32,GAP=28,AVSIZE=44,BUBPAD=16,MAXBW=W-PAD*2-AVSIZE-16,FONT='16px -apple-system,BlinkMacSystemFont,sans-serif';

// Pre-calculate height
const cvs0=document.createElement('canvas');cvs0.width=W;const c0=cvs0.getContext('2d');c0.font=FONT;
function wrapText(ctx,text,maxW){const lines=[];const rawLines=text.replace(/[*#_`>]+/g,'').split('\n');
for(const raw of rawLines){const words=raw.split('');let line='';
for(const ch of words){const test=line+ch;if(ctx.measureText(test).width>maxW&&line){lines.push(line);line=ch;}else line=test;}
if(line)lines.push(line);if(!raw)lines.push('');}return lines;}

let totalH=PAD;const msgData=[];
for(const idx of sorted){const m=msgs[idx];if(!m)continue;const plain=m.content.replace(/[*#_`>]+/g,'').trim();const isUser=m.role==='user';const isSys=m.role==='system';
const lines=wrapText(c0,plain,MAXBW-BUBPAD*2);const nameH=isSys?0:22;const textH=lines.length*24;const bubH=nameH+textH+BUBPAD*2;
msgData.push({m,idx,isUser,isSys,lines,bubH,nameH});totalH+=bubH+GAP;}
totalH+=PAD-GAP;

// Draw
const canvas=document.createElement('canvas');canvas.width=W;canvas.height=Math.max(totalH,100);const ctx=canvas.getContext('2d');
ctx.fillStyle=bg;ctx.fillRect(0,0,W,canvas.height);
let y=PAD;
for(const d of msgData){const {m,isUser,isSys,lines,bubH,nameH}=d;
const bubW=Math.min(MAXBW,ctx.measureText(lines.reduce((a,b)=>ctx.measureText(a).width>ctx.measureText(b).width?a:b,'')).width+BUBPAD*2+20);
let bx,ax;
if(isUser){bx=W-PAD-bubW;ax=W-PAD+8;}
else{ax=PAD;bx=PAD+AVSIZE+12;}

// Avatar circle
if(!isSys){ctx.save();ctx.beginPath();ctx.arc(ax+AVSIZE/2,y+AVSIZE/2,AVSIZE/2,0,Math.PI*2);ctx.fillStyle=bdColor;ctx.fill();ctx.clip();
const avUrl=isUser?null:(_curChat?_curChat.avatarUrl:'');
if(!isUser&&avUrl){try{const img=await loadImg(avUrl);ctx.drawImage(img,ax,y,AVSIZE,AVSIZE);}catch(e){ctx.fillStyle=acColor;ctx.font='bold 18px sans-serif';ctx.textAlign='center';ctx.fillText((m.name||'?')[0],ax+AVSIZE/2,y+AVSIZE/2+6);}}
else{ctx.fillStyle=isUser?bgUser:acColor;ctx.fill();ctx.fillStyle=txColor;ctx.font='bold 18px sans-serif';ctx.textAlign='center';ctx.fillText((m.name||'?')[0],ax+AVSIZE/2,y+AVSIZE/2+6);}
ctx.restore();}

// Bubble
ctx.beginPath();const br=16;const bxR=bx,byR=y,bwR=bubW,bhR=bubH;
ctx.moveTo(bxR+br,byR);ctx.lineTo(bxR+bwR-br,byR);ctx.quadraticCurveTo(bxR+bwR,byR,bxR+bwR,byR+br);ctx.lineTo(bxR+bwR,byR+bhR-br);ctx.quadraticCurveTo(bxR+bwR,byR+bhR,bxR+bwR-br,byR+bhR);ctx.lineTo(bxR+br,byR+bhR);ctx.quadraticCurveTo(bxR,byR+bhR,bxR,byR+bhR-br);ctx.lineTo(bxR,byR+br);ctx.quadraticCurveTo(bxR,byR,bxR+br,byR);ctx.closePath();
ctx.fillStyle=isSys?bg:isUser?bgUser:bgAi;ctx.fill();
if(!isUser){ctx.strokeStyle=bdColor;ctx.lineWidth=1;ctx.stroke();}

// Name
ctx.textAlign='left';let ty=y+BUBPAD;
if(!isSys){ctx.fillStyle=acColor;ctx.font='bold 14px -apple-system,BlinkMacSystemFont,sans-serif';ctx.fillText(m.name||'',bx+BUBPAD,ty+12);ty+=nameH;}

// Text
ctx.fillStyle=isSys?txSub:txColor;ctx.font=FONT;
for(const line of lines){ctx.fillText(line,bx+BUBPAD,ty+16);ty+=24;}
y+=bubH+GAP;}

// Download
canvas.toBlob(blob=>{const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='chat-screenshot-'+Date.now()+'.png';a.click();URL.revokeObjectURL(a.href);cancelScreenshot();toast('✅ 已儲存');},'image/png');}

function loadImg(src){return new Promise((r,j)=>{const img=new Image();img.crossOrigin='anonymous';img.onload=()=>r(img);img.onerror=j;img.src=src;});}

// ═══ Summary ═══
function openSummary(){if(!_curChat)return;$('sum-ta').value=_curChat.summary||'';cntF($('sum-ta'));openFP('fp-sum');}
function saveSummary(){if(!_curChat)return;_curChat.summary=$('sum-ta').value;saveChatStore();toast('已儲存');}
async function callApiSimple(apiCfg,sysPr,userPr,maxTok,temp){const pv=apiCfg.provider||'anthropic',model=apiCfg.model;let resp;
if(pv==='anthropic')resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiCfg.api_key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model,max_tokens:maxTok,temperature:temp,system:sysPr,messages:[{role:'user',content:userPr}]})});
else if(pv==='google')resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiCfg.api_key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system_instruction:{parts:[{text:sysPr}]},contents:[{role:'user',parts:[{text:userPr}]}],generationConfig:{temperature:temp,maxOutputTokens:maxTok}})});
else{const ep=pv==='openrouter'?'https://openrouter.ai/api/v1/chat/completions':'https://api.openai.com/v1/chat/completions';resp=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiCfg.api_key},body:JSON.stringify({model,max_tokens:maxTok,temperature:temp,messages:[{role:'system',content:sysPr},{role:'user',content:userPr}]})});}
if(!resp.ok)return null;const data=await resp.json();
if(pv==='anthropic')return data.content.map(b=>b.text||'').join('');
if(pv==='google')return(data.candidates&&data.candidates[0]&&data.candidates[0].content)?data.candidates[0].content.parts.map(p=>p.text||'').join(''):''
return data.choices&&data.choices[0]?data.choices[0].message.content:'';}
async function genSummary(){if(!_curChat)return;const apiCfg=getFeatureApiCfg('sum')||getApiCfgForPrompt(_curChat.rpId);if(!apiCfg||!apiCfg.api_key||!apiCfg.model){toast('請先設定摘要 API/模型');return;}
const allMsgs=_curChat.msgs||[];const endIdx=Math.max(0,allMsgs.length-10);if(endIdx<1){toast('對話太短');return;}
let transcript='';for(let i=0;i<endIdx;i++){const m=allMsgs[i];transcript+=(m.role==='ai'?(m.name||'角色'):(m.role==='system'?'系統':'玩家'))+': '+m.content+'\n\n';}
toast('生成摘要…');const sysPr=getSettings().summary_prompt||'你是對話摘要助手。將以下 RP 對話濃縮成簡潔摘要，保留重要劇情、角色關係和關鍵事件。500 tokens 以內。繁體中文。';
const text=await callApiSimple(apiCfg,sysPr,'請摘要以下對話：\n\n'+transcript,500,0.3);
if(text){$('sum-ta').value=text;cntF($('sum-ta'));_curChat.summary=text;saveChatStore();toast('已生成');}else toast('生成失敗');}
async function autoGenSummary(){if(!_curChat)return;const apiCfg=getFeatureApiCfg('sum')||getApiCfgForPrompt(_curChat.rpId);if(!apiCfg||!apiCfg.api_key||!apiCfg.model)return;
const allMsgs=_curChat.msgs||[];const endIdx=Math.max(0,allMsgs.length-10);if(endIdx<1)return;
let transcript=(_curChat.summary?'[上次摘要]\n'+_curChat.summary+'\n\n[新對話]\n':'');
for(let i=Math.max(0,endIdx-20);i<endIdx;i++){const m=allMsgs[i];transcript+=(m.role==='ai'?(m.name||'角色'):(m.role==='system'?'系統':'玩家'))+': '+m.content+'\n\n';}
const sysPr=getSettings().summary_prompt||'你是對話摘要助手。合併濃縮成簡潔摘要。500 tokens 以內。繁體中文。';
const text=await callApiSimple(apiCfg,sysPr,'請合併摘要：\n\n'+transcript,500,0.3);
if(text){_curChat.summary=text;saveChatStore();toast('摘要已更新');}}

// ═══ Auto Memory Generation ═══
async function autoGenMemory(chat,chatId){if(!chat)return;
const s=getSettings();const apiCfg=getFeatureApiCfg('mem');
if(!apiCfg||!apiCfg.api_key||!apiCfg.model)return;
const interval=parseInt(s.mem_rule)||10;
const aiCount=(chat.msgs||[]).filter(m=>m.role==='ai').length;
if(aiCount<1||aiCount%interval!==0)return;
const msgs=chat.msgs||[];const start=Math.max(0,msgs.length-interval*2);
let transcript='';for(let i=start;i<msgs.length;i++){const m=msgs[i];transcript+=(m.role==='ai'?(m.name||'角色'):(m.role==='system'?'系統':'玩家'))+': '+m.content+'\n\n';}
if(!transcript.trim())return;
const defPrompt='從以下對話中提取重要記憶，包含：角色間的關係變化、重要承諾或約定、角色透露的個人資訊、情感轉折點、關鍵劇情事件。每條記憶用一行表示，保持簡潔。使用繁體中文。只輸出記憶條目，不要任何前綴或解釋。';
const text=await callApiSimple(apiCfg,s.mem_prompt||defPrompt,transcript,500,0.3);
if(!text||!text.trim())return;
const lines=text.split('\n').map(l=>l.replace(/^[-•\d.]\s*/,'').trim()).filter(l=>l.length>2);
let saved=0;const date=new Date().toISOString().slice(0,10);
for(const line of lines){const nid=uid();await dbPut('memories',{id:nid,chat_id:chatId,content:line,date});embedAndPatch('memories',nid,line);saved++;}
if(saved)toast('已生成 '+saved+' 條記憶');}

// ═══ Chat List ═══
async function renameChatInline(){if(!_curChat||!_curChatId)return;const name=await inp('修改視窗名稱',_curChat.windowName||_curChat.charName);if(name===null)return;_curChat.windowName=name.trim()||_curChat.charName;$('c-name').textContent=_curChat.windowName;saveChatStore();renderChatList();}
function renderChatList(){const el=$('chat-list'),ids=Object.keys(_chatStore).sort((a,b)=>{const pa=_chatStore[a].pinned?1:0,pb=_chatStore[b].pinned?1:0;if(pa!==pb)return pb-pa;return(new Date(_chatStore[b].updated||0).getTime())-(new Date(_chatStore[a].updated||0).getTime());});
if(!ids.length){el.innerHTML='<div class="empty">點擊「+ 新對話」開始</div>';return;}
ids.forEach(id=>{const c=_chatStore[id];if(c&&c.charId){const ch=chars.find(x=>x.id===c.charId);if(ch&&ch.avatar_url)c.avatarUrl=ch.avatar_url;}});
el.innerHTML=ids.map(id=>{const c=_chatStore[id],ao=getAvOff('char_'+c.charId);
const batchDot=_batchMode?'<div class="batch-dot'+(_batchSel.has(id)?' sel':'')+'" id="bd-'+id+'" onclick="toggleBatchSel(\''+id+'\',event)"></div>':'';
return '<div class="li li-chat" id="cli-'+id+'" onclick="'+(_batchMode?"toggleBatchSel('"+id+"',event)":"resumeChat('"+id+"'")+')" style="flex-wrap:nowrap;">'+batchDot+avH(c.avatarUrl,c.charName,72,ao.ox,ao.oy).replace('class="av"','class="av av-list"')+'<div class="lb"><div class="lt">'+esc(c.windowName||c.charName)+'</div><div class="ls">新對話</div></div>'+(_batchMode?'':'<div class="pin-icon'+(c.pinned?' pinned':'')+'" onclick="event.stopPropagation();togglePin(\''+id+'\')"><svg viewBox="0 0 24 24"'+(c.pinned?' fill="var(--ac)"':'')+'><path d="M15.4 2.6a1 1 0 011.4 0l4.6 4.6a1 1 0 010 1.4l-3.8 3.8a2 2 0 01-1.4.6H13l-2.5 2.5V19a1 1 0 01-1.7.7L5.3 16.2a1 1 0 01.7-1.7h3.5L12 12v-3.2a2 2 0 01.6-1.4z"/><line x1="2" y1="22" x2="9.5" y2="14.5"/></svg></div>')+'</div>';}).join('');
if(!_batchMode){ids.forEach(id=>{const e=document.getElementById('cli-'+id);if(e)bindLongPress(e,(x,y)=>{showCtx(x,y,[{label:'重新命名',action:"renameChat('"+id+"')"},{label:_chatStore[id].pinned?'取消釘選':'釘選',action:"togglePin('"+id+"')"}]);});});}
// Load last message previews
ids.forEach(async id=>{try{const rows=sortBy(await dbByIndex('messages','chat_id',id),'sort_order','desc');const last=rows.find(r=>r.role==='ai');if(last){const pv=last.content.replace(/[*#_`>\n]+/g,' ').substring(0,80);const li=document.getElementById('cli-'+id);if(li){const ls=li.querySelector('.ls');if(ls)ls.textContent=pv;}}}catch(e){}});}
function togglePin(id){if(_chatStore[id]){_chatStore[id].pinned=!_chatStore[id].pinned;dbGet('chats',id).then(c=>{if(c){c.pinned=_chatStore[id].pinned;dbPut('chats',c);}});renderChatList();}}
async function renameChat(id){hideCtx();const c=_chatStore[id];if(!c)return;const name=await inp('修改視窗名稱',c.windowName||c.charName);if(name!==null){c.windowName=name.trim()||c.charName;dbGet('chats',id).then(ch=>{if(ch){ch.window_name=c.windowName;dbPut('chats',ch);}});if(_curChatId===id){_curChat.windowName=c.windowName;$('c-name').textContent=c.windowName;}renderChatList();}}
async function delCurrentChat(){if(!_curChatId){closeSide();return;}if(!await cfm('確定刪除？'))return;
const rows=await dbByIndex('messages','chat_id',_curChatId);for(const r of rows)await dbDel('messages',r.id);
const evs=await dbByIndex('chat_events','chat_id',_curChatId);for(const e of evs)await dbDel('chat_events',e.id);
const mems=await dbByIndex('memories','chat_id',_curChatId);for(const m of mems)await dbDel('memories',m.id);
await dbDel('chats',_curChatId);delete _chatStore[_curChatId];_curChatId=null;_curChat=null;closeSide();closeChat();toast('已刪除');}
async function resumeChat(id){const c=_chatStore[id];if(!c)return;_curChatId=id;_curChat=c;_chatRpId=c.rpId||null;_chatPlayerId=c.playerId||null;
const ch=chars.find(x=>x.id===c.charId);if(ch&&ch.avatar_url)c.avatarUrl=ch.avatar_url;
$('c-name').textContent=c.windowName||c.charName;
if(_chatRpId){const p=prompts.find(x=>x.id===_chatRpId);if(p)$('rp-btn').childNodes[0].textContent=p.name;}syncRpPopup();renderSidePlayer();
const cinp=$('c-inp');cinp.value=c.draft||'';cinp.style.height='44px';if(c.draft){cinp.style.height='auto';cinp.style.height=Math.min(cinp.scrollHeight,200)+'px';}
const cm=$('c-msgs');cm.innerHTML='<div style="display:flex;justify-content:center;align-items:center;height:100%;min-height:200px;"><div class="splash-dots"><span></span><span></span><span></span></div></div>';
openChat(c.windowName||c.charName);
_curChat.msgs=await loadChatMsgs(id);cm.innerHTML='';(_curChat.msgs||[]).forEach((m,i)=>{try{cm.appendChild(renderMsgRow(m,i));}catch(e){}});cm.scrollTop=cm.scrollHeight;}

// ═══ Chat Events ═══
async function openChatEvents(){if(!_curChat)return;const b=$('chat-ev-body');b.innerHTML='';
const cd=await getCharData(_curChat.charId);const cEvs=cd.events;
let creatorToggles={};try{(await dbByIndex('chat_creator_event_toggles','chat_id',_curChatId)).forEach(r=>{creatorToggles[r.event_id]=r.enabled;});}catch(e){}
if(cEvs.length){b.innerHTML+='<div class="stt" style="margin-top:4px;">創作者事件</div>';cEvs.forEach(ev=>{const on=creatorToggles[ev.id]!==false;b.innerHTML+='<div class="ev-toggle-item"><div class="lb" onclick="viewCreatorEv(\''+ev.id+'\')" style="cursor:pointer;"><div class="lt">'+esc(ev.name)+'</div><div class="ls">'+esc(ev.time_or_keyword||'')+'</div></div><div class="tog'+(on?' on':'')+'" onclick="toggleCrEv(\''+ev.id+'\',this)"></div></div>';});}
let playerEvs=sortBy(await dbByIndex('chat_events','chat_id',_curChatId),'sort_order');
b.innerHTML+='<div class="stt" style="margin-top:32px;display:flex;align-items:center;justify-content:space-between;">玩家事件<button class="btn bp bs2" onclick="newChatEv()">+ 新增</button></div>';
if(!playerEvs.length)b.innerHTML+='<div style="color:var(--tx2);font-size:13px;padding:12px;">尚未新增</div>';
else{b.innerHTML+='<div id="pl-ev-drag">';playerEvs.forEach(ev=>{b.innerHTML+='<div class="ev-toggle-item" data-evid="'+ev.id+'"><div class="lb" onclick="openChatEvD(\''+ev.id+'\')" style="cursor:pointer;"><div class="lt">'+esc(ev.name)+'</div><div class="ls">'+esc(ev.keyword||'')+'</div></div><div class="tog'+(ev.enabled!==false?' on':'')+'" onclick="togglePlEv(\''+ev.id+'\',this)"></div></div>';});b.innerHTML+='</div>';setTimeout(()=>{const dc=$('pl-ev-drag');if(dc)initEvDrag(dc,'chat_events','data-evid');},0);}
openFP('fp-chat-ev');}
async function toggleCrEv(evId,el){if(!_curChatId)return;const nowOn=el.classList.contains('on');el.classList.toggle('on');
await dbPut('chat_creator_event_toggles',{id:_curChatId+'_'+evId,chat_id:_curChatId,event_id:evId,enabled:!nowOn});}
async function viewCreatorEv(id){const ev=await dbGet('character_events',id);if(!ev)return;$('cev2-id').value='';$('cev2-n').value=ev.name||'';$('cev2-n').readOnly=true;$('cev2-t').value=ev.time_or_keyword||'';$('cev2-t').readOnly=true;$('cev2-c').value=ev.content||'';$('cev2-c').readOnly=true;cntF($('cev2-c'));openFP('fp-chat-ev-d');}
function resetEvdForm(){$('cev2-n').readOnly=false;$('cev2-t').readOnly=false;$('cev2-c').readOnly=false;}
async function togglePlEv(evId,el){const nowOn=el.classList.contains('on');el.classList.toggle('on');const ev=await dbGet('chat_events',evId);if(ev){ev.enabled=!nowOn;await dbPut('chat_events',ev);}}
function newChatEv(){resetEvdForm();$('cev2-id').value='';$('cev2-n').value='';$('cev2-t').value='';$('cev2-c').value='';cntF($('cev2-c'));openFP('fp-chat-ev-d');}
async function openChatEvD(evId){resetEvdForm();const ev=await dbGet('chat_events',evId);if(!ev)return;$('cev2-id').value=ev.id;$('cev2-n').value=ev.name||'';$('cev2-t').value=ev.keyword||'';$('cev2-c').value=ev.content||'';cntF($('cev2-c'));openFP('fp-chat-ev-d');}
async function saveChatEv(){if(!_curChatId)return;const id=$('cev2-id').value,obj={name:$('cev2-n').value.trim()||'未命名',keyword:$('cev2-t').value,content:$('cev2-c').value};
if(id){const ev=await dbGet('chat_events',id)||{id};Object.assign(ev,obj);await dbPut('chat_events',ev);}
else{obj.id=uid();obj.chat_id=_curChatId;obj.enabled=true;const existing=await dbByIndex('chat_events','chat_id',_curChatId);obj.sort_order=existing.length;await dbPut('chat_events',obj);}
toast('已儲存');closeFP('fp-chat-ev-d');closeFP('fp-chat-ev');openChatEvents();}
async function delChatEv(){const id=$('cev2-id').value;if(!id){closeFP('fp-chat-ev-d');return;}if(!await cfm('確定刪除？'))return;await dbDel('chat_events',id);toast('已刪除');closeFP('fp-chat-ev-d');closeFP('fp-chat-ev');openChatEvents();}

// ═══ Chat Memory ═══
async function openChatMemory(){if(!_curChat)return;const b=$('chat-mem-body');b.innerHTML='';
let dbMems=sortBy(await dbByIndex('memories','chat_id',_curChatId),'sort_order','desc');
const localMems=(_curChat.memories||[]).map((m,i)=>({_local:true,_idx:i,content:typeof m==='string'?m:(m.content||''),date:typeof m==='object'?m.date:''}));
const allMems=[...dbMems.map(m=>({...m,_local:false})),...localMems];
if(!allMems.length){b.innerHTML='<div class="empty">尚未建立記憶</div>';}else{
allMems.forEach(m=>{const isDb=!m._local;const mid=isDb?m.id:('l'+m._idx);const src=isDb?'db':'local';
b.innerHTML+='<div class="card" style="margin-bottom:12px;"><div style="font-size:13px;line-height:1.7;color:var(--tx);cursor:pointer;" onclick="'+(isDb?"openDbMemD('"+mid+"')":"openChatMemD("+m._idx+")")+'">'+esc(m.content)+'</div></div>';});}
openFP('fp-chat-mem');}
function newChatMem(){$('cmem-id').value='';$('cmem-src').value='local';$('cmem-c').value='';cntF($('cmem-c'));openFP('fp-chat-mem-d');}
function openChatMemD(i){$('cmem-id').value=i;$('cmem-src').value='local';const m=_curChat.memories[i];$('cmem-c').value=typeof m==='string'?m:(m.content||'');cntF($('cmem-c'));openFP('fp-chat-mem-d');}
async function openDbMemD(dbId){$('cmem-id').value=dbId;$('cmem-src').value='db';const m=await dbGet('memories',dbId);$('cmem-c').value=m?m.content||'':'';cntF($('cmem-c'));openFP('fp-chat-mem-d');}
async function saveChatMem(){if(!_curChat)return;const idx=$('cmem-id').value,txt=$('cmem-c').value,src=$('cmem-src').value;
if(src==='db'&&idx){const m=await dbGet('memories',idx);if(m){m.content=txt;await dbPut('memories',m);embedAndPatch('memories',idx,txt);}}
else if(idx===''){const date=new Date().toISOString().slice(0,10);const nid=uid();await dbPut('memories',{id:nid,chat_id:_curChatId,content:txt,date});embedAndPatch('memories',nid,txt);}
else{if(!_curChat.memories)_curChat.memories=[];_curChat.memories[parseInt(idx)]={content:txt,date:new Date().toISOString().slice(0,10)};saveChatStore();}
toast('已儲存');closeFP('fp-chat-mem-d');closeFP('fp-chat-mem');openChatMemory();}
async function delChatMem(){const idx=$('cmem-id').value,src=$('cmem-src').value;if(idx===''){closeFP('fp-chat-mem-d');return;}
if(src==='db')await dbDel('memories',idx);else{if(_curChat)_curChat.memories.splice(parseInt(idx),1);saveChatStore();}
toast('已刪除');closeFP('fp-chat-mem-d');closeFP('fp-chat-mem');openChatMemory();}

// ═══ Persistent Commands ═══
let _pcmds=[];
async function loadPcmds(){_pcmds=sortBy(await dbAll('persistent_commands'),'sort_order');}
function togglePcmdPanel(){const p=$('pcmd-panel');if(p.classList.contains('show')){closePcmdPanel();}else{renderPcmdList();p.classList.add('show');$('pcmd-overlay').classList.add('show');$('pcmd-plus-btn').classList.add('active');}}
function closePcmdPanel(){$('pcmd-panel').classList.remove('show');$('pcmd-overlay').classList.remove('show');$('pcmd-plus-btn').classList.remove('active');}
function renderPcmdList(){const el=$('pcmd-list');if(!_pcmds.length){el.innerHTML='<div style="color:var(--tx2);font-size:15px;padding:8px;">尚未建立常駐指令</div>';return;}
const t=(_curChat&&_curChat.pcmdToggles)||{};
el.innerHTML=_pcmds.map((p,i)=>{const isOn=t[p.id]!==undefined?t[p.id]!==false:p.enabled!==false;return '<div class="ev-toggle-item" data-pcid="'+p.id+'"><div style="flex:1;min-width:0;cursor:pointer;" onclick="editPcmd(\''+p.id+'\')"><div class="lt">'+esc(p.name||'未命名')+'</div><div class="ls">'+esc((p.content||'').substring(0,80))+'</div></div><div class="tog'+(isOn?' on':'')+'" onclick="event.stopPropagation();togglePcmdEnabled('+i+',this)"></div></div>';}).join('');initPcmdDrag(el);}
function togglePcmdEnabled(i,el){if(!_pcmds[i]||!_curChat)return;if(!_curChat.pcmdToggles)_curChat.pcmdToggles={};const pid=_pcmds[i].id;_curChat.pcmdToggles[pid]=!(_curChat.pcmdToggles[pid]!==false);el.classList.toggle('on');saveChatStore();}
function newPcmd(){closePcmdPanel();$('pcmd-id').value='';$('pcmd-name').value='';$('pcmd-content').value='';cntF($('pcmd-content'));openFP('fp-pcmd-d');}
function editPcmd(id){closePcmdPanel();const p=_pcmds.find(x=>x.id===id);if(!p)return;$('pcmd-id').value=id;$('pcmd-name').value=p.name||'';$('pcmd-content').value=p.content||'';cntF($('pcmd-content'));openFP('fp-pcmd-d');}
async function savePcmd(){const id=$('pcmd-id').value,name=$('pcmd-name').value.trim()||'未命名',content=$('pcmd-content').value;
if(id){const p=await dbGet('persistent_commands',id)||{id};Object.assign(p,{name,content});await dbPut('persistent_commands',p);}
else await dbPut('persistent_commands',{id:uid(),name,content,enabled:true,sort_order:_pcmds.length});
await loadPcmds();renderPcmdList();toast('已儲存');closeFP('fp-pcmd-d');}
async function delPcmd(){const id=$('pcmd-id').value;if(!id)return;if(!await cfm('確定刪除？'))return;await dbDel('persistent_commands',id);await loadPcmds();renderPcmdList();toast('已刪除');closeFP('fp-pcmd-d');}
function getActivePcmds(){const t=(_curChat&&_curChat.pcmdToggles)||{};return _pcmds.filter(p=>{const v=t[p.id];return v!==false&&(v===true||p.enabled!==false);}).map(p=>p.content).join('\n');}

// ═══ Batch Delete ═══
let _batchMode=false,_batchSel=new Set();
function toggleBatchDel(){_batchMode=!_batchMode;_batchSel.clear();$('batch-del-bar').classList.toggle('show',_batchMode);$('batch-del-count').textContent='已選 0 個';renderChatList();}
function openChatListMenu(){$('bs-body').innerHTML='<div class="bs-item" onclick="closeBs();openNewChatPicker()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>新對話</div><div class="bs-item" onclick="closeBs();toggleBatchDel()"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>刪除視窗</div>';$('bs-ov').classList.add('show');}
function toggleBatchSel(id,ev){ev.stopPropagation();if(_batchSel.has(id))_batchSel.delete(id);else _batchSel.add(id);$('batch-del-count').textContent='已選 '+_batchSel.size+' 個';const dot=document.getElementById('bd-'+id);if(dot)dot.classList.toggle('sel',_batchSel.has(id));}
async function execBatchDel(){if(!_batchSel.size){toast('未選取');return;}if(!await cfm('確定刪除 '+_batchSel.size+' 個對話？'))return;
for(const id of _batchSel){const rows=await dbByIndex('messages','chat_id',id);for(const r of rows)await dbDel('messages',r.id);await dbDel('chats',id);delete _chatStore[id];if(_curChatId===id){_curChatId=null;_curChat=null;}}
toast('已刪除');toggleBatchDel();}
</script>
</body></html>
