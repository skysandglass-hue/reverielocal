<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Reverie">
<meta name="theme-color" content="#f5f6f8">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<title>Reverie</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
:root{--bg:#f5f6f8;--bg2:#fff;--bg3:#f9fafb;--bgi:#eef0f3;--ac:#7c9eb2;--acl:#e4eef3;--ach:#5d8299;--tx:#2d3436;--tx2:#8395a7;--tx3:#1a1a1a;--bd:#e2e6ea;--bd2:#d1d8de;--sh:rgba(0,0,0,.03);--msg-ai:#fff;--msg-user:#e4eef3;--navh:52px;}
body.theme-warm{--bg:#f7f5f2;--bg2:#fff;--bg3:#faf9f7;--bgi:#f0ede8;--ac:#c0705a;--acl:#f0ddd6;--ach:#a85d4a;--tx:#3d3a36;--tx2:#8a857d;--tx3:#1a1816;--bd:#e5e0da;--bd2:#d5cfc7;--msg-ai:#fff;--msg-user:#f0ddd6;}
body.theme-sage{--bg:#f2f5f3;--bg2:#fff;--bg3:#f6f9f7;--bgi:#e8ede9;--ac:#6b9080;--acl:#dce8e2;--ach:#4e7566;--tx:#2d3632;--tx2:#7d8e85;--tx3:#1a1e1b;--bd:#dae2dd;--bd2:#c8d4cc;--msg-ai:#fff;--msg-user:#dce8e2;}
body.theme-lavender{--bg:#f4f3f8;--bg2:#fff;--bg3:#f8f7fb;--bgi:#eae8f0;--ac:#8b7fb5;--acl:#e2dff0;--ach:#6e63a0;--tx:#2d2b36;--tx2:#8985a0;--tx3:#1a1820;--bd:#dedbe6;--bd2:#ccc8d8;--msg-ai:#fff;--msg-user:#e2dff0;}
body.theme-rose{--bg:#f8f4f5;--bg2:#fff;--bg3:#fbf8f9;--bgi:#f0e8ea;--ac:#b5707e;--acl:#f0dde2;--ach:#9a5565;--tx:#362d30;--tx2:#a08589;--tx3:#201a1c;--bd:#e6dbde;--bd2:#d8c8cd;--msg-ai:#fff;--msg-user:#f0dde2;}
body.theme-ocean{--bg:#f0f4f7;--bg2:#fff;--bg3:#f5f8fa;--bgi:#e2eaf0;--ac:#5088a8;--acl:#d4e4f0;--ach:#3a6d8a;--tx:#2a3238;--tx2:#7b8e9a;--tx3:#161d22;--bd:#d6e0e8;--bd2:#c0ced8;--msg-ai:#fff;--msg-user:#d4e4f0;}
body.theme-dark{--bg:#1a1a2e;--bg2:#252548;--bg3:#20203c;--bgi:#30305a;--ac:#9ab8cc;--acl:rgba(154,184,204,.18);--ach:#b0d0e4;--tx:#eceff2;--tx2:#b4bcc8;--tx3:#f8f8fa;--bd:#3c3c68;--bd2:#505080;--sh:rgba(0,0,0,.2);--msg-ai:#2c2c50;--msg-user:rgba(154,184,204,.22);}
body.theme-dark-warm{--bg:#1e1a18;--bg2:#2e2824;--bg3:#282220;--bgi:#3a322e;--ac:#d4886e;--acl:rgba(212,136,110,.18);--ach:#e8a088;--tx:#ece4dc;--tx2:#c0b4a8;--tx3:#faf4ec;--bd:#4a423c;--bd2:#5e5650;--sh:rgba(0,0,0,.2);--msg-ai:#342e2a;--msg-user:rgba(212,136,110,.22);}
body.theme-dark-green{--bg:#141c18;--bg2:#1e2c24;--bg3:#1a2620;--bgi:#2a3c32;--ac:#8cb8a4;--acl:rgba(140,184,164,.18);--ach:#a4d0b8;--tx:#eaf2ee;--tx2:#b0c4b8;--tx3:#f4faf6;--bd:#384e44;--bd2:#4a6458;--sh:rgba(0,0,0,.2);--msg-ai:#283830;--msg-user:rgba(140,184,164,.22);}
body.theme-midnight{--bg:#0e1018;--bg2:#1a1d28;--bg3:#161922;--bgi:#262a3e;--ac:#b0a4d8;--acl:rgba(176,164,216,.18);--ach:#c8bce8;--tx:#e2e0f0;--tx2:#b0aec8;--tx3:#f4f2fa;--bd:#343850;--bd2:#484c68;--sh:rgba(0,0,0,.3);--msg-ai:#222538;--msg-user:rgba(176,164,216,.22);}
body.theme-black{--bg:#000000;--bg2:#0a0a0a;--bg3:#050505;--bgi:#1a1a1a;--ac:#888888;--acl:rgba(136,136,136,.15);--ach:#aaaaaa;--tx:#e0e0e0;--tx2:#999999;--tx3:#ffffff;--bd:#222222;--bd2:#333333;--sh:rgba(0,0,0,.5);--msg-ai:#0d0d0d;--msg-user:rgba(136,136,136,.15);}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--tx);height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;font-size:15px;}
::placeholder{color:var(--tx2);opacity:1;}
::-webkit-input-placeholder{color:var(--tx2);opacity:1;}
textarea,input{-webkit-user-select:text;user-select:text;}.msg-bubble{-webkit-user-select:text;user-select:text;-webkit-tap-highlight-color:transparent;}
.nav-w{position:fixed;bottom:0;left:0;right:0;z-index:200;background:var(--bg2);border-top:1px solid var(--bd);box-shadow:0 -1px 4px var(--sh);padding-bottom:env(safe-area-inset-bottom,0);transition:transform .2s;}.nav-w.hide{transform:translateY(100%);}
.nav-i{display:flex;height:var(--navh);}
.nv{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:var(--tx2);cursor:pointer;border-top:2px solid transparent;user-select:none;gap:2px;}.nv.a{color:var(--ac);border-top-color:var(--ac);font-weight:500;}
.nv svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.main{flex:1;min-height:0;overflow:hidden;padding-bottom:calc(var(--navh) + env(safe-area-inset-bottom,0));}.main.np{padding-bottom:0;}
.scr{flex:1;min-height:0;overflow-y:auto;padding:16px 16px 80px;scrollbar-width:none;-ms-overflow-style:none;}.scr::-webkit-scrollbar{display:none;}
*{scrollbar-width:none;-ms-overflow-style:none;}*::-webkit-scrollbar{display:none;}
.pnl{display:none;height:100%;min-height:0;}.pnl.a{display:flex;flex-direction:column;}
.card{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:10px;box-shadow:0 1px 2px var(--sh);}
.ct{font-size:15px;font-weight:500;color:var(--tx3);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
textarea,input[type="text"],input[type="number"],input[type="password"],select{width:100%;background:var(--bg3);border:1px solid var(--bd);border-radius:8px;color:var(--tx);font-family:inherit;font-size:15px;padding:10px 12px;resize:vertical;}
textarea:focus,input:focus,select:focus{outline:none;border-color:var(--ac);background:var(--bg2);}
label{display:block;font-size:13px;color:var(--tx2);margin-bottom:4px;font-weight:400;}
.f{margin-bottom:12px;}.fr{display:flex;gap:10px;}.fr .f{flex:1;}
.ctr{text-align:right;font-size:12px;color:var(--tx2);margin-top:3px;}
.btn{padding:8px 16px;border-radius:8px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx);font-size:14px;cursor:pointer;font-family:inherit;}.btn:hover{border-color:var(--ac);color:var(--ac);}
.bp{background:var(--ac);border-color:var(--ac);color:#fff;}.bp:hover{background:var(--ach);}
.bdel{border-color:#c0705a;color:#c0705a;}.bdel:hover{background:rgba(192,112,90,.08);}
.bs2{font-size:13px;padding:5px 12px;}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-top:8px;}
.sht{font-size:24px;font-weight:700;color:var(--tx3);}
.bk{font-size:15px;color:var(--tx2);cursor:pointer;display:inline-flex;align-items:center;gap:4px;padding:6px 0;}.bk:hover{color:var(--ac);}
.li{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg2);border:1px solid var(--bd);border-radius:12px;cursor:pointer;margin-bottom:10px;box-shadow:0 1px 2px var(--sh);position:relative;flex-wrap:wrap;}
.li-chat{background:var(--bg);border:none;border-radius:0;margin-bottom:0;box-shadow:none;padding:12px 16px;margin-left:-16px;margin-right:-16px;}
.av{width:40px;height:40px;border-radius:50%;background:var(--bgi);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;color:var(--ac);font-weight:500;overflow:hidden;border:1px solid var(--bd);cursor:pointer;}.av img{width:100%;height:100%;object-fit:cover;}
.av-list{width:72px;height:72px;font-size:24px;}
.lb{flex:1;min-width:0;}.lt{font-size:16px;font-weight:500;color:var(--tx3);}.ls{font-size:14px;color:var(--tx2);margin-top:3px;line-height:1.5;}
.li-actions{display:flex;gap:8px;width:100%;margin-top:8px;}
.li-act{flex:1;padding:10px 0;border-radius:8px;border:1px solid var(--bd);background:var(--bg2);font-size:14px;color:var(--tx2);cursor:pointer;font-family:inherit;text-align:center;display:flex;align-items:center;justify-content:center;gap:5px;}.li-act:hover{border-color:var(--ac);color:var(--ac);}
.li-act svg{width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
.sr{display:flex;align-items:center;gap:10px;}.sr input[type="range"]{flex:1;accent-color:var(--ac);}.svl{width:40px;text-align:right;font-size:15px;color:var(--ac);font-weight:500;}
.stt{font-size:16px;font-weight:600;color:var(--tx3);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--bd);}
.pl{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.pi{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--bg2);border:1px solid var(--bd);border-radius:8px;cursor:pointer;box-shadow:0 1px 2px var(--sh);}.pi:hover{border-color:var(--ac);}.pi.sel{border-color:var(--ac);background:var(--acl);}
.pn2{font-size:14px;color:var(--tx3);flex:1;}.ptk{font-size:12px;color:var(--tx2);}
.snv{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.sbb{padding:8px 16px;border-radius:20px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx2);font-size:14px;cursor:pointer;font-family:inherit;}.sbb:hover{border-color:var(--ac);color:var(--ac);}.sbb.a{background:var(--ac);border-color:var(--ac);color:#fff;}
.sp{display:none;}.sp.a{display:block;}
.cw{display:none;flex-direction:column;height:100%;}.cw.a{display:flex;}
.ch{padding:10px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:8px;background:var(--bg2);flex-shrink:0;}.chn{font-size:16px;font-weight:500;color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw;}
.cm{flex:1;overflow-y:auto;padding:14px 16px;display:flex;flex-direction:column;gap:16px;background:var(--bg);}
.msg-row{display:flex;gap:8px;max-width:92%;align-items:flex-start;}.msg-row.ai{align-self:flex-start;}.msg-row.user{align-self:flex-end;flex-direction:row-reverse;}
.msg-av{width:44px;height:44px;border-radius:50%;background:var(--bgi);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;color:var(--ac);font-weight:500;overflow:hidden;border:1px solid var(--bd);margin-top:2px;}
.msg-body{flex:1;min-width:0;}.msg-name{font-size:15px;font-weight:500;color:var(--ac);margin-bottom:3px;}
.msg-bubble{padding:11px 15px;border-radius:18px;font-size:15px;line-height:1.85;color:var(--tx);}
.msg-row.ai .msg-bubble{background:var(--msg-ai);border:1px solid var(--bd);box-shadow:0 1px 2px var(--sh);}
.msg-row.user .msg-bubble{background:var(--msg-user);border:1px solid rgba(0,0,0,.04);}
.msg-row.user .msg-body{padding-top:21px;}
.mm{font-size:12px;color:var(--tx2);margin-top:4px;}
.msg-bubble p{margin:0 0 .6em;}.msg-bubble p:last-child{margin:0;}.msg-bubble em{font-style:italic;color:var(--tx2);}.msg-bubble strong{font-weight:600;}.msg-bubble blockquote{border-left:3px solid var(--ac);padding-left:10px;margin:.5em 0;color:var(--tx2);}
.msg-bubble ol,.msg-bubble ul{margin:0 0 .6em;padding-left:1.6em;}.msg-bubble li{margin-bottom:.3em;}
.ci{padding:10px 16px;display:flex;gap:10px;flex-shrink:0;background:var(--bg);align-items:flex-end;}
.ci-box{flex:1;display:flex;align-items:flex-end;background:var(--bg3);border:1px solid var(--bd);border-radius:22px;overflow:hidden;min-height:44px;}
.ci-box textarea{flex:1;max-height:200px;min-height:44px;overflow-y:auto;resize:none;padding:10px 6px 10px 16px;line-height:1.5;border:none;background:transparent;font-family:inherit;font-size:15px;color:var(--tx);}
.ci-box textarea:focus{outline:none;}
.ci-send{width:38px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;opacity:.5;transition:opacity .15s;}.ci-send:hover{opacity:1;}
.ham{width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--tx2);flex-shrink:0;border-radius:6px;}.ham:hover{color:var(--ac);background:var(--bgi);}
.ham svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.rp-sel{padding:8px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--bg2);font-size:14px;color:var(--tx);cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;white-space:nowrap;}.rp-sel:hover{border-color:var(--ac);color:var(--ac);}.rp-sel::after{content:'â–¾';font-size:10px;color:var(--tx2);}
.rp-sel-sm{padding:5px 10px;border-radius:6px;font-size:13px;}
.popup-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:400;align-items:center;justify-content:center;}.popup-ov.show{display:flex;}
.popup{background:var(--bg2);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:min(320px,90vw);max-height:70vh;overflow-y:auto;padding:20px;}
.popup-title{font-size:16px;font-weight:600;color:var(--tx3);margin-bottom:12px;}
.popup-item{padding:12px 14px;border:1px solid var(--bd);border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:space-between;gap:8px;}.popup-item:hover{border-color:var(--ac);}.popup-item.active{border-color:var(--ac);background:var(--acl);}
.popup-item .check{color:var(--ac);font-weight:600;display:none;}.popup-item.active .check{display:inline;}
.confirm-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:500;align-items:center;justify-content:center;}.confirm-ov.show{display:flex;}
.confirm-box{background:var(--bg2);border-radius:14px;width:min(320px,88vw);padding:22px;box-shadow:0 8px 24px rgba(0,0,0,.15);text-align:center;}
.confirm-msg{font-size:15px;color:var(--tx);margin-bottom:18px;line-height:1.6;}
.confirm-actions{display:flex;gap:8px;justify-content:center;}
.side-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:300;}.side-overlay.show{display:block;}
.sidebar{position:fixed;top:0;right:-300px;width:300px;height:100%;z-index:301;background:var(--bg2);box-shadow:-4px 0 12px rgba(0,0,0,.08);transition:right .25s ease;overflow-y:auto;padding:20px 16px;}.sidebar.show{right:0;}
.side-title{font-size:17px;font-weight:600;color:var(--tx3);margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--bd);}
.side-item{padding:11px 12px;border:1px solid var(--bd);border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:15px;color:var(--tx);display:flex;align-items:center;gap:8px;}.side-item:hover{border-color:var(--ac);color:var(--ac);}.side-item.danger{color:#c0705a;}
.side-item svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.side-section{font-size:13px;color:var(--tx2);margin:14px 0 6px;text-transform:uppercase;letter-spacing:.5px;}
.side-profile-active{padding:11px 12px;border:1px solid var(--ac);border-radius:8px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;background:var(--acl);color:var(--tx3);}.side-profile-active:hover{opacity:.85;}.side-profile-active .switch-hint{font-size:12px;color:var(--ac);margin-left:auto;}
.fp{display:none;position:fixed;inset:0;z-index:260;background:var(--bg);flex-direction:column;}.fp.show{display:flex;}
.fp-head{padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px;background:var(--bg2);flex-shrink:0;}.fp-title{font-size:16px;font-weight:600;color:var(--tx3);flex:1;}
.fp-body{flex:1;overflow-y:auto;padding:16px;}.fp-body.full{padding:16px 0;}.fp-body.full .f{padding:0 16px;}
.drag-h{cursor:grab;color:var(--bd2);font-size:16px;padding:0 4px;user-select:none;touch-action:none;}.drag-h:active{cursor:grabbing;color:var(--ac);}
.dragging{opacity:.5;transform:scale(1.02);box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:100;background:var(--bg2);}
.theme-row{display:flex;gap:14px;margin-top:6px;flex-wrap:wrap;}.theme-dot{width:32px;height:32px;border-radius:50%;cursor:pointer;border:2px solid var(--bd);transition:all .15s;}.theme-dot:hover{transform:scale(1.1);}.theme-dot.active{border-color:var(--tx3);box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--tx3);}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--tx3);color:var(--bg);padding:10px 20px;border-radius:8px;font-size:14px;z-index:600;opacity:0;transition:opacity .3s;pointer-events:none;}.toast.show{opacity:1;}
.empty{text-align:center;padding:40px 20px;color:var(--tx2);font-size:15px;}
.hidden{display:none;}
.av-editor{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px;position:relative;width:180px;margin-left:auto;margin-right:auto;margin-top:8px;}
.av-ed-wrap{position:relative;width:180px;height:180px;border-radius:50%;overflow:hidden;border:2px solid var(--bd);background:var(--bgi);flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:56px;color:var(--ac);font-weight:500;touch-action:none;}
.av-ed-wrap img{width:100%;height:100%;object-fit:cover;pointer-events:none;}
.av-ed-badge{position:absolute;bottom:8px;right:8px;width:36px;height:36px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;border:2px solid var(--bg2);cursor:pointer;z-index:99;box-shadow:0 2px 6px rgba(0,0,0,.15);}.av-ed-badge svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
.pin-icon{width:22px;height:22px;color:var(--bd2);flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;}.pin-icon:hover{color:var(--ac);}
.pin-icon.pinned{color:var(--ac);}
.pin-icon svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.pin-icon.pinned svg{fill:var(--ac);}
.ctx-menu{position:fixed;z-index:500;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.12);padding:6px 0;min-width:150px;}
.ctx-item{padding:11px 16px;font-size:15px;cursor:pointer;color:var(--tx);display:flex;align-items:center;gap:8px;}.ctx-item:hover{background:var(--bgi);}.ctx-item.danger{color:#c0705a;}
.bs-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;align-items:center;justify-content:center;}.bs-overlay.show{display:flex;}
.bs-popup{background:var(--bg2);border-radius:16px;width:min(260px,80vw);padding:8px 0;box-shadow:0 8px 30px rgba(0,0,0,.18);}
.bs-item{padding:14px 24px;font-size:15px;cursor:pointer;color:var(--tx);display:flex;align-items:center;gap:12px;border-top:1px solid var(--bd);}.bs-item:first-of-type{border-top:none;}.bs-item:hover{background:var(--bgi);}.bs-item.danger{color:#c0705a;}
.bs-item svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;}
.typing-indicator{display:flex;gap:4px;padding:10px 14px;align-items:center;}.typing-dot{width:6px;height:6px;background:var(--tx2);border-radius:50%;animation:typeBounce .8s infinite;}.typing-dot:nth-child(2){animation-delay:.15s;}.typing-dot:nth-child(3){animation-delay:.3s;}
.stop-btn{width:28px;height:28px;border-radius:50%;border:1.5px solid var(--bd2);background:var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--tx2);flex-shrink:0;transition:all .15s;}.stop-btn:hover{border-color:#c0705a;color:#c0705a;background:rgba(192,112,90,.08);}.stop-btn svg{width:14px;height:14px;stroke:currentColor;fill:currentColor;}
@keyframes typeBounce{0%,80%,100%{opacity:.3;transform:translateY(0);}40%{opacity:1;transform:translateY(-4px);}}
.edit-modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;align-items:center;justify-content:center;padding:16px;}.edit-modal-ov.show{display:flex;}
.edit-modal{background:var(--bg2);border-radius:16px;width:100%;max-width:500px;height:calc(66dvh);max-height:520px;padding:22px;box-shadow:0 8px 30px rgba(0,0,0,.18);display:flex;flex-direction:column;}
.edit-modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-shrink:0;}.edit-modal-title{font-size:16px;font-weight:600;color:var(--tx3);}
.edit-modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bgi);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--tx2);}.edit-modal-close:hover{background:var(--bd);}
.edit-modal textarea{flex:1;min-height:0;resize:none;}
.edit-modal .ctr{margin-bottom:12px;}
.edit-modal-btn{width:100%;padding:12px;border-radius:10px;border:none;background:var(--bgi);color:var(--tx3);font-size:15px;font-weight:500;cursor:pointer;font-family:inherit;}.edit-modal-btn:hover{background:var(--bd);}
.ev-drag{display:none;}
.ev-toggle-item{display:flex;align-items:center;gap:10px;padding:16px 14px;background:var(--bg2);border:1px solid var(--bd);border-radius:10px;margin-bottom:8px;}
.ev-toggle-item .lb{flex:1;min-width:0;cursor:pointer;}.ev-toggle-item .lt{font-size:16px;}.ev-toggle-item .ls{font-size:13px;color:var(--tx2);margin-top:6px;}
.tog{position:relative;width:34px;height:18px;background:var(--bd);border-radius:9px;cursor:pointer;flex-shrink:0;transition:background .2s;}.tog.on{background:var(--ac);}.tog::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 2px rgba(0,0,0,.08);}.tog.on::after{transform:translateX(16px);}
.pcmd-panel{display:none;position:fixed;bottom:0;left:0;right:0;z-index:251;background:var(--bg2);border-top:1px solid var(--bd);box-shadow:0 -4px 16px rgba(0,0,0,.08);border-radius:16px 16px 0 0;max-height:80vh;min-height:50vh;overflow-y:auto;padding:20px 16px;transition:transform .25s ease;}.pcmd-panel.show{display:block;}
.pcmd-panel-handle{width:36px;height:4px;background:var(--bd2);border-radius:2px;margin:0 auto 14px;}
.pcmd-overlay{display:none;position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.25);}.pcmd-overlay.show{display:block;}
.pcmd-card{padding:14px;border:1px solid var(--bd);border-radius:10px;margin-bottom:8px;background:var(--bg3);}.pcmd-card .lt{font-size:16px;font-weight:500;margin-bottom:4px;}.pcmd-card .ls{font-size:16px;color:var(--tx2);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.batch-del-bar{display:none;padding:10px 16px;background:var(--bg2);border-bottom:1px solid var(--bd);gap:10px;align-items:center;justify-content:space-between;}.batch-del-bar.show{display:flex;}
.batch-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--bd2);background:transparent;flex-shrink:0;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;}.batch-dot.sel{border-color:var(--ac);background:var(--ac);}
.batch-dot.sel::after{content:'âœ“';color:#fff;font-size:12px;font-weight:700;}
.msg-del-mode .cm{position:relative;}
.msg-del-mode .msg-row{cursor:pointer;transition:all .15s;-webkit-user-select:none;user-select:none;}.msg-del-mode .msg-row.msg-del-sel .msg-bubble{outline:2px solid #c0705a;outline-offset:2px;}.msg-del-mode .msg-bubble{-webkit-user-select:none;user-select:none;pointer-events:none;}
.msg-del-banner{display:none;padding:8px 16px;background:#c0705a;color:#fff;font-size:14px;text-align:center;flex-shrink:0;}.msg-del-banner.show{display:block;}
.msg-del-bar{display:none;padding:12px 16px;flex-shrink:0;z-index:12;flex-direction:column;gap:8px;background:var(--bg2);border-top:1px solid var(--bd);}.msg-del-bar.show{display:flex;}
.msg-del-bar .mdel-main{width:100%;padding:14px;border-radius:12px;border:none;background:#c0705a;color:#fff;font-size:16px;font-weight:500;cursor:pointer;font-family:inherit;}.msg-del-bar .mdel-main:hover{background:#a85d4a;}
.msg-del-bar .mdel-cancel{width:100%;padding:10px;border-radius:10px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx2);font-size:14px;cursor:pointer;font-family:inherit;}
.pcmd-plus{width:44px;height:44px;border-radius:50%;border:1px solid var(--bd);background:var(--bg2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;color:var(--tx2);flex-shrink:0;}.pcmd-plus:hover{border-color:var(--ac);color:var(--ac);}.pcmd-plus.active{background:var(--ac);border-color:var(--ac);color:#fff;}
.splash{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .4s ease;}.splash.hide{opacity:0;pointer-events:none;}
.splash-cloud{position:relative;width:220px;height:200px;display:flex;align-items:center;justify-content:center;}
.splash-cloud .splash-title{position:absolute;z-index:3;top:50px;left:50%;transform:translateX(-50%);font-size:26px;font-weight:700;color:var(--tx3);letter-spacing:1px;white-space:nowrap;}
.splash-cloud svg.cloud-bg{position:absolute;z-index:2;top:0;left:50%;transform:translateX(-50%);opacity:0;animation:sCloudIn 2.4s ease infinite;}
.splash-dot{position:absolute;border-radius:50%;border:1.5px solid var(--bd);background:var(--bg2);z-index:1;opacity:0;}
.splash-dot.d1{width:10px;height:10px;bottom:32px;left:38%;animation:sDotPop 2.4s ease infinite;}
.splash-dot.d2{width:18px;height:18px;bottom:48px;left:18%;animation:sDotPop 2.4s ease .4s infinite;}
@keyframes sDotPop{0%{opacity:0;}10%{opacity:1;}40%{opacity:1;}55%{opacity:0;}100%{opacity:0;}}
@keyframes sCloudIn{0%{opacity:0;transform:translateX(-50%);}35%{opacity:0;transform:translateX(-50%);}45%{opacity:1;transform:translateX(-50%);}80%{opacity:1;transform:translateX(-50%);}92%{opacity:0;transform:translateX(-50%);}100%{opacity:0;transform:translateX(-50%);}}
.splash-sub{font-size:14px;color:var(--tx2);margin-top:8px;}
.splash-dots{display:flex;gap:6px;margin-top:24px;}.splash-dots span{width:6px;height:6px;background:var(--ac);border-radius:50%;animation:sDot 1.2s infinite;opacity:.3;}.splash-dots span:nth-child(2){animation-delay:.2s;}.splash-dots span:nth-child(3){animation-delay:.4s;}
@keyframes sDot{0%,100%{opacity:.3;transform:scale(1);}50%{opacity:1;transform:scale(1.3);}}
.emb-progress{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:14px 20px;box-shadow:0 4px 16px rgba(0,0,0,.1);z-index:600;min-width:260px;display:none;text-align:center;}.emb-progress.show{display:block;}
.emb-progress .prog-bar{width:100%;height:6px;background:var(--bgi);border-radius:3px;margin-top:8px;overflow:hidden;}.emb-progress .prog-fill{height:100%;background:var(--ac);border-radius:3px;transition:width .3s;}
</style>
</head>
<body>
<div class="splash" id="splash"><div class="splash-cloud">
<div class="splash-title">Reverie</div>
<svg class="cloud-bg" width="210" height="130" viewBox="0 0 210 130" fill="none">
<path d="M35,108 C12,108 2,92 5,76 C8,62 20,52 34,50 C32,36 40,22 56,18 C70,14 85,20 92,32 C98,16 116,6 136,10 C156,14 170,30 168,50 C182,48 198,60 196,78 C194,96 178,108 162,108 Z" fill="var(--bg2)" stroke="var(--bd)" stroke-width="1.5"/>
</svg>
<div class="splash-dot d1"></div>
<div class="splash-dot d2"></div>
</div></div>
<div class="toast" id="toast"></div>
<div class="emb-progress" id="emb-prog"><div style="font-size:14px;color:var(--tx);" id="emb-prog-text">è¼‰å…¥ Embedding æ¨¡å‹ä¸­...</div><div class="prog-bar"><div class="prog-fill" id="emb-prog-fill" style="width:0%"></div></div></div>
<input type="file" accept="image/*" class="hidden" id="av-input" onchange="onAvUpload(this)">
<div class="confirm-ov" id="cfm-ov"><div class="confirm-box"><div class="confirm-msg" id="cfm-msg"></div><div class="confirm-actions"><button class="btn bs2" onclick="cfmR(false)">å–æ¶ˆ</button><button class="btn bdel bs2" onclick="cfmR(true)">ç¢ºå®š</button></div></div></div>
<div class="confirm-ov" id="inp-ov"><div class="confirm-box"><div class="confirm-msg" id="inp-msg" style="font-size:16px;"></div><input type="text" id="inp-val" onkeydown="if(event.key==='Enter')inpR(this.value)" style="width:100%;margin:8px 0 12px;padding:10px 12px;border:1px solid var(--bd);border-radius:8px;background:var(--bg);color:var(--tx);font-size:16px;"><div class="confirm-actions"><button class="btn bs2" onclick="inpR(null)">å–æ¶ˆ</button><button class="btn bp bs2" onclick="inpR($('inp-val').value)">ç¢ºå®š</button></div></div></div>
<div class="ctx-menu hidden" id="ctx-menu"></div>
<div class="bs-overlay" id="bs-ov" onclick="closeBs()"><div class="bs-popup" id="bs-body" onclick="event.stopPropagation()"></div></div>
<div class="edit-modal-ov" id="em-ov"><div class="edit-modal"><div class="edit-modal-head"><div class="edit-modal-title">æ›´æ­£è¨Šæ¯</div><button class="edit-modal-close" onclick="closeEditModal()">âœ•</button></div><textarea id="em-ta" oninput="$('em-ctr').textContent='('+this.value.length+'/'+(_emMax||9999)+')'"></textarea><div class="ctr" id="em-ctr"></div><button class="edit-modal-btn" onclick="confirmEditMsg()">å®Œæˆ</button></div></div>
<div class="main" id="main">
<!-- èŠå¤© -->
<div class="pnl a" id="p-chat">
  <div class="scr" id="cl"><div class="sh"><div class="sht">èŠå¤©</div><div class="ham" onclick="openChatListMenu()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></div></div><div class="batch-del-bar" id="batch-del-bar"><span style="font-size:14px;color:var(--tx2);" id="batch-del-count">å·²é¸ 0 å€‹</span><div style="display:flex;gap:6px;"><button class="btn bs2" onclick="toggleBatchDel()">å–æ¶ˆ</button><button class="btn bdel bs2" onclick="execBatchDel()">åˆªé™¤é¸å–</button></div></div><div id="chat-list"><div class="empty">é»æ“Šã€Œ+ æ–°å°è©±ã€é–‹å§‹</div></div></div>
  <div class="cw" id="cv">
    <div class="ch"><span class="bk" onclick="closeChat()" style="margin:0;font-size:16px;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="chn" id="c-name" style="display:none;">å°è©±</div><div style="flex:1;"></div><div class="rp-sel rp-sel-sm" id="rp-btn" onclick="openPopup('rp-popup')">æ¨™æº– RP</div><div class="ham" onclick="openSide()"><svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></div></div>
    <div class="msg-del-banner" id="msg-del-banner">è«‹é¸æ“‡è¦åˆªé™¤çš„è¨Šæ¯ã€‚</div>
    <div class="cm" id="c-msgs"></div>
    <div class="msg-del-bar" id="msg-del-bar"><button class="mdel-main" id="msg-del-exec" onclick="execMsgDel()">åˆªé™¤ (0)</button><button class="mdel-cancel" onclick="cancelMsgDel()">å–æ¶ˆé¸æ“‡</button></div>
    <div class="pcmd-overlay" id="pcmd-overlay" onclick="closePcmdPanel()"></div>
    <div class="pcmd-panel" id="pcmd-panel"><div class="pcmd-panel-handle" id="pcmd-handle"></div><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;"><div style="font-size:18px;font-weight:600;color:var(--tx3);">å¸¸é§æŒ‡ä»¤</div><div class="ham" onclick="newPcmd()" style="width:32px;height:32px;"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div></div><div id="pcmd-list"></div></div>
    <div class="ci"><div class="pcmd-plus" id="pcmd-plus-btn" onclick="togglePcmdPanel()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div><div class="ci-box"><textarea rows="1" placeholder="è¼¸å…¥..." id="c-inp" onkeydown="handleCInpKey(event)" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,200)+'px';"></textarea><div class="ci-send" onclick="sendMsg()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--ac)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div></div></div>
  </div>
</div>
<!-- è§’è‰² -->
<div class="pnl" id="p-chars"><div class="scr">
  <div id="vl"><div class="sh"><div class="sht">è§’è‰²</div><button class="btn bp bs2" onclick="createChar()">+ æ–°å¢</button></div><div id="char-list"></div></div>
  <div id="vd" style="display:none;">
    <div class="sh" style="position:sticky;top:-16px;z-index:10;background:var(--bg);padding:16px 0 10px;border-bottom:1px solid var(--bd);margin-bottom:12px;"><span class="bk" onclick="closeCharEdit()" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div style="flex:1;"></div><button class="btn bdel bs2" onclick="delChar()">åˆªé™¤</button><button class="btn bp bs2" onclick="saveChar()">å„²å­˜</button></div>
    <div class="av-editor"><div class="av-ed-wrap" id="ce-av-wrap">?</div><span class="av-ed-badge" onclick="event.stopPropagation();startAvUp('char')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span></div>
    <input type="hidden" id="ce-id">
    <div class="card"><div class="ct">è§’è‰²å¡ä¸»é«”</div>
      <div class="f"><label>å§“å</label><input type="text" id="ce-name"></div>
      <div class="f"><label>å¹´é½¡</label><input type="number" id="ce-age"></div><div class="f"><label>æ€§åˆ¥</label><div class="rp-sel" id="ce-gen" onclick="openPopup('gen-pop')" style="height:44px;display:flex;align-items:center;">æœªè¨­ç½®</div></div><div class="f"><label>è·æ¥­</label><input type="text" id="ce-job" placeholder="ä¾‹ï¼šåŠå£«ã€é†«å¸«..."></div>
      <div class="f"><label>è§’è‰²è¨­å®š</label><textarea rows="14" id="ce-set" oninput="cntF(this)"></textarea><div class="ctr">0 å­— Â· â‰ˆ 0 tokens</div></div>
    </div>
    <div class="card"><div class="ct">é™„åŠ è³‡è¨Š</div><div id="ce-ex"></div><button class="btn bs2" onclick="addExUI()" style="margin-top:8px;">+ æ–°å¢</button></div>
    <div class="card"><div class="ct">ç¬¬ä¸€æ¬¡èŠå¤©å ´æ™¯</div><div class="f"><label>æƒ…å¢ƒè…³æœ¬</label><textarea rows="8" id="ce-scn" oninput="cntF(this)"></textarea><div class="ctr">0 å­—</div></div><div class="f"><label>è§’è‰²é–‹å ´ç™½</label><textarea rows="6" id="ce-grt" oninput="cntF(this)"></textarea><div class="ctr">0 å­—</div></div></div>
  </div>
</div></div>
<!-- æª”æ¡ˆ -->
<div class="pnl" id="p-prof"><div class="scr">
  <div id="pf-vl"><div class="sh"><div class="sht">æª”æ¡ˆ</div><button class="btn bp bs2" onclick="createPf()">+ æ–°å¢</button></div><div id="pf-list"></div></div>
  <div id="pf-vd" style="display:none;">
    <div class="sh" style="position:sticky;top:-16px;z-index:10;background:var(--bg);padding:16px 0 10px;border-bottom:1px solid var(--bd);margin-bottom:12px;"><span class="bk" onclick="closePfEdit()" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div style="flex:1;"></div><button class="btn bdel bs2" onclick="delPfDetail()">åˆªé™¤</button><button class="btn bp bs2" onclick="savePfDetail()">å„²å­˜</button></div>
    <div class="av-editor"><div class="av-ed-wrap" id="pf-av-wrap">?</div><span class="av-ed-badge" onclick="event.stopPropagation();startAvUp('profile',_pfEditId)"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span></div>
    <input type="hidden" id="pf-edit-id">
    <div class="card"><div class="ct">åŸºæœ¬è³‡æ–™</div><div class="f"><label>åç¨±</label><input type="text" id="pf-edit-name"></div><div class="f"><label>å¹´é½¡</label><input type="number" id="pf-edit-age"></div><div class="f"><label>æ€§åˆ¥</label><div class="rp-sel" id="pf-gen" onclick="openPopup('pf-gen-pop')" style="height:44px;display:flex;align-items:center;">æœªè¨­ç½®</div></div><div class="f"><label>è·æ¥­</label><input type="text" id="pf-edit-job" placeholder="ä¾‹ï¼šå†’éšªè€…..."></div><div class="f"><label>è¨­å®š</label><textarea rows="10" id="pf-edit-setting" oninput="cntF(this)"></textarea><div class="ctr">0 å­—</div></div></div>
  </div>
</div></div>
<!-- ç³»çµ± -->
<div class="pnl" id="p-sys"><div class="scr">
  <div class="sh"><div class="sht">ç³»çµ±</div></div>
  <div class="snv"><div class="sbb a" onclick="ss(this,0)">è¨­å®š</div><div class="sbb" onclick="ss(this,1)">æç¤ºè©</div><div class="sbb" onclick="ss(this,2)">è¨˜æ†¶ç®¡ç†</div></div>
  <div class="sp a" id="s0">
    <div class="card"><div class="stt">API è¨­å®š</div><div id="api-cfg-list"></div><button class="btn bs2" onclick="addApiCfg()" style="margin-top:8px;">+ æ–°å¢</button></div>
    <div class="card"><div class="stt">ç”Ÿæˆåƒæ•¸</div><div class="f"><label>Temperature</label><div class="sr"><input type="range" id="set-temp" min="0" max="100" value="80" oninput="this.nextElementSibling.textContent=(this.value/100).toFixed(2)"><span class="svl">0.80</span></div></div><div class="fr"><div class="f"><label>Max Input</label><input type="number" id="set-maxin" value="20000"></div><div class="f"><label>Max Output</label><input type="number" id="set-maxout" value="1200"></div></div></div>
    <div class="card"><div class="stt">ä¸»é¡Œé¡è‰²</div><div class="theme-row"><div class="theme-dot" data-theme="" style="background:linear-gradient(135deg,#7c9eb2,#e4eef3);" onclick="setTh('',this)"></div><div class="theme-dot" data-theme="theme-warm" style="background:linear-gradient(135deg,#c0705a,#f0ddd6);" onclick="setTh('theme-warm',this)"></div><div class="theme-dot" data-theme="theme-sage" style="background:linear-gradient(135deg,#6b9080,#dce8e2);" onclick="setTh('theme-sage',this)"></div><div class="theme-dot" data-theme="theme-lavender" style="background:linear-gradient(135deg,#8b7fb5,#e2dff0);" onclick="setTh('theme-lavender',this)"></div><div class="theme-dot" data-theme="theme-rose" style="background:linear-gradient(135deg,#b5707e,#f0dde2);" onclick="setTh('theme-rose',this)"></div><div class="theme-dot" data-theme="theme-ocean" style="background:linear-gradient(135deg,#5088a8,#d4e4f0);" onclick="setTh('theme-ocean',this)"></div></div><div class="theme-row" style="margin-top:8px;"><div class="theme-dot" data-theme="theme-dark" style="background:linear-gradient(135deg,#1a1a2e,#7c9eb2);" onclick="setTh('theme-dark',this)"></div><div class="theme-dot" data-theme="theme-dark-warm" style="background:linear-gradient(135deg,#1e1a18,#c0705a);" onclick="setTh('theme-dark-warm',this)"></div><div class="theme-dot" data-theme="theme-dark-green" style="background:linear-gradient(135deg,#161e1a,#6b9080);" onclick="setTh('theme-dark-green',this)"></div><div class="theme-dot" data-theme="theme-midnight" style="background:linear-gradient(135deg,#0f1118,#8b7fb5);" onclick="setTh('theme-midnight',this)"></div><div class="theme-dot" data-theme="theme-black" style="background:linear-gradient(135deg,#000000,#333333);" onclick="setTh('theme-black',this)"></div></div></div>
    <div style="margin-top:12px;"><button class="btn bp" onclick="saveSettings()">å„²å­˜</button></div>
  </div>
  <div class="sp" id="s1"><div class="pl" id="pl"></div><button class="btn bs2" onclick="createPr()" style="margin-bottom:12px;">+ æ–°å¢</button><div class="card" id="pr-edit" style="display:none;"><input type="hidden" id="pe-id"><div class="f"><label>åç¨±</label><input type="text" id="pn"></div><div class="f"><label>ä½¿ç”¨ API</label><div class="rp-sel" id="pr-api-btn" onclick="openPopup('pr-api-pop')">æœªé¸æ“‡</div><input type="hidden" id="pr-api-id" value=""></div><div class="f"><label>é¸æ“‡æ¨¡å‹</label><div class="rp-sel" id="pr-model-btn" onclick="openPopup('pr-model-pop')">æœªé¸æ“‡</div><input type="hidden" id="pr-model-id" value=""></div><div class="f"><label>å…§å®¹</label><textarea rows="10" id="tp2" oninput="cntF(this)"></textarea><div class="ctr">0 å­—</div></div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="savePr()">å„²å­˜</button><button class="btn bdel bs2" onclick="delPr()">åˆªé™¤</button></div></div></div>
  <div class="sp" id="s2">
  <div class="card"><div class="stt">è‡ªå‹•æ‘˜è¦</div><div class="f" style="display:flex;align-items:center;gap:10px;"><label style="flex:1;">å•Ÿç”¨è‡ªå‹•æ‘˜è¦</label><div class="tog" id="set-sum-auto" onclick="this.classList.toggle('on')"></div></div><div class="f"><label>æ¯å¹¾æ¬¡ AI å›è¦†è‡ªå‹•æ‘˜è¦</label><input type="number" id="set-sum-interval" value="10" min="3" placeholder="10"></div><div class="f"><label>ä½¿ç”¨ API</label><div class="rp-sel" id="sum-api-btn" onclick="openPopup('sum-api-pop')">æœªé¸æ“‡</div><input type="hidden" id="sum-api-id" value=""></div><div class="f"><label>é¸æ“‡æ¨¡å‹</label><div class="rp-sel" id="sum-model-btn" onclick="openPopup('sum-model-pop')">æœªé¸æ“‡</div><input type="hidden" id="sum-model-id" value=""></div><div class="f"><label>æ‘˜è¦æç¤ºè©</label><textarea rows="4" id="sum-prompt" placeholder="ä½ æ˜¯ä¸€å€‹å°è©±æ‘˜è¦åŠ©æ‰‹ã€‚è«‹å°‡ä»¥ä¸‹è§’è‰²æ‰®æ¼”å°è©±æ¿ƒç¸®æˆä¸€ä»½ç°¡æ½”çš„æ‘˜è¦ï¼Œä¿ç•™é‡è¦çš„åŠ‡æƒ…ç™¼å±•ã€è§’è‰²é—œä¿‚è®ŠåŒ–å’Œé—œéµäº‹ä»¶ã€‚æ‘˜è¦å¿…é ˆæ§åˆ¶åœ¨ 500 tokens ä»¥å…§ã€‚ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚" oninput="cntF(this)"></textarea><div class="ctr">0 å­—</div></div></div>
  <div class="card"><div class="stt">è¨˜æ†¶ç”Ÿæˆ</div><div class="f"><label>ä½¿ç”¨ API</label><div class="rp-sel" id="mem-api-btn" onclick="openPopup('mem-api-pop')">æœªé¸æ“‡</div><input type="hidden" id="mem-api-id" value=""></div><div class="f"><label>é¸æ“‡æ¨¡å‹</label><div class="rp-sel" id="mem-model-btn" onclick="openPopup('mem-model-pop')">æœªé¸æ“‡</div><input type="hidden" id="mem-model-id" value=""></div><div class="f"><label>ç”ŸæˆæŒ‡ä»¤</label><textarea rows="4" id="mem-prompt" placeholder="å¾ä»¥ä¸‹å°è©±ä¸­æå–é‡è¦è¨˜æ†¶..." oninput="cntF(this)"></textarea><div class="ctr">0 å­—</div></div><div class="f"><label>è§¸ç™¼è¦å‰‡ï¼ˆæ¯ N å‰‡å°è©±ç”Ÿæˆä¸€æ¬¡ï¼‰</label><input type="number" id="mem-rule" value="10" min="1" placeholder="ä¾‹ï¼š10"></div></div>
  <div class="card"><div class="stt">æœ¬åœ°å‘é‡ Embedding</div>
  <div style="font-size:13px;color:var(--tx2);line-height:1.6;margin-bottom:12px;">ä½¿ç”¨ transformers.js åœ¨ç€è¦½å™¨æœ¬åœ°é‹è¡Œ Embedding æ¨¡å‹ï¼ˆç´„ 23MBï¼‰ã€‚é¦–æ¬¡è¼‰å…¥éœ€è¦ä¸‹è¼‰æ¨¡å‹ï¼Œä¹‹å¾Œæœƒå¿«å–åœ¨ç€è¦½å™¨ä¸­ã€‚</div>
  <div class="f" style="display:flex;align-items:center;gap:10px;"><label style="flex:1;">å•Ÿç”¨æœ¬åœ°å‘é‡æœå°‹</label><div class="tog" id="set-emb-local" onclick="this.classList.toggle('on')"></div></div>
  <div class="stt" style="margin-top:10px;">æœå°‹åƒæ•¸</div><div class="f"><label>ç›¸ä¼¼åº¦é–€æª»ï¼ˆè¶Šä½æ’ˆè¶Šå¤šï¼‰</label><div class="sr"><input type="range" id="set-vec-threshold" min="0" max="90" value="30" oninput="this.nextElementSibling.textContent=(this.value/100).toFixed(2)"><span class="svl">0.30</span></div></div><div class="fr"><div class="f"><label>é™„åŠ è³‡è¨Šç­†æ•¸</label><input type="number" id="set-vec-extras" value="3" min="1" max="20"></div><div class="f"><label>äº‹ä»¶ç­†æ•¸</label><input type="number" id="set-vec-events" value="3" min="1" max="20"></div><div class="f"><label>è¨˜æ†¶ç­†æ•¸</label><input type="number" id="set-vec-memories" value="5" min="1" max="30"></div></div><button class="btn bs2" onclick="rebuildAllEmb()" style="width:100%;margin-top:8px;background:var(--bg3);border:1px solid var(--bd);color:var(--tx2);">ğŸ”„ é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡</button></div>
  <div style="margin-top:12px;"><button class="btn bp" onclick="saveMemSettings()">å„²å­˜</button></div>
  </div>
</div></div>
</div>
<!-- é€£ç·šé é¢ â†’ æ”¹ç‚ºæœ¬åœ°å„²å­˜ç®¡ç† -->
<div class="pnl" id="p-conn"><div class="scr">
  <div class="sh"><div class="sht">å„²å­˜ç®¡ç†</div></div>
  <div class="card"><div class="stt">æœ¬åœ°å„²å­˜ç‹€æ…‹</div>
  <div style="font-size:14px;color:var(--tx);line-height:1.8;" id="storage-info">è¨ˆç®—ä¸­...</div>
  <button class="btn bs2" onclick="calcStorageInfo()" style="margin-top:8px;">é‡æ–°è¨ˆç®—</button>
  </div>
  <div class="card" style="background:transparent;border:none;box-shadow:none;padding:0;"><div style="font-size:13px;color:var(--tx2);line-height:1.6;">æ‰€æœ‰è³‡æ–™å„²å­˜åœ¨ç€è¦½å™¨ IndexedDB ä¸­ï¼Œç„¡éœ€ç¶²è·¯é€£ç·šã€‚<br>æ¸…é™¤ç€è¦½å™¨è³‡æ–™æœƒæ¸…é™¤æ‰€æœ‰ RP è³‡æ–™ï¼Œè«‹å®šæœŸåŒ¯å‡ºå‚™ä»½ã€‚</div></div>
  <div class="card"><div class="stt">åŒ¯å‡º / åŒ¯å…¥</div>
  <div style="display:flex;flex-direction:column;gap:8px;">
  <button class="btn bs2" onclick="exportAll()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>åŒ¯å‡ºå…¨éƒ¨è³‡æ–™</button>
  <button class="btn bs2" onclick="exportChars()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>åŒ¯å‡ºæ‰€æœ‰è§’è‰²</button>
  <button class="btn bs2" onclick="exportCardV2()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/><path d="M12 11v4M10 13h4" stroke-width="1.5"/></svg>åŒ¯å‡ºè§’è‰² (Card V2)</button>
  <button class="btn bs2" onclick="exportChats()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>åŒ¯å‡ºæ‰€æœ‰å°è©±</button>
  <div style="border-top:1px solid var(--bd);margin:4px 0;"></div>
  <button class="btn bs2" onclick="$('import-file').click()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px;"><svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>åŒ¯å…¥ JSON</button>
  <input type="file" id="import-file" accept=".json,.png" style="display:none;" onchange="importFile(this)">
  <div style="font-size:12px;color:var(--tx2);line-height:1.5;">æ”¯æ´æ ¼å¼ï¼šReverie å‚™ä»½ JSONï¼ˆé›²ç«¯ç‰ˆ/æœ¬åœ°ç‰ˆé€šç”¨ï¼‰ã€Character Card V2 JSON/PNGã€‚</div>
  </div></div>
  <div class="card"><div class="stt" style="color:#c0705a;">å±éšªå€åŸŸ</div>
  <button class="btn bdel bs2" onclick="clearAllData()" style="width:100%;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
  <div style="font-size:12px;color:var(--tx2);margin-top:8px;">æ­¤æ“ä½œä¸å¯å¾©åŸï¼Œè«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</div>
  </div>
</div></div>
<!-- Sidebar -->
<div class="side-overlay" id="sov" onclick="closeSide()"></div>
<div class="sidebar" id="sbar"><div class="side-title">å°è©±è¨­å®š</div><div class="side-section">ç©å®¶æª”æ¡ˆ</div><div class="side-profile-active" id="side-player" onclick="openPopup('pp-pop')"><div class="av" style="width:28px;height:28px;font-size:12px;">?</div><span>æœªé¸æ“‡</span><span class="switch-hint">åˆ‡æ› â–¸</span></div><div class="side-section">ç®¡ç†</div><div class="side-item" onclick="renameChatInline();closeSide();"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>é‡æ–°å‘½å</div><div class="side-item" onclick="openChatEvents();closeSide();"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>äº‹ä»¶</div><div class="side-item" onclick="openChatMemory();closeSide();"><svg viewBox="0 0 24 24"><path d="M12 2a5 5 0 00-4.8 3.6A4 4 0 004 9.5a4 4 0 00.7 5.1A5 5 0 007 20h1v-8"/><path d="M12 2a5 5 0 014.8 3.6A4 4 0 0120 9.5a4 4 0 01-.7 5.1A5 5 0 0117 20h-1v-8"/><path d="M8 14c2-1 4-1 4-1s2 0 4 1"/></svg>è¨˜æ†¶é«”</div><div class="side-item" onclick="openSummary();closeSide();"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>æ­·å²æ‘˜è¦</div><div class="side-item danger" onclick="delCurrentChat();"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>åˆªé™¤</div></div>
<!-- Popups -->
<div class="popup-ov" id="gen-pop" onclick="if(event.target===this)closePopup('gen-pop')"><div class="popup"><div class="popup-title">é¸æ“‡æ€§åˆ¥</div><div class="popup-item" onclick="pickGen(this,'ç”·æ€§')"><span>ç”·æ€§</span><span class="check">âœ“</span></div><div class="popup-item" onclick="pickGen(this,'å¥³æ€§')"><span>å¥³æ€§</span><span class="check">âœ“</span></div><div class="popup-item active" onclick="pickGen(this,'æœªè¨­ç½®')"><span>æœªè¨­ç½®</span><span class="check">âœ“</span></div></div></div>
<div class="popup-ov" id="pf-gen-pop" onclick="if(event.target===this)closePopup('pf-gen-pop')"><div class="popup"><div class="popup-title">é¸æ“‡æ€§åˆ¥</div><div class="popup-item" onclick="pickPfGen(this,'ç”·æ€§')"><span>ç”·æ€§</span><span class="check">âœ“</span></div><div class="popup-item" onclick="pickPfGen(this,'å¥³æ€§')"><span>å¥³æ€§</span><span class="check">âœ“</span></div><div class="popup-item active" onclick="pickPfGen(this,'æœªè¨­ç½®')"><span>æœªè¨­ç½®</span><span class="check">âœ“</span></div></div></div>
<div class="popup-ov" id="rp-popup" onclick="if(event.target===this)closePopup('rp-popup')"><div class="popup"><div class="popup-title">èŠå¤©æ¨¡å¼</div><div id="rp-list"></div></div></div>
<div class="popup-ov" id="pp-pop" onclick="if(event.target===this)closePopup('pp-pop')"><div class="popup"><div class="popup-title">åˆ‡æ›ç©å®¶æª”æ¡ˆ</div><div id="pp-list"></div></div></div>
<div class="popup-ov" id="newchat-pop" onclick="if(event.target===this)closePopup('newchat-pop')"><div class="popup"><div class="popup-title">é¸æ“‡è§’è‰²é–‹å§‹å°è©±</div><div id="newchat-list"></div></div></div>
<div class="popup-ov" id="chat-setup-pop" onclick="if(event.target===this)closePopup('chat-setup-pop')"><div class="popup" style="min-width:280px;"><div class="popup-title">å°è©±è¨­å®š</div><div style="padding:4px 0 8px;"><div style="font-size:13px;color:var(--tx2);margin-bottom:6px;">ç©å®¶æª”æ¡ˆ</div><div id="setup-pf-list"></div><div style="font-size:13px;color:var(--tx2);margin:12px 0 6px;">èŠå¤©æ¨¡å¼</div><div id="setup-rp-list"></div></div><div style="padding:8px 0 4px;"><button class="btn bp" style="width:100%;" onclick="confirmChatSetup()">é–‹å§‹å°è©±</button></div></div></div>
<div class="popup-ov" id="pr-api-pop" onclick="if(event.target===this)closePopup('pr-api-pop')"><div class="popup"><div class="popup-title">é¸æ“‡ API</div><div id="pr-api-list"></div></div></div>
<div class="popup-ov" id="pr-model-pop" onclick="if(event.target===this)closePopup('pr-model-pop')"><div class="popup"><div class="popup-title">é¸æ“‡æ¨¡å‹</div><div id="pr-model-list"></div></div></div>
<div class="popup-ov" id="sum-api-pop" onclick="if(event.target===this)closePopup('sum-api-pop')"><div class="popup"><div class="popup-title">æ‘˜è¦ API</div><div id="sum-api-list"></div></div></div>
<div class="popup-ov" id="sum-model-pop" onclick="if(event.target===this)closePopup('sum-model-pop')"><div class="popup"><div class="popup-title">æ‘˜è¦æ¨¡å‹</div><div id="sum-model-list"></div></div></div>
<div class="popup-ov" id="mem-api-pop" onclick="if(event.target===this)closePopup('mem-api-pop')"><div class="popup"><div class="popup-title">è¨˜æ†¶ API</div><div id="mem-api-list"></div></div></div>
<div class="popup-ov" id="mem-model-pop" onclick="if(event.target===this)closePopup('mem-model-pop')"><div class="popup"><div class="popup-title">è¨˜æ†¶æ¨¡å‹</div><div id="mem-model-list"></div></div></div>
<div class="popup-ov" id="provider-pop" onclick="if(event.target===this)closePopup('provider-pop')"><div class="popup"><div class="popup-title">é¸æ“‡ä¾›æ‡‰å•†</div><div class="popup-item active" onclick="pickSel('acfg-provider','anthropic','Anthropic',this,'provider-pop')"><span>Anthropic</span><span class="check">âœ“</span></div><div class="popup-item" onclick="pickSel('acfg-provider','openai','OpenAI',this,'provider-pop')"><span>OpenAI</span><span class="check">âœ“</span></div><div class="popup-item" onclick="pickSel('acfg-provider','google','Google',this,'provider-pop')"><span>Google</span><span class="check">âœ“</span></div><div class="popup-item" onclick="pickSel('acfg-provider','openrouter','OpenRouter',this,'provider-pop')"><span>OpenRouter</span><span class="check">âœ“</span></div></div></div>
<!-- Full Pages (same as original) -->
<div class="fp" id="fp-sum"><div class="fp-head"><span class="bk" onclick="closeFP('fp-sum')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">æ­·å²æ‘˜è¦</div><button class="btn bp bs2" onclick="genSummary()">ç”Ÿæˆ</button></div><div class="fp-body full"><div class="f"><label>æ‘˜è¦å…§å®¹ï¼ˆâ‰¤ 500 tokensï¼‰</label><textarea rows="30" id="sum-ta" oninput="cntF(this)" style="min-height:50vh;" placeholder="é»æ“Šã€Œç”Ÿæˆæ‘˜è¦ã€æˆ–æ‰‹å‹•ç·¨è¼¯..."></textarea><div class="ctr">0 å­—</div></div><div style="padding:0 16px;"><button class="btn bp bs2" onclick="saveSummary()">å„²å­˜</button></div></div></div>
<div class="fp" id="fp-chat-ev"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-ev')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">äº‹ä»¶ç®¡ç†</div></div><div class="fp-body" id="chat-ev-body"></div></div>
<div class="fp" id="fp-chat-ev-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-ev-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">ç·¨è¼¯äº‹ä»¶</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveChatEv()">å„²å­˜</button><button class="btn bdel bs2" onclick="delChatEv()">åˆªé™¤</button></div></div><div class="fp-body full"><input type="hidden" id="cev2-id"><div class="f"><label>åç¨±</label><input type="text" id="cev2-n"></div><div class="f"><label>è§¸ç™¼é—œéµå­— / æ™‚é–“</label><input type="text" id="cev2-t"></div><div class="f"><label>å…§å®¹</label><textarea rows="30" id="cev2-c" oninput="cntF(this)" style="min-height:280px;"></textarea><div class="ctr">0 å­—</div></div></div></div>
<div class="fp" id="fp-chat-mem"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-mem')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">è¨˜æ†¶é«”</div><button class="btn bp bs2" onclick="newChatMem()">+ æ–°å¢</button></div><div class="fp-body" id="chat-mem-body"></div></div>
<div class="fp" id="fp-chat-mem-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-chat-mem-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">ç·¨è¼¯è¨˜æ†¶</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveChatMem()">å„²å­˜</button><button class="btn bdel bs2" onclick="delChatMem()">åˆªé™¤</button></div></div><div class="fp-body full"><input type="hidden" id="cmem-id"><input type="hidden" id="cmem-src" value="db"><div class="f"><label>å…§å®¹</label><textarea rows="30" id="cmem-c" oninput="cntF(this)" style="min-height:220px;"></textarea><div class="ctr">0 å­—</div></div></div></div>
<div class="fp" id="fp-cev"><div class="fp-head"><span class="bk" onclick="closeFP('fp-cev')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title" id="cev-t">é è¨­äº‹ä»¶</div><button class="btn bp bs2" onclick="newCEv()">+ æ–°å¢</button></div><div class="fp-body" id="cev-body"></div></div>
<div class="fp" id="fp-cev-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-cev-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">ç·¨è¼¯äº‹ä»¶</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveCEv()">å„²å­˜</button><button class="btn bdel bs2" onclick="delCEv()">åˆªé™¤</button></div></div><div class="fp-body full"><input type="hidden" id="ev-id"><div class="f"><label>åç¨±</label><input type="text" id="ev-n"></div><div class="f"><label>æ™‚é–“ / é—œéµå­—</label><input type="text" id="ev-t"></div><div class="f"><label>å…§å®¹</label><textarea rows="30" id="ev-c" oninput="cntF(this)" style="min-height:280px;"></textarea><div class="ctr">0 å­—</div></div></div></div>
<div class="fp" id="fp-pcmd-d"><div class="fp-head"><span class="bk" onclick="closeFP('fp-pcmd-d')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">ç·¨è¼¯å¸¸é§æŒ‡ä»¤</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="savePcmd()">å„²å­˜</button><button class="btn bdel bs2" onclick="delPcmd()">åˆªé™¤</button></div></div><div class="fp-body full"><input type="hidden" id="pcmd-id"><div class="f"><label>åç¨±</label><input type="text" id="pcmd-name" placeholder="ä¾‹ï¼šåŠ å¼·æƒ…ç·’æå¯«"></div><div class="f"><label>æŒ‡ä»¤å…§å®¹</label><textarea rows="10" id="pcmd-content" oninput="cntF(this)" placeholder="é€™æ®µæ–‡å­—æœƒéš¨æ¯æ¬¡è¨Šæ¯ä¸€èµ·å‚³çµ¦ AI..."></textarea><div class="ctr">0 å­—</div></div></div></div>
<div class="fp" id="fp-api-cfg"><div class="fp-head"><span class="bk" onclick="closeFP('fp-api-cfg')" style="margin:0;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></span><div class="fp-title">ç·¨è¼¯ API</div><div style="display:flex;gap:6px;"><button class="btn bp bs2" onclick="saveApiCfg()">å„²å­˜</button><button class="btn bdel bs2" onclick="delApiCfg()">åˆªé™¤</button></div></div><div class="fp-body full"><input type="hidden" id="acfg-id"><div class="f"><label>åç¨±</label><input type="text" id="acfg-name" placeholder="ä¾‹ï¼šAnthropic ä¸»åŠ›"></div><div class="f"><label>ä¾›æ‡‰å•†</label><div class="rp-sel" id="acfg-provider-btn" onclick="openPopup('provider-pop')">Anthropic</div><input type="hidden" id="acfg-provider" value="anthropic"></div><div class="f"><label>API Key</label><input type="password" id="acfg-key" placeholder="sk-..." style="font-family:monospace;"></div><div style="padding-top:8px;"><button class="btn bs2" onclick="testApiConn()" id="acfg-test-btn" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx2);">ğŸ”Œ æ¸¬è©¦é€£ç·š</button><div id="acfg-test-result" style="margin-top:8px;font-size:13px;display:none;"></div></div></div></div>
<!-- Nav -->
<div class="nav-w" id="navw"><div class="nav-i">
  <div class="nv a" data-p="chat" onclick="nav(this)"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>èŠå¤©</div>
  <div class="nv" data-p="chars" onclick="nav(this)"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>è§’è‰²</div>
  <div class="nv" data-p="prof" onclick="nav(this)"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>æª”æ¡ˆ</div>
  <div class="nv" data-p="sys" onclick="nav(this)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>ç³»çµ±</div>
  <div class="nv" data-p="conn" onclick="nav(this)"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>å‚™ä»½</div>
</div></div>
<script>
// === IndexedDB Data Layer ===
const DB_NAME='reverie_local',DB_VER=1;let _db=null;
function openDB(){return new Promise((res,rej)=>{if(_db){res(_db);return;}const req=indexedDB.open(DB_NAME,DB_VER);req.onupgradeneeded=e=>{const db=e.target.result;['characters','character_extras','character_events','profiles','prompts','chats','messages','chat_events','chat_creator_event_toggles','memories','settings','api_configs','persistent_commands','avatars'].forEach(s=>{if(!db.objectStoreNames.contains(s)){const st=db.createObjectStore(s,{keyPath:'id'});if(s==='character_extras'||s==='character_events')st.createIndex('character_id','character_id');if(s==='messages')st.createIndex('chat_id','chat_id');if(s==='chat_events'||s==='memories')st.createIndex('chat_id','chat_id');if(s==='chat_creator_event_toggles')st.createIndex('chat_id','chat_id');}});};req.onsuccess=e=>{_db=e.target.result;res(_db);};req.onerror=e=>rej(e.target.error);});}
async function dbPut(s,o){const db=await openDB();return new Promise((r,j)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).put(o);tx.oncomplete=()=>r(o);tx.onerror=e=>j(e.target.error);});}
async function dbGet(s,id){const db=await openDB();return new Promise((r,j)=>{const rq=db.transaction(s,'readonly').objectStore(s).get(id);rq.onsuccess=()=>r(rq.result||null);rq.onerror=e=>j(e.target.error);});}
async function dbDel(s,id){const db=await openDB();return new Promise((r,j)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).delete(id);tx.oncomplete=()=>r();tx.onerror=e=>j(e.target.error);});}
async function dbAll(s){const db=await openDB();return new Promise((r,j)=>{const rq=db.transaction(s,'readonly').objectStore(s).getAll();rq.onsuccess=()=>r(rq.result||[]);rq.onerror=e=>j(e.target.error);});}
async function dbByIndex(s,idx,val){const db=await openDB();return new Promise((r,j)=>{const rq=db.transaction(s,'readonly').objectStore(s).index(idx).getAll(val);rq.onsuccess=()=>r(rq.result||[]);rq.onerror=e=>j(e.target.error);});}
async function dbClear(s){const db=await openDB();return new Promise((r,j)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).clear();tx.oncomplete=()=>r();tx.onerror=e=>j(e.target.error);});}
function sortBy(a,f,d='asc'){return[...a].sort((x,y)=>{const va=x[f]??0,vb=y[f]??0;return d==='asc'?(va>vb?1:va<vb?-1:0):(va<vb?1:va>vb?-1:0);});}
function uid(){return crypto.randomUUID?crypto.randomUUID():('id_'+Date.now()+'_'+Math.random().toString(36).slice(2,8));}
async function saveAvatar(key,file){return new Promise((r,j)=>{const rd=new FileReader();rd.onload=async()=>{await dbPut('avatars',{id:key,blob:rd.result,type:file.type,ts:Date.now()});r(rd.result);};rd.onerror=j;rd.readAsDataURL(file);});}

// === Local Embedding ===
let _embPipeline=null,_embLoading=false;
async function loadEmbeddingModel(){if(_embPipeline)return _embPipeline;if(_embLoading)return new Promise(r=>{const iv=setInterval(()=>{if(_embPipeline){clearInterval(iv);r(_embPipeline);}},200);});_embLoading=true;const prog=$('emb-prog'),fill=$('emb-prog-fill'),txt=$('emb-prog-text');prog.classList.add('show');txt.textContent='è¼‰å…¥ Embedding æ¨¡å‹ä¸­...';fill.style.width='5%';try{const{pipeline}=await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');txt.textContent='ä¸‹è¼‰æ¨¡å‹æ¬Šé‡...';fill.style.width='20%';_embPipeline=await pipeline('feature-extraction','Xenova/all-MiniLM-L6-v2',{progress_callback:p=>{if(p.status==='progress'&&p.progress)fill.style.width=Math.round(20+p.progress*0.75)+'%';}});fill.style.width='100%';txt.textContent='âœ… å°±ç·’';setTimeout(()=>prog.classList.remove('show'),1500);}catch(e){console.error(e);txt.textContent='âŒ å¤±æ•—';setTimeout(()=>prog.classList.remove('show'),3000);_embLoading=false;return null;}_embLoading=false;return _embPipeline;}
async function getEmbedding(text){if(!getSettings().emb_local)return null;const pipe=await loadEmbeddingModel();if(!pipe)return null;try{const out=await pipe(text.substring(0,512),{pooling:'mean',normalize:true});return Array.from(out.data);}catch(e){return null;}}
function cosineSim(a,b){if(!a||!b||a.length!==b.length)return 0;let d=0,na=0,nb=0;for(let i=0;i<a.length;i++){d+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i];}return d/(Math.sqrt(na)*Math.sqrt(nb)+1e-8);}
async function embedAndPatch(store,id,text){const emb=await getEmbedding(text);if(!emb)return;const obj=await dbGet(store,id);if(!obj)return;obj.embedding=emb;await dbPut(store,obj);}
async function vectorSearch(store,indexField,indexVal,queryEmb,count,threshold){if(!queryEmb)return[];threshold=threshold||0.3;count=count||5;let items=indexField&&indexVal?await dbByIndex(store,indexField,indexVal):await dbAll(store);return items.filter(x=>x.embedding).map(x=>({...x,similarity:cosineSim(queryEmb,x.embedding)})).filter(x=>x.similarity>=threshold).sort((a,b)=>b.similarity-a.similarity).slice(0,count);}
async function rebuildAllEmb(){if(!getSettings().emb_local){toast('è«‹å…ˆå•Ÿç”¨');return;}if(!await cfm('é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡ï¼Ÿ'))return;const pipe=await loadEmbeddingModel();if(!pipe)return;let c=0;toast('è™•ç†ä¸­...');for(const x of await dbAll('character_extras')){await embedAndPatch('character_extras',x.id,(x.title||'')+' '+(x.content||''));c++;}for(const x of await dbAll('character_events')){await embedAndPatch('character_events',x.id,(x.name||'')+' '+(x.time_or_keyword||'')+' '+(x.content||''));c++;}for(const x of await dbAll('memories')){await embedAndPatch('memories',x.id,x.content||'');c++;}toast('âœ… '+c+' ç­†');}

// === Storage Info ===
async function calcStorageInfo(){const el=$('storage-info');el.textContent='è¨ˆç®—ä¸­...';try{const stores=['characters','character_extras','character_events','profiles','prompts','chats','messages','chat_events','memories','api_configs','persistent_commands','avatars'];let lines=[],total=0;for(const s of stores){const n=(await dbAll(s)).length;total+=n;lines.push(s+': '+n+' ç­†');}if(navigator.storage&&navigator.storage.estimate){const est=await navigator.storage.estimate();lines.unshift('ç©ºé–“: '+((est.usage||0)/1048576).toFixed(1)+' / '+((est.quota||0)/1048576).toFixed(0)+' MB');}lines.push('ç¸½è¨ˆ: '+total+' ç­†');el.innerHTML=lines.join('<br>');}catch(e){el.textContent='å¤±æ•—';}}
async function clearAllData(){if(!await cfm('âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ'))return;if(!await cfm('å†æ¬¡ç¢ºèªï¼Ÿ'))return;for(const s of['characters','character_extras','character_events','profiles','prompts','chats','messages','chat_events','chat_creator_event_toggles','memories','settings','api_configs','persistent_commands','avatars'])try{await dbClear(s);}catch(e){}localStorage.removeItem('rp_av_off');toast('å·²æ¸…é™¤');location.reload();}
// === Core UI ===
const $=id=>document.getElementById(id);marked.setOptions({breaks:true,gfm:true});const _renderer=new marked.Renderer();_renderer.heading=function(tok){return '<p>'+(typeof tok==='string'?tok:(tok.text||''))+'</p>\n';};marked.use({renderer:_renderer});
function tok(s){if(!s)return 0;let t=0;for(let i=0;i<s.length;i++){const c=s.charCodeAt(i);if(c>0x2E7F)t+=1.5;else if(c===32||c===10)t+=0;else t+=0.35;}return Math.ceil(t);}
function cntF(ta){const l=ta.value.length,t=tok(ta.value);const c=ta.parentElement.querySelector('.ctr');if(c)c.textContent=l+' å­— Â· â‰ˆ '+t+' tokens';}
function toast(m){const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function avH(url,name,sz,ox,oy){sz=sz||40;ox=ox||0;oy=oy||0;const st='width:'+sz+'px;height:'+sz+'px;font-size:'+Math.round(sz*.38)+'px;';if(url){const p=ox||oy?'object-position:'+(50+ox)+'% '+(50+oy)+'%':'';return '<div class="av" style="'+st+'"><img src="'+url+'" style="'+p+'"></div>';}return '<div class="av" style="'+st+'">'+esc((name||'?')[0])+'</div>';}
let _cfm=null;function cfm(msg){return new Promise(r=>{_cfm=r;$('cfm-msg').textContent=msg;$('cfm-ov').classList.add('show');});}function cfmR(v){$('cfm-ov').classList.remove('show');if(_cfm)_cfm(v);_cfm=null;}
let _inp=null;function inp(msg,def){return new Promise(r=>{_inp=r;$('inp-msg').textContent=msg;$('inp-val').value=def||'';$('inp-ov').classList.add('show');setTimeout(()=>$('inp-val').focus(),100);});}function inpR(v){$('inp-ov').classList.remove('show');if(_inp)_inp(v);_inp=null;}

// === Nav ===
const navEl=$('navw'),mainEl=$('main');function showNav(){navEl.classList.remove('hide');mainEl.classList.remove('np');}function hideNav(){navEl.classList.add('hide');mainEl.classList.add('np');}
let hs=['main'];function pushH(id){hs.push(id);history.pushState({p:id},'');}
window.addEventListener('popstate',()=>{hs.pop();const p=hs[hs.length-1]||'main';const fps=document.querySelectorAll('.fp.show');if(fps.length>0){fps[fps.length-1].classList.remove('show');return;}document.querySelectorAll('.popup-ov.show').forEach(x=>x.classList.remove('show'));$('cfm-ov').classList.remove('show');$('inp-ov').classList.remove('show');closeSideQ();hideCtx();closeBs();$('em-ov').classList.remove('show');if(p==='main'){saveChatStore();closeChat(1);closeCharEdit(1);closePfEdit();showNav();}else if(p==='chat')hideNav();});
function nav(el){document.querySelectorAll('.nv').forEach(n=>n.classList.remove('a'));el.classList.add('a');document.querySelectorAll('.pnl').forEach(x=>x.classList.remove('a'));$('p-'+el.dataset.p).classList.add('a');showNav();hs=['main'];history.replaceState({p:'main'},'');if($('cl'))$('cl').style.display='block';if($('cv'))$('cv').classList.remove('a');if($('vl')){$('vl').style.display='block';$('vd').style.display='none';}if(el.dataset.p==='chars')loadChars();if(el.dataset.p==='prof'){loadPf();closePfEdit();}if(el.dataset.p==='sys'){loadPr();syncThemeDots();}if(el.dataset.p==='chat')renderChatList();if(el.dataset.p==='conn')calcStorageInfo();}
function openChat(n){$('cl').style.display='none';$('cv').classList.add('a');$('c-name').textContent=n;hideNav();pushH('chat');closePcmdPanel();}
function closeChat(q){if(_curChat)_curChat.draft=$('c-inp').value||'';$('cl').style.display='block';$('cv').classList.remove('a');saveChatStore();if(!q){showNav();renderChatList();}}
function openSide(){$('sov').classList.add('show');$('sbar').classList.add('show');}function closeSide(){$('sov').classList.remove('show');$('sbar').classList.remove('show');}function closeSideQ(){closeSide();}
function openFP(id){$(id).classList.add('show');pushH('fp');}function closeFP(id){$(id).classList.remove('show');}
function openPopup(id){$(id).classList.add('show');}function closePopup(id){$(id).classList.remove('show');}
function ss(el,i){document.querySelectorAll('.snv .sbb').forEach(b=>b.classList.remove('a'));el.classList.add('a');document.querySelectorAll('#p-sys .sp').forEach((p,j)=>p.classList.toggle('a',j===i));_sysTab=i;}let _sysTab=0;
function setTh(c){document.body.className=c;syncThemeDots();_settings.theme=c||'default';saveSettingsObj(_settings);}
function syncThemeDots(){document.querySelectorAll('.theme-dot').forEach(d=>d.classList.toggle('active',(d.dataset.theme||'')===document.body.className));}
function showCtx(x,y,items){const m=$('ctx-menu');m.innerHTML=items.map(i=>'<div class="ctx-item" onclick="'+i.action+'">'+i.label+'</div>').join('');m.style.left=Math.min(x,innerWidth-160)+'px';m.style.top=Math.min(y,innerHeight-200)+'px';m.classList.remove('hidden');}
function hideCtx(){$('ctx-menu').classList.add('hidden');}
function bindLongPress(el,fn){let t=null,mv=false;el.addEventListener('touchstart',e=>{mv=false;t=setTimeout(()=>{if(!mv){e.preventDefault();fn(e.touches[0].clientX,e.touches[0].clientY);}},500);},{passive:false});el.addEventListener('touchmove',()=>{mv=true;clearTimeout(t);});el.addEventListener('touchend',()=>clearTimeout(t));el.addEventListener('contextmenu',e=>{e.preventDefault();fn(e.clientX,e.clientY);});}

// === Avatar Upload ===
let _avTarget=null,_avUrl=null,_charAvOx=0,_charAvOy=0,_pfAvUrl=null,_pfAvOx=0,_pfAvOy=0;
function startAvUp(type,id){_avTarget={type,id:id||null};$('av-input').click();}
async function onAvUpload(inp){if(!inp.files[0]||!_avTarget)return;const f=inp.files[0],id=_avTarget.id||$('ce-id').value,key=_avTarget.type+'_'+id;try{toast('å„²å­˜ä¸­...');const url=await saveAvatar(key,f);if(_avTarget.type==='char'){const c=await dbGet('characters',id);if(c){c.avatar_url=url;await dbPut('characters',c);}_avUrl=url;renderAvEd('char',url,_charAvOx,_charAvOy);}else{const p=await dbGet('profiles',id);if(p){p.avatar_url=url;await dbPut('profiles',p);}_pfAvUrl=url;renderAvEd('pf',url,_pfAvOx,_pfAvOy);}toast('å·²å„²å­˜');}catch(e){toast('å¤±æ•—');}inp.value='';}
function renderAvEd(type,url,ox,oy){const wrap=$(type==='char'?'ce-av-wrap':'pf-av-wrap');if(url)wrap.innerHTML='<img src="'+url+'" style="object-position:'+(50+(ox||0))+'% '+(50+(oy||0))+'%">';else wrap.innerHTML=esc('?');}
let _avOffCache={};function loadAvOff(){_avOffCache=JSON.parse(localStorage.getItem('rp_av_off')||'{}');}function saveAvOff(key,ox,oy){_avOffCache[key]={ox,oy};localStorage.setItem('rp_av_off',JSON.stringify(_avOffCache));}function getAvOff(key){return _avOffCache[key]||{ox:0,oy:0};}
function pickGen(el,v){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$('ce-gen').childNodes[0].textContent=v;closePopup('gen-pop');}
function pickSel(hid,val,label,el,popId){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$(hid).value=val;const btn=$(hid+'-btn');if(btn)btn.childNodes[0].textContent=label;closePopup(popId);}
function initDrag(container){let de=null;container.addEventListener('dragstart',e=>{const c=e.target.closest('.card');if(!c)return;de=c;c.classList.add('dragging');});container.addEventListener('dragover',e=>{e.preventDefault();const c=e.target.closest('.card');if(!c||c===de)return;const r=c.getBoundingClientRect();if(e.clientY<r.top+r.height/2)container.insertBefore(de,c);else container.insertBefore(de,c.nextSibling);});container.addEventListener('dragend',()=>{if(de)de.classList.remove('dragging');de=null;});}
function initEvDrag(container,storeName,idAttr){idAttr=idAttr||'data-evid';let de=null;container.addEventListener('dragstart',e=>{const c=e.target.closest('.ev-toggle-item');if(!c)return;de=c;c.classList.add('dragging');});container.addEventListener('dragover',e=>{e.preventDefault();const c=e.target.closest('.ev-toggle-item');if(!c||c===de)return;const r=c.getBoundingClientRect();if(e.clientY<r.top+r.height/2)container.insertBefore(de,c);else container.insertBefore(de,c.nextSibling);});container.addEventListener('dragend',async()=>{if(de)de.classList.remove('dragging');de=null;const items=container.querySelectorAll('.ev-toggle-item['+idAttr+']');for(let i=0;i<items.length;i++){const id=items[i].getAttribute(idAttr);const o=await dbGet(storeName,id);if(o){o.sort_order=i;await dbPut(storeName,o);}}toast('å·²å„²å­˜');});}
// === CHARACTERS ===
let chars=[],_charDataCache=null;
async function getCharData(cid){if(_charDataCache&&_charDataCache.charId===cid)return _charDataCache;const[c,extras,cEvs]=await Promise.all([dbGet('characters',cid),dbByIndex('character_extras','character_id',cid),dbByIndex('character_events','character_id',cid)]);_charDataCache={charId:cid,char:c,extras:sortBy(extras,'sort_order'),events:sortBy(cEvs,'sort_order')};return _charDataCache;}
async function loadChars(){chars=sortBy(await dbAll('characters'),'sort_order');renderCL();}
function renderCL(){const el=$('char-list');if(!chars.length){el.innerHTML='<div class="empty">å°šæœªå»ºç«‹è§’è‰²</div>';return;}el.innerHTML=chars.map(c=>{const ao=getAvOff('char_'+c.id);return '<div class="li" data-charid="'+c.id+'">'+avH(c.avatar_url,c.name,72,ao.ox,ao.oy).replace('class="av"','class="av av-list"')+'<div class="lb"><div class="lt">'+esc(c.name)+'</div></div><div class="li-actions"><div class="li-act" onclick="event.stopPropagation();editChar(\''+c.id+'\')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>ç·¨è¼¯</div><div class="li-act" onclick="event.stopPropagation();openCEvs(\''+c.id+'\',\''+esc(c.name)+'\')"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>äº‹ä»¶</div></div></div>';}).join('');}
async function createChar(){const c={id:uid(),name:'æ–°è§’è‰²',sort_order:chars.length,created_at:new Date().toISOString()};await dbPut('characters',c);toast('å·²æ–°å¢');await loadChars();openCEditUI(c,[]);}
async function editChar(id){openCEditUI(await dbGet('characters',id),sortBy(await dbByIndex('character_extras','character_id',id),'sort_order'));}
function openCEditUI(c,extras){_avUrl=c.avatar_url||null;const ao=getAvOff('char_'+c.id);_charAvOx=ao.ox;_charAvOy=ao.oy;$('vl').style.display='none';$('vd').style.display='block';hideNav();pushH('charDetail');$('ce-id').value=c.id;$('ce-name').value=c.name||'';$('ce-age').value=c.age||'';$('ce-job').value=c.job||'';$('ce-gen').childNodes[0].textContent=c.gender||'æœªè¨­ç½®';$('ce-set').value=c.setting||'';$('ce-scn').value=c.greeting_scenario||'';$('ce-grt').value=c.greeting_message||'';renderAvEd('char',_avUrl,_charAvOx,_charAvOy);$('ce-av-wrap').onclick=()=>startAvUp('char',c.id);cntF($('ce-set'));cntF($('ce-scn'));cntF($('ce-grt'));const el=$('ce-ex');el.innerHTML='';extras.forEach(ex=>addExUI(ex));initDrag(el);}
function addExUI(ex){ex=ex||{};const el=$('ce-ex'),n=el.children.length+1,d=document.createElement('div');d.className='card';d.style.marginBottom='8px';d.dataset.exId=ex.id||'';d.innerHTML='<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;"><span class="drag-h">â ¿</span><div class="f" style="margin:0;flex:1;"><label>#'+n+'</label><input type="text" value="'+esc(ex.title||'')+'" placeholder="æ¨™é¡Œ"></div><button class="btn bs2" style="color:#c0705a;border:0;" onclick="rmEx(this)">âœ•</button></div><div class="f" style="margin:0;"><textarea rows="10" oninput="cntF(this)" placeholder="å…§å®¹">'+esc(ex.content||'')+'</textarea><div class="ctr">0 å­—</div></div>';el.appendChild(d);}
async function rmEx(btn){const c=btn.closest('.card'),eid=c.dataset.exId;if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;if(eid)await dbDel('character_extras',eid);c.remove();}
async function saveChar(){const id=$('ce-id').value;const c=await dbGet('characters',id)||{id};Object.assign(c,{name:$('ce-name').value.trim()||'æœªå‘½å',age:parseInt($('ce-age').value)||null,gender:$('ce-gen').textContent.trim(),job:$('ce-job').value.trim()||null,setting:$('ce-set').value,greeting_scenario:$('ce-scn').value,greeting_message:$('ce-grt').value});await dbPut('characters',c);saveAvOff('char_'+id,_charAvOx,_charAvOy);
const cards=$('ce-ex').querySelectorAll('.card');
for(let i=0;i<cards.length;i++){const cd=cards[i],eid=cd.dataset.exId,ti=cd.querySelector('input[type="text"]').value,co=cd.querySelector('textarea').value;if(eid){const ex=await dbGet('character_extras',eid)||{id:eid};Object.assign(ex,{character_id:id,title:ti,content:co,sort_order:i});await dbPut('character_extras',ex);}else{const nid=uid();cd.dataset.exId=nid;await dbPut('character_extras',{id:nid,character_id:id,title:ti,content:co,sort_order:i});}}
toast('å·²å„²å­˜');loadChars();_charDataCache=null;}
async function delChar(){if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;const id=$('ce-id').value;await dbDel('characters',id);for(const x of await dbByIndex('character_extras','character_id',id))await dbDel('character_extras',x.id);for(const x of await dbByIndex('character_events','character_id',id))await dbDel('character_events',x.id);toast('å·²åˆªé™¤');closeCharEdit();await loadChars();_charDataCache=null;}
function closeCharEdit(q){$('vl').style.display='block';$('vd').style.display='none';_avUrl=null;if(!q)showNav();}

// === Character Events ===
let _cevCid=null;
async function openCEvs(cid,name){_cevCid=cid;$('cev-t').textContent=(name||'')+' é è¨­äº‹ä»¶';const evs=sortBy(await dbByIndex('character_events','character_id',cid),'sort_order');const b=$('cev-body');b.innerHTML='';if(!evs.length){b.innerHTML='<div class="empty">å°šæœªå»ºç«‹</div>';openFP('fp-cev');return;}evs.forEach(ev=>{b.innerHTML+='<div class="ev-toggle-item" data-evid="'+ev.id+'"><div class="lb" onclick="openCEvD(\''+ev.id+'\')"><div class="lt">'+esc(ev.name)+'</div><div class="ls">'+esc(ev.time_or_keyword||'')+' Â· '+(ev.content||'').length+' å­—</div></div></div>';});initEvDrag(b,'character_events','data-evid');openFP('fp-cev');}
function newCEv(){$('ev-id').value='';$('ev-n').value='';$('ev-t').value='';$('ev-c').value='';openFP('fp-cev-d');}
async function openCEvD(id){const ev=await dbGet('character_events',id);$('ev-id').value=ev.id;$('ev-n').value=ev.name;$('ev-t').value=ev.time_or_keyword||'';$('ev-c').value=ev.content||'';cntF($('ev-c'));openFP('fp-cev-d');}
async function saveCEv(){const eid=$('ev-id').value,data={character_id:_cevCid,name:$('ev-n').value.trim()||'æœªå‘½å',time_or_keyword:$('ev-t').value,content:$('ev-c').value};if(eid){const ev=await dbGet('character_events',eid)||{id:eid};Object.assign(ev,data);await dbPut('character_events',ev);}else{data.id=uid();data.sort_order=0;await dbPut('character_events',data);}toast('å·²å„²å­˜');closeFP('fp-cev-d');closeFP('fp-cev');openCEvs(_cevCid);_charDataCache=null;}
async function delCEv(){const eid=$('ev-id').value;if(!eid){closeFP('fp-cev-d');return;}if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;await dbDel('character_events',eid);toast('å·²åˆªé™¤');closeFP('fp-cev-d');closeFP('fp-cev');openCEvs(_cevCid);_charDataCache=null;}
// === SETTINGS & API CONFIGS ===
let _settings={};let _apiCfgs=[];const SETTINGS_ID='_singleton';
async function saveSettingsObj(obj){obj.id=SETTINGS_ID;_settings=obj;await dbPut('settings',obj);}
async function loadSettings(){const s=await dbGet('settings',SETTINGS_ID);if(s){_settings=s;if(s.temperature!=null){$('set-temp').value=Math.round(s.temperature*100);$('set-temp').nextElementSibling.textContent=s.temperature.toFixed(2);}if(s.max_input_tokens)$('set-maxin').value=s.max_input_tokens;if(s.max_output_tokens)$('set-maxout').value=s.max_output_tokens;if(s.theme&&s.theme!=='default')document.body.className=s.theme;syncThemeDots();}}
function getSettings(){return _settings;}
async function saveSettings(){await saveSettingsObj({...(_settings||{}),id:SETTINGS_ID,temperature:parseFloat((parseInt($('set-temp').value)/100).toFixed(2)),max_input_tokens:parseInt($('set-maxin').value)||128000,max_output_tokens:parseInt($('set-maxout').value)||4096,theme:document.body.className||'default'});toast('å·²å„²å­˜');}
async function saveMemSettings(){await saveSettingsObj({...(_settings||{}),id:SETTINGS_ID,
mem_prompt:$('mem-prompt').value,mem_rule:parseInt($('mem-rule').value)||10,
auto_summary:$('set-sum-auto').classList.contains('on'),summary_interval:parseInt($('set-sum-interval').value)||10,summary_prompt:$('sum-prompt').value,
sum_api_id:$('sum-api-id').value||null,sum_model:$('sum-model-id').value||null,
mem_api_id:$('mem-api-id').value||null,mem_model:$('mem-model-id').value||null,
emb_local:$('set-emb-local').classList.contains('on'),
vec_threshold:parseFloat((parseInt($('set-vec-threshold').value)/100).toFixed(2)),
vec_extras_count:parseInt($('set-vec-extras').value)||3,vec_events_count:parseInt($('set-vec-events').value)||3,vec_memories_count:parseInt($('set-vec-memories').value)||5});toast('å·²å„²å­˜');}
async function loadMemRules(){const s=_settings;if(!s)return;
if(s.mem_prompt)$('mem-prompt').value=s.mem_prompt;if(s.mem_rule)$('mem-rule').value=s.mem_rule;
if(s.summary_prompt)$('sum-prompt').value=s.summary_prompt;if(s.auto_summary)$('set-sum-auto').classList.add('on');if(s.summary_interval)$('set-sum-interval').value=s.summary_interval;
if(s.emb_local)$('set-emb-local').classList.add('on');
if(s.sum_api_id){$('sum-api-id').value=s.sum_api_id;const a=_apiCfgs.find(x=>x.id===s.sum_api_id);$('sum-api-btn').childNodes[0].textContent=a?a.name:'æœªé¸æ“‡';}
if(s.sum_model){$('sum-model-id').value=s.sum_model;$('sum-model-btn').childNodes[0].textContent=s.sum_model;}
if(s.mem_api_id){$('mem-api-id').value=s.mem_api_id;const a=_apiCfgs.find(x=>x.id===s.mem_api_id);$('mem-api-btn').childNodes[0].textContent=a?a.name:'æœªé¸æ“‡';}
if(s.mem_model){$('mem-model-id').value=s.mem_model;$('mem-model-btn').childNodes[0].textContent=s.mem_model;}
if(s.vec_threshold!=null){$('set-vec-threshold').value=Math.round(s.vec_threshold*100);$('set-vec-threshold').nextElementSibling.textContent=s.vec_threshold.toFixed(2);}
if(s.vec_extras_count)$('set-vec-extras').value=s.vec_extras_count;if(s.vec_events_count)$('set-vec-events').value=s.vec_events_count;if(s.vec_memories_count)$('set-vec-memories').value=s.vec_memories_count;
['sum','mem'].forEach(p=>{syncFeatureApiPop(p);syncFeatureModelPop(p);});cntF($('sum-prompt'));cntF($('mem-prompt'));}

// API Configs
async function loadApiCfgs(){_apiCfgs=sortBy(await dbAll('api_configs'),'sort_order');renderApiCfgList();syncPrApiPop();}
function renderApiCfgList(){const el=$('api-cfg-list');if(!_apiCfgs.length){el.innerHTML='<div class="empty" style="font-size:13px;">å°šæœªè¨­å®š API</div>';return;}el.innerHTML=_apiCfgs.map(a=>'<div class="ev-toggle-item" onclick="openApiCfgEdit(\''+a.id+'\')"><div class="lb"><div class="lt">'+esc(a.name||'æœªå‘½å')+'</div><div class="ls">'+esc((a.provider||'').charAt(0).toUpperCase()+(a.provider||'').slice(1))+'</div></div><svg style="width:16px;height:16px;color:var(--tx2);stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>').join('');}
async function addApiCfg(){const r={id:uid(),name:'æ–° API',provider:'anthropic',api_key:'',sort_order:_apiCfgs.length};await dbPut('api_configs',r);toast('å·²æ–°å¢');await loadApiCfgs();openApiCfgEdit(r.id);}
function openApiCfgEdit(id){const a=_apiCfgs.find(x=>x.id===id);if(!a)return;$('acfg-id').value=a.id;$('acfg-name').value=a.name||'';$('acfg-provider').value=a.provider||'anthropic';$('acfg-provider-btn').childNodes[0].textContent=(a.provider||'anthropic').charAt(0).toUpperCase()+(a.provider||'anthropic').slice(1);$('acfg-key').value=a.api_key||'';$('acfg-test-result').style.display='none';openFP('fp-api-cfg');}
async function saveApiCfg(){const id=$('acfg-id').value;const a=await dbGet('api_configs',id)||{id};Object.assign(a,{name:$('acfg-name').value.trim()||'æœªå‘½å',provider:$('acfg-provider').value,api_key:$('acfg-key').value});await dbPut('api_configs',a);toast('å·²å„²å­˜');await loadApiCfgs();closeFP('fp-api-cfg');}
async function delApiCfg(){if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;await dbDel('api_configs',$('acfg-id').value);toast('å·²åˆªé™¤');await loadApiCfgs();closeFP('fp-api-cfg');}
const _models={anthropic:['claude-opus-4-6','claude-opus-4-5-20251101','claude-sonnet-4-6','claude-sonnet-4-5-20250929','claude-sonnet-4-20250514','claude-haiku-4-5-20251001'],openai:['gpt-5','gpt-5-mini','gpt-4.1','gpt-4.1-mini','gpt-4o','gpt-4o-mini','o3','o3-mini','o4-mini'],google:['gemini-3.0-pro','gemini-3.0-flash','gemini-2.5-pro','gemini-2.5-flash','gemini-2.5-flash-lite','gemini-2.0-flash'],openrouter:['anthropic/claude-opus-4-6','anthropic/claude-sonnet-4-6','anthropic/claude-haiku-4-5','openai/gpt-5','openai/gpt-4.1','google/gemini-3.0-pro','google/gemini-2.5-pro','deepseek/deepseek-chat-v3-0324','meta-llama/llama-4-maverick']};
const _providerLabels={anthropic:'Anthropic',openai:'OpenAI',google:'Google',openrouter:'OpenRouter'};
async function testApiConn(){const pv=$('acfg-provider').value,key=$('acfg-key').value,el=$('acfg-test-result');if(!key){el.style.display='block';el.innerHTML='<span style="color:#c0705a;">âŒ è«‹å…ˆè¼¸å…¥ API Key</span>';return;}el.style.display='block';el.innerHTML='â³ æ¸¬è©¦ä¸­...';try{let resp;if(pv==='anthropic')resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:1,messages:[{role:'user',content:'hi'}]})});else if(pv==='google')resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:'hi'}]}],generationConfig:{maxOutputTokens:1}})});else if(pv==='openrouter')resp=await fetch('https://openrouter.ai/api/v1/models',{headers:{'Authorization':'Bearer '+key}});else resp=await fetch('https://api.openai.com/v1/models',{headers:{'Authorization':'Bearer '+key}});el.innerHTML=resp.ok?'<span style="color:#5a9e6f;">âœ… é€£ç·šæˆåŠŸ</span>':'<span style="color:#c0705a;">âŒ å¤±æ•— ('+resp.status+')</span>';}catch(e){el.innerHTML='<span style="color:#c0705a;">âŒ '+e.message.substring(0,50)+'</span>';}}

function syncPrApiPop(){const el=$('pr-api-list'),cur=$('pr-api-id').value;el.innerHTML=_apiCfgs.map(a=>'<div class="popup-item'+(cur===a.id?' active':'')+'" onclick="pickPrApi(\''+a.id+'\',\''+esc(a.name)+'\',this)"><span>'+esc(a.name)+' ('+(_providerLabels[a.provider]||a.provider)+')</span><span class="check">âœ“</span></div>').join('');}
function pickPrApi(id,label,el){$('pr-api-id').value=id;$('pr-api-btn').childNodes[0].textContent=label;el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');closePopup('pr-api-pop');$('pr-model-id').value='';$('pr-model-btn').childNodes[0].textContent='æœªé¸æ“‡';syncPrModelPop();}
function syncPrModelPop(){const el=$('pr-model-list'),cur=$('pr-model-id').value,apiId=$('pr-api-id').value,acfg=apiId?_apiCfgs.find(a=>a.id===apiId):_apiCfgs[0],pv=acfg?acfg.provider:'anthropic',ms=_models[pv]||[];el.innerHTML=ms.map(m=>'<div class="popup-item'+(cur===m?' active':'')+'" onclick="pickPrModel(\''+m+'\',this)"><span>'+esc(m)+'</span><span class="check">âœ“</span></div>').join('')+'<div style="padding:8px 12px;border-top:1px solid var(--bd);"><input type="text" id="pr-model-custom" placeholder="è‡ªè¨‚æ¨¡å‹..." style="width:100%;padding:6px;border:1px solid var(--bd);border-radius:6px;font-size:13px;font-family:monospace;background:var(--bg);color:var(--tx);" onkeydown="if(event.key===\'Enter\'){pickPrModel(this.value.trim(),null);this.value=\'\';}"></div>';}
function pickPrModel(m,el){if(!m)return;$('pr-model-id').value=m;$('pr-model-btn').childNodes[0].textContent=m;if(el){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}closePopup('pr-model-pop');}
function syncFeatureApiPop(pfx){const el=$(pfx+'-api-list');if(!el)return;const cur=$(pfx+'-api-id').value;el.innerHTML=_apiCfgs.map(a=>'<div class="popup-item'+(cur===a.id?' active':'')+'" onclick="pickFeatureApi(\''+pfx+'\',\''+a.id+'\',\''+esc(a.name)+'\',this)"><span>'+esc(a.name)+' ('+(_providerLabels[a.provider]||a.provider)+')</span><span class="check">âœ“</span></div>').join('');}
function pickFeatureApi(pfx,id,label,el){$(pfx+'-api-id').value=id;$(pfx+'-api-btn').childNodes[0].textContent=label;el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');closePopup(pfx+'-api-pop');$(pfx+'-model-id').value='';$(pfx+'-model-btn').childNodes[0].textContent='æœªé¸æ“‡';syncFeatureModelPop(pfx);}
function syncFeatureModelPop(pfx){const el=$(pfx+'-model-list');if(!el)return;const cur=$(pfx+'-model-id').value,apiId=$(pfx+'-api-id').value,acfg=apiId?_apiCfgs.find(a=>a.id===apiId):_apiCfgs[0],pv=acfg?acfg.provider:'anthropic',ms=_models[pv]||[];el.innerHTML=ms.map(m=>'<div class="popup-item'+(cur===m?' active':'')+'" onclick="pickFeatureModel(\''+pfx+'\',\''+m+'\',this)"><span>'+esc(m)+'</span><span class="check">âœ“</span></div>').join('')+'<div style="padding:8px 12px;border-top:1px solid var(--bd);"><input type="text" placeholder="è‡ªè¨‚æ¨¡å‹..." style="width:100%;padding:6px;border:1px solid var(--bd);border-radius:6px;font-size:13px;font-family:monospace;background:var(--bg);color:var(--tx);" onkeydown="if(event.key===\'Enter\'){pickFeatureModel(\''+pfx+'\',this.value.trim(),null);this.value=\'\';}"></div>';}
function pickFeatureModel(pfx,m,el){if(!m)return;$(pfx+'-model-id').value=m;$(pfx+'-model-btn').childNodes[0].textContent=m;if(el){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}closePopup(pfx+'-model-pop');}
function getFeatureApiCfg(pfx){const s=getSettings(),apiId=s[pfx+'_api_id']||'',model=s[pfx+'_model']||'',acfg=apiId?_apiCfgs.find(a=>a.id===apiId):_apiCfgs[0];if(!acfg)return null;return{...acfg,model:model||null};}
function getApiCfgForPrompt(rpId){let cfgId=null,model=null;if(rpId){const p=prompts.find(x=>x.id===rpId);if(p){cfgId=p.api_config_id||null;model=p.model||null;}}const acfg=cfgId?_apiCfgs.find(x=>x.id===cfgId):_apiCfgs[0];if(!acfg)return null;return{...acfg,model:model||acfg.model||null};}
// === PROMPTS ===
let prompts=[];
async function loadPr(){prompts=sortBy(await dbAll('prompts'),'sort_order');if(!prompts.length){const p={id:uid(),name:'æ¨™æº– RP',content:'ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²æ‰®æ¼”æ•˜äº‹è€…ã€‚è«‹æ ¹æ“šè§’è‰²è¨­å®šèˆ‡å ´æ™¯ï¼Œä»¥è±å¯Œçš„æ–‡å­¸ç­†è§¸æ¨é€²åŠ‡æƒ…ã€‚\n\n## å›è¦†è¦å‰‡\n- ä»¥ç¬¬ä¸‰äººç¨±æå¯«è§’è‰²çš„å‹•ä½œã€è¡¨æƒ…ã€å¿ƒç†æ´»å‹•\n- å°è©±ä½¿ç”¨ã€Œã€åŒ…è£¹ï¼Œå…§å¿ƒç¨ç™½ä½¿ç”¨ï¼ˆï¼‰åŒ…è£¹\n- æ¯æ¬¡å›è¦†æ§åˆ¶åœ¨ 200ï½400 å­—ä¹‹é–“\n- ä¸è¦æ›¿ç©å®¶è§’è‰²åšå‡ºæ±ºå®šæˆ–èªªè©±\n- é©ç•¶æå¯«ç’°å¢ƒæ°›åœèˆ‡æ„Ÿå®˜ç´°ç¯€\n- æ ¹æ“šè§’è‰²çš„æ€§æ ¼èˆ‡å¥½æ„Ÿåº¦èª¿æ•´äº’å‹•æ–¹å¼\n\n## æ•˜äº‹é¢¨æ ¼\nä¿æŒæ²‰æµ¸æ„Ÿï¼Œé¿å…è·³å‡ºè§’è‰²ã€‚å¦‚æœç©å®¶çš„è¡Œç‚ºè¶…å‡ºå ´æ™¯é‚è¼¯ï¼Œè§’è‰²æ‡‰ä»¥ç¬¦åˆè¨­å®šçš„æ–¹å¼è‡ªç„¶å›æ‡‰ã€‚',sort_order:0};await dbPut('prompts',p);prompts=[p];}renderPr();syncRpPopup();}
function renderPr(){const pl=$('pl'),curId=$('pe-id').value;pl.innerHTML=prompts.map((p,i)=>'<div class="pi'+(p.id===curId?' sel':(!curId&&i===0?' sel':''))+'" data-prid="'+p.id+'" data-pridx="'+i+'"><div class="pn2" onclick="selPr(this.parentElement,'+i+')">'+esc(p.name)+'</div><div class="ptk">â‰ˆ '+tok(p.content)+'</div></div>').join('');const si=curId?prompts.findIndex(p=>p.id===curId):-1;if(si>=0)selPr(pl.children[si],si);else if(prompts.length)selPr(pl.children[0],0);else $('pr-edit').style.display='none';}
function selPr(el,i){document.querySelectorAll('.pi').forEach(p=>p.classList.remove('sel'));el.classList.add('sel');$('pe-id').value=prompts[i].id;$('pn').value=prompts[i].name;$('tp2').value=prompts[i].content;$('pr-api-id').value=prompts[i].api_config_id||'';$('pr-model-id').value=prompts[i].model||'';const acfg=prompts[i].api_config_id?_apiCfgs.find(a=>a.id===prompts[i].api_config_id):null;$('pr-api-btn').childNodes[0].textContent=acfg?acfg.name:'æœªé¸æ“‡';$('pr-model-btn').childNodes[0].textContent=prompts[i].model||'æœªé¸æ“‡';syncPrApiPop();syncPrModelPop();cntF($('tp2'));$('pr-edit').style.display='block';}
async function createPr(){const p={id:uid(),name:'æ–°æ¨¡å¼',content:'',sort_order:prompts.length};await dbPut('prompts',p);toast('å·²æ–°å¢');await loadPr();selPr($('pl').lastElementChild,prompts.length-1);}
async function savePr(){const id=$('pe-id').value,p=await dbGet('prompts',id)||{id};Object.assign(p,{name:$('pn').value.trim()||'æœªå‘½å',content:$('tp2').value,api_config_id:$('pr-api-id').value||null,model:$('pr-model-id').value||null});await dbPut('prompts',p);toast('å·²å„²å­˜');await loadPr();}
async function delPr(){if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;await dbDel('prompts',$('pe-id').value);toast('å·²åˆªé™¤');$('pr-edit').style.display='none';await loadPr();}
let _chatRpId=null;
function syncRpPopup(){const el=$('rp-list');if(!prompts.length){el.innerHTML='<div style="padding:8px;color:var(--tx2);">è«‹å…ˆå»ºç«‹æç¤ºè©</div>';return;}el.innerHTML=prompts.map(p=>'<div class="popup-item'+(_chatRpId===p.id?' active':'')+'" onclick="pickRp(\''+p.id+'\',this)"><span>'+esc(p.name)+'</span><span class="check">âœ“</span></div>').join('');}
function pickRp(id,el){_chatRpId=id;if(_curChat)_curChat.rpId=id;const p=prompts.find(x=>x.id===id);el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$('rp-btn').childNodes[0].textContent=p?p.name:'RP';closePopup('rp-popup');if(_curChatId)saveChatStore();}

// === PROFILES ===
let profiles=[],_pfEditId=null;
async function loadPf(){profiles=sortBy(await dbAll('profiles'),'sort_order');renderPf();}
function renderPf(){const el=$('pf-list');if(!profiles.length){el.innerHTML='<div class="empty">å°šæœªå»ºç«‹</div>';return;}el.innerHTML=profiles.map(p=>'<div class="li" data-pfid="'+p.id+'" onclick="openPfEdit(\''+p.id+'\')">'+avH(p.avatar_url,p.name,72,getAvOff('pf_'+p.id).ox,getAvOff('pf_'+p.id).oy).replace('class="av"','class="av av-list"')+'<div class="lb"><div class="lt">'+esc(p.name)+'</div></div></div>').join('');renderPpPop();}
async function createPf(){const p={id:uid(),name:'æ–°æª”æ¡ˆ',sort_order:profiles.length};await dbPut('profiles',p);toast('å·²æ–°å¢');await loadPf();openPfEdit(p.id);}
function openPfEdit(id){_pfEditId=id;const p=profiles.find(x=>x.id===id);if(!p)return;_pfAvUrl=p.avatar_url||null;const ao=getAvOff('pf_'+id);_pfAvOx=ao.ox;_pfAvOy=ao.oy;$('pf-vl').style.display='none';$('pf-vd').style.display='block';$('pf-edit-id').value=id;$('pf-edit-name').value=p.name||'';$('pf-edit-age').value=p.age||'';$('pf-edit-job').value=p.job||'';$('pf-gen').childNodes[0].textContent=p.gender||'æœªè¨­ç½®';$('pf-edit-setting').value=p.setting||'';renderAvEd('pf',_pfAvUrl,_pfAvOx,_pfAvOy);$('pf-av-wrap').onclick=()=>startAvUp('profile',id);cntF($('pf-edit-setting'));}
function closePfEdit(){if($('pf-vl'))$('pf-vl').style.display='block';if($('pf-vd'))$('pf-vd').style.display='none';_pfEditId=null;}
async function savePfDetail(){const id=$('pf-edit-id').value,p=await dbGet('profiles',id)||{id};Object.assign(p,{name:$('pf-edit-name').value.trim()||'æœªå‘½å',age:parseInt($('pf-edit-age').value)||null,gender:$('pf-gen').textContent.trim()||null,job:$('pf-edit-job').value.trim()||null,setting:$('pf-edit-setting').value});await dbPut('profiles',p);saveAvOff('pf_'+id,_pfAvOx,_pfAvOy);toast('å·²å„²å­˜');await loadPf();}
async function delPfDetail(){if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;await dbDel('profiles',_pfEditId);toast('å·²åˆªé™¤');closePfEdit();await loadPf();}
let _chatPlayerId=null;
function renderPpPop(){const el=$('pp-list');if(!profiles.length){el.innerHTML='<div style="padding:8px;color:var(--tx2);">å°šæœªå»ºç«‹</div>';return;}el.innerHTML=profiles.map(p=>'<div class="popup-item'+(_chatPlayerId===p.id?' active':'')+'" onclick="pickPlayer(\''+p.id+'\',this)"><div class="av" style="width:28px;height:28px;font-size:12px;">'+(p.avatar_url?'<img src="'+p.avatar_url+'">':esc((p.name||'?')[0]))+'</div><span style="flex:1">'+esc(p.name)+'</span><span class="check">âœ“</span></div>').join('');}
function pickPlayer(id,el){_chatPlayerId=id;if(_curChat)_curChat.playerId=id;const p=profiles.find(x=>x.id===id);el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');renderSidePlayer();closePopup('pp-pop');if(_curChatId)saveChatStore();}
function renderSidePlayer(){const p=_chatPlayerId?profiles.find(x=>x.id===_chatPlayerId):null;if(p)$('side-player').innerHTML='<div class="av" style="width:28px;height:28px;font-size:12px;">'+(p.avatar_url?'<img src="'+p.avatar_url+'">':esc(p.name[0]))+'</div><span>'+esc(p.name)+'</span><span class="switch-hint">åˆ‡æ› â–¸</span>';else $('side-player').innerHTML='<div class="av" style="width:28px;height:28px;font-size:12px;">?</div><span>æœªé¸æ“‡</span><span class="switch-hint">åˆ‡æ› â–¸</span>';}
function pickPfGen(el,v){el.closest('.popup').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');$('pf-gen').childNodes[0].textContent=v;closePopup('pf-gen-pop');}

// === IMPORT / EXPORT ===
function dlJson(data,fn){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));a.download=fn;a.click();URL.revokeObjectURL(a.href);}
async function exportAll(){toast('åŒ¯å‡ºä¸­...');try{const strip=arr=>(arr||[]).map(x=>{const c={...x};delete c.embedding;return c;});const data={_type:'rp_studio_backup',_version:2,_storage:'local',_date:new Date().toISOString(),characters:strip(await dbAll('characters')),character_extras:strip(await dbAll('character_extras')),character_events:strip(await dbAll('character_events')),profiles:await dbAll('profiles'),prompts:await dbAll('prompts'),api_configs:await dbAll('api_configs'),settings:[_settings],persistent_commands:await dbAll('persistent_commands'),chats:await dbAll('chats'),messages:await dbAll('messages'),chat_events:await dbAll('chat_events'),memories:strip(await dbAll('memories'))};dlJson(data,'rp-backup-'+new Date().toISOString().slice(0,10)+'.json');toast('âœ… å·²åŒ¯å‡º');}catch(e){toast('å¤±æ•—: '+e.message.substring(0,50));}}
async function exportChars(){toast('åŒ¯å‡ºä¸­...');try{dlJson({_type:'rp_studio_characters',_version:2,_date:new Date().toISOString(),characters:await dbAll('characters'),character_extras:await dbAll('character_extras'),character_events:await dbAll('character_events')},'rp-chars-'+new Date().toISOString().slice(0,10)+'.json');toast('âœ… å·²åŒ¯å‡º');}catch(e){toast('å¤±æ•—');}}
async function exportCardV2(){toast('ä¸‹ä¸€æ®µäº¤ä»˜');}
async function exportChats(){toast('ä¸‹ä¸€æ®µäº¤ä»˜');}
async function importFile(inp){if(!inp.files[0])return;try{const text=await inp.files[0].text();const data=JSON.parse(text);inp.value='';if(!data._type){toast('ç„¡æ³•è¾¨è­˜æ ¼å¼');return;}if(!await cfm('ç¢ºå®šåŒ¯å…¥ï¼Ÿç›¸åŒ ID æœƒè¢«è¦†è“‹ã€‚'))return;toast('åŒ¯å…¥ä¸­...');let total=0;const up=async(s,rows)=>{if(!rows||!rows.length)return 0;for(const r of rows){const c={...r};delete c.embedding;await dbPut(s,c);}return rows.length;};
if(data.characters)total+=await up('characters',data.characters);if(data.character_extras)total+=await up('character_extras',data.character_extras);if(data.character_events)total+=await up('character_events',data.character_events);if(data.profiles)total+=await up('profiles',data.profiles);if(data.prompts)total+=await up('prompts',data.prompts);if(data.api_configs)total+=await up('api_configs',data.api_configs);if(data.settings&&data.settings[0]){data.settings[0].id=SETTINGS_ID;await dbPut('settings',data.settings[0]);total++;}if(data.persistent_commands)total+=await up('persistent_commands',data.persistent_commands);if(data.chats)total+=await up('chats',data.chats);if(data.messages)total+=await up('messages',data.messages);if(data.chat_events)total+=await up('chat_events',data.chat_events);if(data.memories)total+=await up('memories',data.memories);
toast('âœ… '+total+' ç­†');await initApp();}catch(e){toast('å¤±æ•—: '+e.message.substring(0,50));}}

// === STUBS (Chat system â€” next delivery) ===

// === INIT ===
(async()=>{
  history.replaceState({p:'main'},'');
  try{await openDB();await initApp();}catch(e){console.error('Init error:',e);}
  const sp=$('splash');if(sp){sp.classList.add('hide');setTimeout(()=>sp.remove(),400);}
  document.addEventListener('click',hideCtx);
})();
async function initApp(){
  await loadApiCfgs().catch(e=>console.warn('loadApiCfgs',e));
  await Promise.all([
    loadSettings().catch(e=>console.warn('loadSettings',e)),
    loadChars().catch(e=>console.warn('loadChars',e)),
    loadPr().catch(e=>console.warn('loadPr',e)),
    loadPf().catch(e=>console.warn('loadPf',e)),
    loadPcmds().catch(e=>console.warn('loadPcmds',e))
  ]);
  await loadChatIndex().catch(e=>console.warn('loadChatIndex',e));
  try{loadAvOff();}catch(e){console.warn('loadAvOff',e);}
  try{loadMemRules();}catch(e){console.warn('loadMemRules',e);}
  try{renderChatList();}catch(e){console.warn('renderChatList',e);}
}
// â•â•â• CHAT SYSTEM (IndexedDB) â•â•â•
let _chatStore={},_curChatId=null,_curChat=null;
async function loadChatIndex(){const rows=sortBy(await dbAll('chats'),'updated_at','desc');_chatStore={};rows.forEach(r=>{_chatStore[r.id]={charId:r.char_id,charName:r.char_name||'',windowName:r.window_name||'',avatarUrl:r.avatar_url||'',rpId:r.rp_id,playerId:r.player_id,pinned:r.pinned||false,draft:r.draft||'',summary:r.summary||'',pcmdToggles:r.pcmd_toggles||{},updated:r.updated_at||0,msgs:null};});}
async function loadChatMsgs(chatId){const rows=sortBy(await dbByIndex('messages','chat_id',chatId),'sort_order');return rows.map(r=>({role:r.role,name:r.name||'',content:r.content||'',time:r.time||'',avUrl:r.av_url||''}));}
async function saveChatMeta(){if(!_curChatId||!_curChat)return;_chatStore[_curChatId]=_curChat;await dbPut('chats',{id:_curChatId,char_id:_curChat.charId,char_name:_curChat.charName,window_name:_curChat.windowName||'',avatar_url:_curChat.avatarUrl||'',rp_id:_curChat.rpId||null,player_id:_curChat.playerId||null,pinned:_curChat.pinned||false,draft:_curChat.draft||'',summary:_curChat.summary||'',pcmd_toggles:_curChat.pcmdToggles||{},updated_at:new Date(_curChat.updated||Date.now()).toISOString()});}
async function saveMsg(chatId,msg,idx){await dbPut('messages',{id:uid(),chat_id:chatId,role:msg.role,name:msg.name||'',content:msg.content||'',time:msg.time||'',av_url:msg.avUrl||'',sort_order:idx});}
function saveChatStore(){saveChatMeta().catch(e=>console.error(e));}
function touchChatTime(){if(_curChat)_curChat.updated=Date.now();}
function openNewChatPicker(){if(!chars||!chars.length){toast('è«‹å…ˆå»ºç«‹è§’è‰²');return;}$('newchat-list').innerHTML=chars.map(c=>{const ao=getAvOff('char_'+c.id);return '<div class="popup-item" onclick="startNewChat(\''+c.id+'\')" style="gap:10px;">'+avH(c.avatar_url,c.name,36,ao.ox,ao.oy)+'<span style="flex:1">'+esc(c.name)+'</span></div>';}).join('');openPopup('newchat-pop');}
let _pendingChatCharId=null;
async function startNewChat(cid){closePopup('newchat-pop');_pendingChatCharId=cid;
const pfEl=$('setup-pf-list');
if(!profiles.length)pfEl.innerHTML='<div style="padding:6px;color:var(--tx2);font-size:13px;">å°šæœªå»ºç«‹æª”æ¡ˆ</div>';
else pfEl.innerHTML=profiles.map(p=>'<div class="popup-item" onclick="pickSetupPf(\''+p.id+'\',this)"><div class="av" style="width:28px;height:28px;font-size:12px;">'+(p.avatar_url?'<img src="'+p.avatar_url+'">':esc((p.name||'?')[0]))+'</div><span style="flex:1">'+esc(p.name)+'</span><span class="check">âœ“</span></div>').join('');
const rpEl=$('setup-rp-list');
if(!prompts.length)rpEl.innerHTML='<div style="padding:6px;color:var(--tx2);font-size:13px;">å°šæœªå»ºç«‹æ¨¡å¼</div>';
else rpEl.innerHTML=prompts.map((p,i)=>'<div class="popup-item'+(i===0?' active':'')+'" onclick="pickSetupRp(\''+p.id+'\',this)"><span>'+esc(p.name)+'</span><span class="check">âœ“</span></div>').join('');
_chatPlayerId=null;_chatRpId=prompts.length?prompts[0].id:null;openPopup('chat-setup-pop');}
function pickSetupPf(id,el){_chatPlayerId=id;el.closest('#setup-pf-list').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}
function pickSetupRp(id,el){_chatRpId=id;el.closest('#setup-rp-list').querySelectorAll('.popup-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}
async function confirmChatSetup(){closePopup('chat-setup-pop');const cid=_pendingChatCharId;if(!cid)return;const c=chars.find(x=>x.id===cid);if(!c){toast('è§’è‰²ä¸å­˜åœ¨');return;}
const id='chat_'+Date.now();_curChatId=id;_curChat={charId:cid,charName:c.name,windowName:c.name,avatarUrl:c.avatar_url||'',msgs:[],memories:[],rpId:_chatRpId,playerId:_chatPlayerId,pinned:false,updated:Date.now()};
if(_chatRpId){const p=prompts.find(x=>x.id===_chatRpId);if(p)$('rp-btn').childNodes[0].textContent=p.name;syncRpPopup();}
_chatStore[id]=_curChat;await saveChatMeta();$('c-name').textContent=c.name;$('c-msgs').innerHTML='';renderSidePlayer();openChat(c.name);
if(c.greeting_scenario)await appendMsgAwait('system','å ´æ™¯',c.greeting_scenario);
if(c.greeting_message)await appendMsgAwait('ai',c.name,c.greeting_message,c.avatar_url);
if(!c.greeting_scenario&&!c.greeting_message)await appendMsgAwait('system','ç³»çµ±','å°è©±å·²é–‹å§‹');
renderChatList();_pendingChatCharId=null;}
function tplReplace(text){if(!text||!_curChat)return text||'';let s=text;const cn=_curChat.charName||'';let un='';if(_curChat.playerId){const pf=profiles.find(x=>x.id===_curChat.playerId);if(pf)un=pf.name||'';}return s.replace(/\{\{user\}\}/gi,un||'ç©å®¶').replace(/\{\{char\}\}/gi,cn);}
function renderMsgRow(m,idx){const row=document.createElement('div'),t=m.time||'',mc=tplReplace(m.content||''),parsed=marked.parse(mc);row.dataset.msgIdx=idx;
if(m.role==='system'){row.className='msg-row ai';row.style.maxWidth='100%';row.innerHTML='<div class="msg-body"><div class="msg-bubble" style="background:var(--acl);border:1px dashed var(--ac);color:var(--tx);">'+parsed+'</div><div class="mm">'+t+'</div></div>';}
else if(m.role==='ai'){row.className='msg-row ai';const ao=_curChat?getAvOff('char_'+_curChat.charId):{ox:0,oy:0};const op='object-position:'+(50+(ao.ox||0))+'% '+(50+(ao.oy||0))+'%';const liveAv=_curChat?_curChat.avatarUrl:m.avUrl;const ah=liveAv?'<div class="msg-av"><img src="'+liveAv+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;'+op+'"></div>':'<div class="msg-av">'+esc((m.name||'?')[0])+'</div>';row.innerHTML=ah+'<div class="msg-body"><div class="msg-name">'+esc(m.name)+'</div><div class="msg-bubble">'+parsed+'</div><div class="mm">'+t+'</div></div>';}
else{row.className='msg-row user';let uav='';if(_curChat&&_curChat.playerId){const pf=profiles.find(x=>x.id===_curChat.playerId);if(pf){const pao=getAvOff('pf_'+pf.id);const pop='object-position:'+(50+(pao.ox||0))+'% '+(50+(pao.oy||0))+'%';uav=pf.avatar_url?'<div class="msg-av"><img src="'+pf.avatar_url+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;'+pop+'"></div>':'<div class="msg-av">'+esc((pf.name||'?')[0])+'</div>';}}row.innerHTML=uav+'<div class="msg-body"><div class="msg-bubble">'+parsed+'</div><div class="mm">'+t+'</div></div>';}
bindLongPress(row,()=>{if(!_msgDelMode)openMsgBs(idx);});row.addEventListener('click',()=>{if(_msgDelMode)toggleMsgDelSel(idx);});return row;}
function openMsgBs(idx){$('bs-body').innerHTML='<div class="bs-item" onclick="editMsg('+idx+')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>ç·¨è¼¯</div><div class="bs-item" onclick="copyMsg('+idx+')"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>è¤‡è£½</div><div class="bs-item danger" onclick="closeBs();startMsgDel('+idx+')"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>åˆªé™¤</div>';$('bs-ov').classList.add('show');}
function copyMsg(idx){closeBs();if(!_curChat||!_curChat.msgs[idx])return;navigator.clipboard.writeText(_curChat.msgs[idx].content).then(()=>toast('å·²è¤‡è£½')).catch(()=>toast('è¤‡è£½å¤±æ•—'));}
function closeBs(){$('bs-ov').classList.remove('show');}
let _emIdx=null,_emMax=9999;
function editMsg(idx){closeBs();if(!_curChat||!_curChat.msgs[idx])return;_emIdx=idx;$('em-ta').value=_curChat.msgs[idx].content;$('em-ctr').textContent='('+_curChat.msgs[idx].content.length+')';$('em-ov').classList.add('show');}
function closeEditModal(){$('em-ov').classList.remove('show');_emIdx=null;}
async function confirmEditMsg(){if(_emIdx===null||!_curChat)return;_curChat.msgs[_emIdx].content=$('em-ta').value;
if(_curChatId){const rows=sortBy(await dbByIndex('messages','chat_id',_curChatId),'sort_order');if(rows[_emIdx])await dbPut('messages',{...rows[_emIdx],content:$('em-ta').value});}
refreshMsgs();closeEditModal();}
let _msgDelMode=false,_msgDelSel=new Set();
function startMsgDel(initIdx){_msgDelMode=true;_msgDelSel.clear();_msgDelSel.add(initIdx);$('cv').classList.add('msg-del-mode');$('msg-del-bar').classList.add('show');$('msg-del-banner').classList.add('show');$('ci').style.display='none';updateMsgDelUI();}
function cancelMsgDel(){_msgDelMode=false;_msgDelSel.clear();$('cv').classList.remove('msg-del-mode');$('msg-del-bar').classList.remove('show');$('msg-del-banner').classList.remove('show');$('ci').style.display='flex';document.querySelectorAll('.msg-row.msg-del-sel').forEach(r=>r.classList.remove('msg-del-sel'));}
function toggleMsgDelSel(idx){if(_msgDelSel.has(idx))_msgDelSel.delete(idx);else _msgDelSel.add(idx);updateMsgDelUI();}
function updateMsgDelUI(){const n=_msgDelSel.size;$('msg-del-exec').textContent='åˆªé™¤'+(n?' ('+n+')':'');document.querySelectorAll('.msg-row[data-msg-idx]').forEach(r=>{r.classList.toggle('msg-del-sel',_msgDelSel.has(parseInt(r.dataset.msgIdx)));});}
async function execMsgDel(){if(!_msgDelSel.size||!_curChat)return;if(!await cfm('ç¢ºå®šåˆªé™¤ '+_msgDelSel.size+' å‰‡è¨Šæ¯ï¼Ÿ'))return;
const sorted=[..._msgDelSel].sort((a,b)=>b-a);for(const idx of sorted)_curChat.msgs.splice(idx,1);
if(_curChatId){const dbRows=sortBy(await dbByIndex('messages','chat_id',_curChatId),'sort_order');for(const idx of sorted){if(dbRows[idx])await dbDel('messages',dbRows[idx].id);}
const remaining=sortBy(await dbByIndex('messages','chat_id',_curChatId),'sort_order');for(let i=0;i<remaining.length;i++){if(remaining[i].sort_order!==i){remaining[i].sort_order=i;await dbPut('messages',remaining[i]);}}}
cancelMsgDel();refreshMsgs();toast('å·²åˆªé™¤');}
function refreshMsgs(){const cm=$('c-msgs');cm.innerHTML='';(_curChat.msgs||[]).forEach((m,i)=>{try{cm.appendChild(renderMsgRow(m,i));}catch(e){}});cm.scrollTop=cm.scrollHeight;}
function appendMsg(role,name,content,avUrl){const t=new Date().toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});const msg={role,name,content,time:t,avUrl:avUrl||''};if(_curChat){_curChat.msgs.push(msg);saveMsg(_curChatId,msg,_curChat.msgs.length-1).catch(()=>{});}const cm=$('c-msgs'),idx=_curChat?_curChat.msgs.length-1:0;cm.appendChild(renderMsgRow(msg,idx));cm.scrollTop=cm.scrollHeight;}
async function appendMsgAwait(role,name,content,avUrl){const t=new Date().toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});const msg={role,name,content,time:t,avUrl:avUrl||''};if(_curChat){_curChat.msgs.push(msg);await saveMsg(_curChatId,msg,_curChat.msgs.length-1);}const cm=$('c-msgs'),idx=_curChat?_curChat.msgs.length-1:0;cm.appendChild(renderMsgRow(msg,idx));cm.scrollTop=cm.scrollHeight;}
const _isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
function handleCInpKey(e){if(e.key==='Enter'&&!e.shiftKey&&!_isMobile){e.preventDefault();sendMsg();}}
function sendMsg(){const inp=$('c-inp'),txt=inp.value.trim();if(!txt)return;appendMsg('user','ä½ ',txt);inp.value='';inp.style.height='auto';inp.style.height='44px';touchChatTime();saveChatStore();callAI(txt);}
function showTyping(){const cm=$('c-msgs'),row=document.createElement('div');row.className='msg-row ai';row.id='typing-row';const avUrl=_curChat?_curChat.avatarUrl:'';const name=_curChat?_curChat.charName:'?';const ao=_curChat?getAvOff('char_'+_curChat.charId):{ox:0,oy:0};const op='object-position:'+(50+(ao.ox||0))+'% '+(50+(ao.oy||0))+'%';const ah=avUrl?'<div class="msg-av"><img src="'+avUrl+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;'+op+'"></div>':'<div class="msg-av">'+esc(name[0])+'</div>';row.innerHTML=ah+'<div class="msg-body"><div class="msg-name">'+esc(name)+'</div><div style="display:flex;align-items:center;gap:6px;"><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div><div class="stop-btn" onclick="abortAI()"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></div></div></div>';cm.appendChild(row);cm.scrollTop=cm.scrollHeight;}
function hideTyping(){const r=$('typing-row');if(r)r.remove();}
let _aiAbort=null;
function abortAI(){if(_aiAbort){_aiAbort.abort();_aiAbort=null;hideTyping();toast('å·²åœæ­¢');}}
async function callAI(userText){if(!_curChat)return;const s=getSettings();const apiCfg=getApiCfgForPrompt(_curChat.rpId);if(!apiCfg||!apiCfg.api_key){toast('è«‹å…ˆè¨­å®š API');return;}if(!apiCfg.model){toast('è«‹é¸æ“‡æ¨¡å‹');return;}
_aiAbort=new AbortController();showTyping();
try{
let vecExtras=[],vecEvents=[],vecMemories=[];
if(userText&&s.emb_local){const emb=await getEmbedding(userText);if(emb){const cid=_curChat.charId,chatId=_curChatId,vt=s.vec_threshold||0.3;
[vecExtras,vecEvents,vecMemories]=await Promise.all([vectorSearch('character_extras','character_id',cid,emb,s.vec_extras_count||3,vt),vectorSearch('character_events','character_id',cid,emb,s.vec_events_count||3,vt),vectorSearch('memories','chat_id',chatId,emb,s.vec_memories_count||5,vt)]);}}
const sysContent=await buildSysPrompt(vecExtras,vecEvents,vecMemories);const msgs=buildApiMsgs();
const provider=apiCfg.provider||'anthropic',model=apiCfg.model,maxOut=parseInt(s.max_output_tokens)||4096,temp=s.temperature!=null?s.temperature:0.8;
let resp;
if(provider==='anthropic')resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiCfg.api_key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model,max_tokens:maxOut,temperature:temp,system:sysContent,messages:msgs}),signal:_aiAbort.signal});
else if(provider==='openai')resp=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiCfg.api_key},body:JSON.stringify({model,max_tokens:maxOut,temperature:temp,messages:[{role:'system',content:sysContent},...msgs]}),signal:_aiAbort.signal});
else if(provider==='google')resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiCfg.api_key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system_instruction:{parts:[{text:sysContent}]},contents:msgs.map(m=>({role:m.role==='assistant'?'model':'user',parts:[{text:m.content}]})),generationConfig:{temperature:temp,maxOutputTokens:maxOut}}),signal:_aiAbort.signal});
else resp=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiCfg.api_key},body:JSON.stringify({model,max_tokens:maxOut,temperature:temp,messages:[{role:'system',content:sysContent},...msgs]}),signal:_aiAbort.signal});
hideTyping();_aiAbort=null;
if(!resp.ok){toast('API éŒ¯èª¤: '+resp.status);console.error(await resp.text());return;}
const data=await resp.json();let aiText='';
if(provider==='anthropic')aiText=data.content.map(b=>b.text||'').join('');
else if(provider==='google')aiText=(data.candidates&&data.candidates[0]&&data.candidates[0].content)?data.candidates[0].content.parts.map(p=>p.text||'').join(''):''
else aiText=data.choices&&data.choices[0]?data.choices[0].message.content:'';
appendMsg('ai',_curChat.charName,aiText,_curChat.avatarUrl);touchChatTime();saveChatStore();
try{if(s.auto_summary){const iv=parseInt(s.summary_interval)||10;const ac=(_curChat.msgs||[]).filter(m=>m.role==='ai').length;if(ac>0&&ac%iv===0&&_curChat.msgs.length>10){toast('è‡ªå‹•ç”Ÿæˆæ‘˜è¦â€¦');await autoGenSummary();}}}catch(e){}
}catch(e){hideTyping();_aiAbort=null;if(e.name==='AbortError')return;toast('è«‹æ±‚å¤±æ•—');console.error(e);}}
async function buildSysPrompt(vecExtras,vecEvents,vecMemories){let sys='';vecExtras=vecExtras||[];vecEvents=vecEvents||[];vecMemories=vecMemories||[];
const rpId=_curChat.rpId;if(rpId){const p=prompts.find(x=>x.id===rpId);if(p)sys+=p.content+'\n\n';}
const cd=await getCharData(_curChat.charId);const c=cd.char;
if(c){sys+='[è§’è‰²å¡]\nå§“å: '+c.name+'\n';if(c.age)sys+='å¹´é½¡: '+c.age+'\n';if(c.gender&&c.gender!=='æœªè¨­ç½®')sys+='æ€§åˆ¥: '+c.gender+'\n';if(c.job)sys+='è·æ¥­: '+c.job+'\n';if(c.setting)sys+='è¨­å®š:\n'+c.setting+'\n';}
const allExtras=cd.extras;
if(allExtras&&allExtras.length){if(vecExtras.length){sys+='\n[é™„åŠ è¨­å®š]\n';vecExtras.forEach(v=>{const ex=allExtras.find(e=>e.id===v.id);if(ex){if(ex.title)sys+='## '+ex.title+'\n';if(ex.content)sys+=ex.content+'\n\n';}});}else if(!getSettings().emb_local){sys+='\n[é™„åŠ è¨­å®š]\n';allExtras.forEach(ex=>{if(ex.title)sys+='## '+ex.title+'\n';if(ex.content)sys+=ex.content+'\n\n';});}}
const cEvs=cd.events;let creatorToggles={},playerEvs=[];
try{const toggleRows=await dbByIndex('chat_creator_event_toggles','chat_id',_curChatId);toggleRows.forEach(r=>{creatorToggles[r.event_id]=r.enabled;});const plEvRows=(await dbByIndex('chat_events','chat_id',_curChatId)).filter(e=>e.enabled!==false);playerEvs=sortBy(plEvRows,'sort_order');}catch(e){}
const vecEvIds=new Set(vecEvents.map(v=>v.id));
const activeCreator=cEvs.filter(ev=>{if(creatorToggles[ev.id]===false)return false;if(vecEvIds.has(ev.id))return true;if(!getSettings().emb_local)return creatorToggles[ev.id]!==false;return false;});
if(activeCreator.length){sys+='\n[å‰µä½œè€…äº‹ä»¶]\n';activeCreator.forEach(ev=>{sys+='- '+ev.name;if(ev.time_or_keyword)sys+=' ('+ev.time_or_keyword+')';sys+=':\n'+ev.content+'\n\n';});}
if(playerEvs.length){sys+='\n[ç©å®¶äº‹ä»¶]\n';playerEvs.forEach(ev=>{sys+='- '+ev.name;if(ev.keyword)sys+=' ('+ev.keyword+')';sys+=':\n'+ev.content+'\n\n';});}
if(vecMemories.length){sys+='\n[ç›¸é—œè¨˜æ†¶]\n';vecMemories.forEach(m=>{sys+='- '+m.content+'\n';});}
if(_curChat.memories&&_curChat.memories.length){sys+='\n[è¨˜æ†¶é«”]\n';_curChat.memories.forEach(m=>{sys+='- '+(typeof m==='string'?m:(m.content||''))+'\n';});}
if(_curChat.playerId){const pf=profiles.find(x=>x.id===_curChat.playerId);if(pf){sys+='\n[ç©å®¶è§’è‰²]\nå§“å: '+pf.name+'\n';if(pf.age)sys+='å¹´é½¡: '+pf.age+'\n';if(pf.gender&&pf.gender!=='æœªè¨­ç½®')sys+='æ€§åˆ¥: '+pf.gender+'\n';if(pf.job)sys+='è·æ¥­: '+pf.job+'\n';if(pf.setting)sys+='è¨­å®š:\n'+pf.setting+'\n';}}
return tplReplace(sys.trim());}
function buildApiMsgs(){const allMsgs=_curChat.msgs||[];const total=allMsgs.length;const recentStart=Math.max(0,total-10);const msgs=[];
if(_curChat.summary&&_curChat.summary.trim())msgs.push({role:'user',content:'[æ­·å²æ‘˜è¦]\n'+_curChat.summary});
for(let i=recentStart;i<total;i++){const m=allMsgs[i];if(m.role==='system')msgs.push({role:'user',content:'[å ´æ™¯] '+m.content});else if(m.role==='ai')msgs.push({role:'assistant',content:m.content});else msgs.push({role:'user',content:m.content});}
if(msgs.length&&msgs[msgs.length-1].role==='assistant')msgs.push({role:'user',content:'[ç¹¼çºŒ]'});
if(msgs.length&&msgs[0].role==='assistant')msgs.unshift({role:'user',content:'[å°è©±é–‹å§‹]'});
const pcmdTxt=getActivePcmds();if(pcmdTxt&&msgs.length){for(let i=msgs.length-1;i>=0;i--){if(msgs[i].role==='user'){msgs[i].content+='\n\n[å¸¸é§æŒ‡ä»¤]\n'+pcmdTxt;break;}}}
return msgs;}

// â•â•â• Summary â•â•â•
function openSummary(){if(!_curChat)return;$('sum-ta').value=_curChat.summary||'';cntF($('sum-ta'));openFP('fp-sum');}
function saveSummary(){if(!_curChat)return;_curChat.summary=$('sum-ta').value;saveChatStore();toast('å·²å„²å­˜');}
async function callApiSimple(apiCfg,sysPr,userPr,maxTok,temp){const pv=apiCfg.provider||'anthropic',model=apiCfg.model;let resp;
if(pv==='anthropic')resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiCfg.api_key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model,max_tokens:maxTok,temperature:temp,system:sysPr,messages:[{role:'user',content:userPr}]})});
else if(pv==='google')resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiCfg.api_key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system_instruction:{parts:[{text:sysPr}]},contents:[{role:'user',parts:[{text:userPr}]}],generationConfig:{temperature:temp,maxOutputTokens:maxTok}})});
else{const ep=pv==='openrouter'?'https://openrouter.ai/api/v1/chat/completions':'https://api.openai.com/v1/chat/completions';resp=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiCfg.api_key},body:JSON.stringify({model,max_tokens:maxTok,temperature:temp,messages:[{role:'system',content:sysPr},{role:'user',content:userPr}]})});}
if(!resp.ok)return null;const data=await resp.json();
if(pv==='anthropic')return data.content.map(b=>b.text||'').join('');
if(pv==='google')return(data.candidates&&data.candidates[0]&&data.candidates[0].content)?data.candidates[0].content.parts.map(p=>p.text||'').join(''):''
return data.choices&&data.choices[0]?data.choices[0].message.content:'';}
async function genSummary(){if(!_curChat)return;const apiCfg=getFeatureApiCfg('sum')||getApiCfgForPrompt(_curChat.rpId);if(!apiCfg||!apiCfg.api_key||!apiCfg.model){toast('è«‹å…ˆè¨­å®šæ‘˜è¦ API/æ¨¡å‹');return;}
const allMsgs=_curChat.msgs||[];const endIdx=Math.max(0,allMsgs.length-10);if(endIdx<1){toast('å°è©±å¤ªçŸ­');return;}
let transcript='';for(let i=0;i<endIdx;i++){const m=allMsgs[i];transcript+=(m.role==='ai'?(m.name||'è§’è‰²'):(m.role==='system'?'ç³»çµ±':'ç©å®¶'))+': '+m.content+'\n\n';}
toast('ç”Ÿæˆæ‘˜è¦â€¦');const sysPr=getSettings().summary_prompt||'ä½ æ˜¯å°è©±æ‘˜è¦åŠ©æ‰‹ã€‚å°‡ä»¥ä¸‹ RP å°è©±æ¿ƒç¸®æˆç°¡æ½”æ‘˜è¦ï¼Œä¿ç•™é‡è¦åŠ‡æƒ…ã€è§’è‰²é—œä¿‚å’Œé—œéµäº‹ä»¶ã€‚500 tokens ä»¥å…§ã€‚ç¹é«”ä¸­æ–‡ã€‚';
const text=await callApiSimple(apiCfg,sysPr,'è«‹æ‘˜è¦ä»¥ä¸‹å°è©±ï¼š\n\n'+transcript,500,0.3);
if(text){$('sum-ta').value=text;cntF($('sum-ta'));_curChat.summary=text;saveChatStore();toast('å·²ç”Ÿæˆ');}else toast('ç”Ÿæˆå¤±æ•—');}
async function autoGenSummary(){if(!_curChat)return;const apiCfg=getFeatureApiCfg('sum')||getApiCfgForPrompt(_curChat.rpId);if(!apiCfg||!apiCfg.api_key||!apiCfg.model)return;
const allMsgs=_curChat.msgs||[];const endIdx=Math.max(0,allMsgs.length-10);if(endIdx<1)return;
let transcript=(_curChat.summary?'[ä¸Šæ¬¡æ‘˜è¦]\n'+_curChat.summary+'\n\n[æ–°å°è©±]\n':'');
for(let i=Math.max(0,endIdx-20);i<endIdx;i++){const m=allMsgs[i];transcript+=(m.role==='ai'?(m.name||'è§’è‰²'):(m.role==='system'?'ç³»çµ±':'ç©å®¶'))+': '+m.content+'\n\n';}
const sysPr=getSettings().summary_prompt||'ä½ æ˜¯å°è©±æ‘˜è¦åŠ©æ‰‹ã€‚åˆä½µæ¿ƒç¸®æˆç°¡æ½”æ‘˜è¦ã€‚500 tokens ä»¥å…§ã€‚ç¹é«”ä¸­æ–‡ã€‚';
const text=await callApiSimple(apiCfg,sysPr,'è«‹åˆä½µæ‘˜è¦ï¼š\n\n'+transcript,500,0.3);
if(text){_curChat.summary=text;saveChatStore();toast('æ‘˜è¦å·²æ›´æ–°');}}

// â•â•â• Chat List â•â•â•
async function renameChatInline(){if(!_curChat||!_curChatId)return;const name=await inp('ä¿®æ”¹è¦–çª—åç¨±',_curChat.windowName||_curChat.charName);if(name===null)return;_curChat.windowName=name.trim()||_curChat.charName;$('c-name').textContent=_curChat.windowName;saveChatStore();renderChatList();}
function renderChatList(){const el=$('chat-list'),ids=Object.keys(_chatStore).sort((a,b)=>{const pa=_chatStore[a].pinned?1:0,pb=_chatStore[b].pinned?1:0;if(pa!==pb)return pb-pa;return(new Date(_chatStore[b].updated||0).getTime())-(new Date(_chatStore[a].updated||0).getTime());});
if(!ids.length){el.innerHTML='<div class="empty">é»æ“Šã€Œ+ æ–°å°è©±ã€é–‹å§‹</div>';return;}
ids.forEach(id=>{const c=_chatStore[id];if(c&&c.charId){const ch=chars.find(x=>x.id===c.charId);if(ch&&ch.avatar_url)c.avatarUrl=ch.avatar_url;}});
el.innerHTML=ids.map(id=>{const c=_chatStore[id],ao=getAvOff('char_'+c.charId);
const batchDot=_batchMode?'<div class="batch-dot'+(_batchSel.has(id)?' sel':'')+'" id="bd-'+id+'" onclick="toggleBatchSel(\''+id+'\',event)"></div>':'';
return '<div class="li li-chat" id="cli-'+id+'" onclick="'+(_batchMode?"toggleBatchSel('"+id+"',event)":"resumeChat('"+id+"'")+')" style="flex-wrap:nowrap;">'+batchDot+avH(c.avatarUrl,c.charName,72,ao.ox,ao.oy).replace('class="av"','class="av av-list"')+'<div class="lb"><div class="lt">'+esc(c.windowName||c.charName)+'</div><div class="ls">æ–°å°è©±</div></div>'+(_batchMode?'':'<div class="pin-icon'+(c.pinned?' pinned':'')+'" onclick="event.stopPropagation();togglePin(\''+id+'\')"><svg viewBox="0 0 24 24"'+(c.pinned?' fill="var(--ac)"':'')+'><path d="M15.4 2.6a1 1 0 011.4 0l4.6 4.6a1 1 0 010 1.4l-3.8 3.8a2 2 0 01-1.4.6H13l-2.5 2.5V19a1 1 0 01-1.7.7L5.3 16.2a1 1 0 01.7-1.7h3.5L12 12v-3.2a2 2 0 01.6-1.4z"/><line x1="2" y1="22" x2="9.5" y2="14.5"/></svg></div>')+'</div>';}).join('');
if(!_batchMode){ids.forEach(id=>{const e=document.getElementById('cli-'+id);if(e)bindLongPress(e,(x,y)=>{showCtx(x,y,[{label:'é‡æ–°å‘½å',action:"renameChat('"+id+"')"},{label:_chatStore[id].pinned?'å–æ¶ˆé‡˜é¸':'é‡˜é¸',action:"togglePin('"+id+"')"}]);});});}
// Load last message previews
ids.forEach(async id=>{try{const rows=sortBy(await dbByIndex('messages','chat_id',id),'sort_order','desc');const last=rows.find(r=>r.role==='ai');if(last){const pv=last.content.replace(/[*#_`>\n]+/g,' ').substring(0,80);const li=document.getElementById('cli-'+id);if(li){const ls=li.querySelector('.ls');if(ls)ls.textContent=pv;}}}catch(e){}});}
function togglePin(id){if(_chatStore[id]){_chatStore[id].pinned=!_chatStore[id].pinned;dbGet('chats',id).then(c=>{if(c){c.pinned=_chatStore[id].pinned;dbPut('chats',c);}});renderChatList();}}
async function renameChat(id){hideCtx();const c=_chatStore[id];if(!c)return;const name=await inp('ä¿®æ”¹è¦–çª—åç¨±',c.windowName||c.charName);if(name!==null){c.windowName=name.trim()||c.charName;dbGet('chats',id).then(ch=>{if(ch){ch.window_name=c.windowName;dbPut('chats',ch);}});if(_curChatId===id){_curChat.windowName=c.windowName;$('c-name').textContent=c.windowName;}renderChatList();}}
async function delCurrentChat(){if(!_curChatId){closeSide();return;}if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;
const rows=await dbByIndex('messages','chat_id',_curChatId);for(const r of rows)await dbDel('messages',r.id);
const evs=await dbByIndex('chat_events','chat_id',_curChatId);for(const e of evs)await dbDel('chat_events',e.id);
const mems=await dbByIndex('memories','chat_id',_curChatId);for(const m of mems)await dbDel('memories',m.id);
await dbDel('chats',_curChatId);delete _chatStore[_curChatId];_curChatId=null;_curChat=null;closeSide();closeChat();toast('å·²åˆªé™¤');}
async function resumeChat(id){const c=_chatStore[id];if(!c)return;_curChatId=id;_curChat=c;_chatRpId=c.rpId||null;_chatPlayerId=c.playerId||null;
const ch=chars.find(x=>x.id===c.charId);if(ch&&ch.avatar_url)c.avatarUrl=ch.avatar_url;
$('c-name').textContent=c.windowName||c.charName;
if(_chatRpId){const p=prompts.find(x=>x.id===_chatRpId);if(p)$('rp-btn').childNodes[0].textContent=p.name;}syncRpPopup();renderSidePlayer();
const cinp=$('c-inp');cinp.value=c.draft||'';cinp.style.height='44px';if(c.draft){cinp.style.height='auto';cinp.style.height=Math.min(cinp.scrollHeight,200)+'px';}
const cm=$('c-msgs');cm.innerHTML='<div style="display:flex;justify-content:center;align-items:center;height:100%;min-height:200px;"><div class="splash-dots"><span></span><span></span><span></span></div></div>';
openChat(c.windowName||c.charName);
_curChat.msgs=await loadChatMsgs(id);cm.innerHTML='';(_curChat.msgs||[]).forEach((m,i)=>{try{cm.appendChild(renderMsgRow(m,i));}catch(e){}});cm.scrollTop=cm.scrollHeight;}

// â•â•â• Chat Events â•â•â•
async function openChatEvents(){if(!_curChat)return;const b=$('chat-ev-body');b.innerHTML='';
const cd=await getCharData(_curChat.charId);const cEvs=cd.events;
let creatorToggles={};try{(await dbByIndex('chat_creator_event_toggles','chat_id',_curChatId)).forEach(r=>{creatorToggles[r.event_id]=r.enabled;});}catch(e){}
if(cEvs.length){b.innerHTML+='<div class="stt" style="margin-top:4px;">å‰µä½œè€…äº‹ä»¶</div>';cEvs.forEach(ev=>{const on=creatorToggles[ev.id]!==false;b.innerHTML+='<div class="ev-toggle-item"><div class="lb" onclick="viewCreatorEv(\''+ev.id+'\')" style="cursor:pointer;"><div class="lt">'+esc(ev.name)+'</div><div class="ls">'+esc(ev.time_or_keyword||'')+'</div></div><div class="tog'+(on?' on':'')+'" onclick="toggleCrEv(\''+ev.id+'\',this)"></div></div>';});}
let playerEvs=sortBy(await dbByIndex('chat_events','chat_id',_curChatId),'sort_order');
b.innerHTML+='<div class="stt" style="margin-top:32px;display:flex;align-items:center;justify-content:space-between;">ç©å®¶äº‹ä»¶<button class="btn bp bs2" onclick="newChatEv()">+ æ–°å¢</button></div>';
if(!playerEvs.length)b.innerHTML+='<div style="color:var(--tx2);font-size:13px;padding:12px;">å°šæœªæ–°å¢</div>';
else{b.innerHTML+='<div id="pl-ev-drag">';playerEvs.forEach(ev=>{b.innerHTML+='<div class="ev-toggle-item" data-evid="'+ev.id+'"><div class="lb" onclick="openChatEvD(\''+ev.id+'\')" style="cursor:pointer;"><div class="lt">'+esc(ev.name)+'</div><div class="ls">'+esc(ev.keyword||'')+'</div></div><div class="tog'+(ev.enabled!==false?' on':'')+'" onclick="togglePlEv(\''+ev.id+'\',this)"></div></div>';});b.innerHTML+='</div>';setTimeout(()=>{const dc=$('pl-ev-drag');if(dc)initEvDrag(dc,'chat_events','data-evid');},0);}
openFP('fp-chat-ev');}
async function toggleCrEv(evId,el){if(!_curChatId)return;const nowOn=el.classList.contains('on');el.classList.toggle('on');
await dbPut('chat_creator_event_toggles',{id:_curChatId+'_'+evId,chat_id:_curChatId,event_id:evId,enabled:!nowOn});}
async function viewCreatorEv(id){const ev=await dbGet('character_events',id);if(!ev)return;$('cev2-id').value='';$('cev2-n').value=ev.name||'';$('cev2-n').readOnly=true;$('cev2-t').value=ev.time_or_keyword||'';$('cev2-t').readOnly=true;$('cev2-c').value=ev.content||'';$('cev2-c').readOnly=true;cntF($('cev2-c'));openFP('fp-chat-ev-d');}
function resetEvdForm(){$('cev2-n').readOnly=false;$('cev2-t').readOnly=false;$('cev2-c').readOnly=false;}
async function togglePlEv(evId,el){const nowOn=el.classList.contains('on');el.classList.toggle('on');const ev=await dbGet('chat_events',evId);if(ev){ev.enabled=!nowOn;await dbPut('chat_events',ev);}}
function newChatEv(){resetEvdForm();$('cev2-id').value='';$('cev2-n').value='';$('cev2-t').value='';$('cev2-c').value='';cntF($('cev2-c'));openFP('fp-chat-ev-d');}
async function openChatEvD(evId){resetEvdForm();const ev=await dbGet('chat_events',evId);if(!ev)return;$('cev2-id').value=ev.id;$('cev2-n').value=ev.name||'';$('cev2-t').value=ev.keyword||'';$('cev2-c').value=ev.content||'';cntF($('cev2-c'));openFP('fp-chat-ev-d');}
async function saveChatEv(){if(!_curChatId)return;const id=$('cev2-id').value,obj={name:$('cev2-n').value.trim()||'æœªå‘½å',keyword:$('cev2-t').value,content:$('cev2-c').value};
if(id){const ev=await dbGet('chat_events',id)||{id};Object.assign(ev,obj);await dbPut('chat_events',ev);}
else{obj.id=uid();obj.chat_id=_curChatId;obj.enabled=true;obj.sort_order=0;await dbPut('chat_events',obj);}
toast('å·²å„²å­˜');closeFP('fp-chat-ev-d');closeFP('fp-chat-ev');openChatEvents();}
async function delChatEv(){const id=$('cev2-id').value;if(!id){closeFP('fp-chat-ev-d');return;}if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;await dbDel('chat_events',id);toast('å·²åˆªé™¤');closeFP('fp-chat-ev-d');closeFP('fp-chat-ev');openChatEvents();}

// â•â•â• Chat Memory â•â•â•
async function openChatMemory(){if(!_curChat)return;const b=$('chat-mem-body');b.innerHTML='';
let dbMems=sortBy(await dbByIndex('memories','chat_id',_curChatId),'sort_order','desc');
const localMems=(_curChat.memories||[]).map((m,i)=>({_local:true,_idx:i,content:typeof m==='string'?m:(m.content||''),date:typeof m==='object'?m.date:''}));
const allMems=[...dbMems.map(m=>({...m,_local:false})),...localMems];
if(!allMems.length){b.innerHTML='<div class="empty">å°šæœªå»ºç«‹è¨˜æ†¶</div>';}else{
allMems.forEach(m=>{const isDb=!m._local;const mid=isDb?m.id:('l'+m._idx);const src=isDb?'db':'local';
b.innerHTML+='<div class="card" style="margin-bottom:12px;"><div style="font-size:13px;line-height:1.7;color:var(--tx);cursor:pointer;" onclick="'+(isDb?"openDbMemD('"+mid+"')":"openChatMemD("+m._idx+")")+'">'+esc(m.content)+'</div></div>';});}
openFP('fp-chat-mem');}
function newChatMem(){$('cmem-id').value='';$('cmem-src').value='local';$('cmem-c').value='';cntF($('cmem-c'));openFP('fp-chat-mem-d');}
function openChatMemD(i){$('cmem-id').value=i;$('cmem-src').value='local';const m=_curChat.memories[i];$('cmem-c').value=typeof m==='string'?m:(m.content||'');cntF($('cmem-c'));openFP('fp-chat-mem-d');}
async function openDbMemD(dbId){$('cmem-id').value=dbId;$('cmem-src').value='db';const m=await dbGet('memories',dbId);$('cmem-c').value=m?m.content||'':'';cntF($('cmem-c'));openFP('fp-chat-mem-d');}
async function saveChatMem(){if(!_curChat)return;const idx=$('cmem-id').value,txt=$('cmem-c').value,src=$('cmem-src').value;
if(src==='db'&&idx){const m=await dbGet('memories',idx);if(m){m.content=txt;await dbPut('memories',m);embedAndPatch('memories',idx,txt);}}
else if(idx===''){const date=new Date().toISOString().slice(0,10);const nid=uid();await dbPut('memories',{id:nid,chat_id:_curChatId,content:txt,date});embedAndPatch('memories',nid,txt);}
else{if(!_curChat.memories)_curChat.memories=[];_curChat.memories[parseInt(idx)]={content:txt,date:new Date().toISOString().slice(0,10)};saveChatStore();}
toast('å·²å„²å­˜');closeFP('fp-chat-mem-d');closeFP('fp-chat-mem');openChatMemory();}
async function delChatMem(){const idx=$('cmem-id').value,src=$('cmem-src').value;if(idx===''){closeFP('fp-chat-mem-d');return;}
if(src==='db')await dbDel('memories',idx);else{if(_curChat)_curChat.memories.splice(parseInt(idx),1);saveChatStore();}
toast('å·²åˆªé™¤');closeFP('fp-chat-mem-d');closeFP('fp-chat-mem');openChatMemory();}

// â•â•â• Persistent Commands â•â•â•
let _pcmds=[];
async function loadPcmds(){_pcmds=sortBy(await dbAll('persistent_commands'),'sort_order');}
function togglePcmdPanel(){const p=$('pcmd-panel');if(p.classList.contains('show')){closePcmdPanel();}else{renderPcmdList();p.classList.add('show');$('pcmd-overlay').classList.add('show');$('pcmd-plus-btn').classList.add('active');}}
function closePcmdPanel(){$('pcmd-panel').classList.remove('show');$('pcmd-overlay').classList.remove('show');$('pcmd-plus-btn').classList.remove('active');}
function renderPcmdList(){const el=$('pcmd-list');if(!_pcmds.length){el.innerHTML='<div style="color:var(--tx2);font-size:15px;padding:8px;">å°šæœªå»ºç«‹å¸¸é§æŒ‡ä»¤</div>';return;}
const t=(_curChat&&_curChat.pcmdToggles)||{};
el.innerHTML=_pcmds.map((p,i)=>{const isOn=t[p.id]!==undefined?t[p.id]!==false:p.enabled!==false;return '<div class="ev-toggle-item" data-pcid="'+p.id+'"><div style="flex:1;min-width:0;cursor:pointer;" onclick="editPcmd(\''+p.id+'\')"><div class="lt">'+esc(p.name||'æœªå‘½å')+'</div><div class="ls">'+esc((p.content||'').substring(0,80))+'</div></div><div class="tog'+(isOn?' on':'')+'" onclick="event.stopPropagation();togglePcmdEnabled('+i+',this)"></div></div>';}).join('');}
function togglePcmdEnabled(i,el){if(!_pcmds[i]||!_curChat)return;if(!_curChat.pcmdToggles)_curChat.pcmdToggles={};const pid=_pcmds[i].id;_curChat.pcmdToggles[pid]=!(_curChat.pcmdToggles[pid]!==false);el.classList.toggle('on');saveChatStore();}
function newPcmd(){closePcmdPanel();$('pcmd-id').value='';$('pcmd-name').value='';$('pcmd-content').value='';cntF($('pcmd-content'));openFP('fp-pcmd-d');}
function editPcmd(id){closePcmdPanel();const p=_pcmds.find(x=>x.id===id);if(!p)return;$('pcmd-id').value=id;$('pcmd-name').value=p.name||'';$('pcmd-content').value=p.content||'';cntF($('pcmd-content'));openFP('fp-pcmd-d');}
async function savePcmd(){const id=$('pcmd-id').value,name=$('pcmd-name').value.trim()||'æœªå‘½å',content=$('pcmd-content').value;
if(id){const p=await dbGet('persistent_commands',id)||{id};Object.assign(p,{name,content});await dbPut('persistent_commands',p);}
else await dbPut('persistent_commands',{id:uid(),name,content,enabled:true,sort_order:_pcmds.length});
await loadPcmds();renderPcmdList();toast('å·²å„²å­˜');closeFP('fp-pcmd-d');}
async function delPcmd(){const id=$('pcmd-id').value;if(!id)return;if(!await cfm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;await dbDel('persistent_commands',id);await loadPcmds();renderPcmdList();toast('å·²åˆªé™¤');closeFP('fp-pcmd-d');}
function getActivePcmds(){const t=(_curChat&&_curChat.pcmdToggles)||{};return _pcmds.filter(p=>{const v=t[p.id];return v!==false&&(v===true||p.enabled!==false);}).map(p=>p.content).join('\n');}

// â•â•â• Batch Delete â•â•â•
let _batchMode=false,_batchSel=new Set();
function toggleBatchDel(){_batchMode=!_batchMode;_batchSel.clear();$('batch-del-bar').classList.toggle('show',_batchMode);$('batch-del-count').textContent='å·²é¸ 0 å€‹';renderChatList();}
function openChatListMenu(){$('bs-body').innerHTML='<div class="bs-item" onclick="closeBs();openNewChatPicker()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>æ–°å°è©±</div><div class="bs-item" onclick="closeBs();toggleBatchDel()"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>åˆªé™¤è¦–çª—</div>';$('bs-ov').classList.add('show');}
function toggleBatchSel(id,ev){ev.stopPropagation();if(_batchSel.has(id))_batchSel.delete(id);else _batchSel.add(id);$('batch-del-count').textContent='å·²é¸ '+_batchSel.size+' å€‹';const dot=document.getElementById('bd-'+id);if(dot)dot.classList.toggle('sel',_batchSel.has(id));}
async function execBatchDel(){if(!_batchSel.size){toast('æœªé¸å–');return;}if(!await cfm('ç¢ºå®šåˆªé™¤ '+_batchSel.size+' å€‹å°è©±ï¼Ÿ'))return;
for(const id of _batchSel){const rows=await dbByIndex('messages','chat_id',id);for(const r of rows)await dbDel('messages',r.id);await dbDel('chats',id);delete _chatStore[id];if(_curChatId===id){_curChatId=null;_curChat=null;}}
toast('å·²åˆªé™¤');toggleBatchDel();}
</script>
</body></html>
